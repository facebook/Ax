<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Ax · Adaptive Experimentation Platform</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Adaptive Experimentation Platform"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Ax · Adaptive Experimentation Platform"/><meta property="og:type" content="website"/><meta property="og:url" content="https://ax.dev//versions/0.1.6/index.html"/><meta property="og:description" content="Adaptive Experimentation Platform"/><meta property="og:image" content="https://ax.dev//versions/0.1.6/img/ax.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://ax.dev//versions/0.1.6/img/ax.svg"/><link rel="shortcut icon" href="/versions/0.1.6/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-139570076-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script><script type="text/javascript" src="/versions/0.1.6/js/plotUtils.js"></script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/versions/0.1.6/js/mathjax.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/versions/0.1.6/js/scrollSpy.js"></script><link rel="stylesheet" href="/versions/0.1.6/css/main.css"/><script src="/versions/0.1.6/js/codetabs.js"></script></head><body><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/versions/0.1.6/"><img class="logo" src="/versions/0.1.6/img/ax_lockup_white.svg" alt="Ax"/><h2 class="headerTitleWithLogo">Ax</h2></a><a href="/versions/0.1.6/versions.html"><h3>0.1.6</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/versions/0.1.6/docs/why-ax.html" target="_self">Docs</a></li><li class=""><a href="/versions/0.1.6/tutorials/" target="_self">Tutorials</a></li><li class=""><a href="/versions/0.1.6/api/" target="_self">API</a></li><li class=""><a href="https://github.com/facebook/Ax" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div>
<script type="text/javascript" id="documentation_options" data-url_root="./"
src="/js/documentation_options.js">
</script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/doctools.js"></script>
<script type="text/javascript" src="/js/language_data.js"></script>
<script type="text/javascript" src="/js/searchtools.js"></script>
<div class="sphinx"><div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for sqlalchemy.sql.schema</h1><div class="highlight"><pre>
<span></span><span class="c1"># sql/schema.py</span>
<span class="c1"># Copyright (C) 2005-2019 the SQLAlchemy authors and contributors</span>
<span class="c1"># &lt;see AUTHORS file&gt;</span>
<span class="c1">#</span>
<span class="c1"># This module is part of SQLAlchemy and is released under</span>
<span class="c1"># the MIT License: http://www.opensource.org/licenses/mit-license.php</span>

<span class="sd">"""The schema module provides the building blocks for database metadata.</span>

<span class="sd">Each element within this module describes a database entity which can be</span>
<span class="sd">created and dropped, or is otherwise part of such an entity.  Examples include</span>
<span class="sd">tables, columns, sequences, and indexes.</span>

<span class="sd">All entities are subclasses of :class:`~sqlalchemy.schema.SchemaItem`, and as</span>
<span class="sd">defined in this module they are intended to be agnostic of any vendor-specific</span>
<span class="sd">constructs.</span>

<span class="sd">A collection of entities are grouped into a unit called</span>
<span class="sd">:class:`~sqlalchemy.schema.MetaData`. MetaData serves as a logical grouping of</span>
<span class="sd">schema elements, and can also be associated with an actual database connection</span>
<span class="sd">such that operations involving the contained elements can contact the database</span>
<span class="sd">as needed.</span>

<span class="sd">Two of the elements here also build upon their "syntactic" counterparts, which</span>
<span class="sd">are defined in :class:`~sqlalchemy.sql.expression.`, specifically</span>
<span class="sd">:class:`~sqlalchemy.schema.Table` and :class:`~sqlalchemy.schema.Column`.</span>
<span class="sd">Since these objects are part of the SQL expression language, they are usable</span>
<span class="sd">as components in SQL expressions.</span>

<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ddl</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">type_api</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">visitors</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">_bind_or_error</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">ColumnCollection</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">DialectKWArgs</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">SchemaEventTarget</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">_as_truncated</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">_document_text_coercion</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">_literal_as_text</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">ClauseElement</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">ColumnClause</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">ColumnElement</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">quoted_name</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="k">import</span> <span class="n">TextClause</span>
<span class="kn">from</span> <span class="nn">.selectable</span> <span class="k">import</span> <span class="n">TableClause</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">exc</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">inspection</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">util</span>


<span class="n">RETAIN_SCHEMA</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s2">"retain_schema"</span><span class="p">)</span>

<span class="n">BLANK_SCHEMA</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span>
    <span class="s2">"blank_schema"</span><span class="p">,</span>
    <span class="sd">"""Symbol indicating that a :class:`.Table` or :class:`.Sequence`</span>
<span class="sd">    should have 'None' for its schema, even if the parent</span>
<span class="sd">    :class:`.MetaData` has specified a schema.</span>

<span class="sd">    .. versionadded:: 1.0.14</span>

<span class="sd">    """</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">schema</span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="n">name</span>


<span class="c1"># this should really be in sql/util.py but we'd have to</span>
<span class="c1"># break an import cycle</span>
<span class="k">def</span> <span class="nf">_copy_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">target_table</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Column</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="n">source_table</span>
            <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">source_table</span><span class="o">.</span><span class="n">c</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">target_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="p">{},</span> <span class="n">replace</span><span class="p">)</span>


<span class="nd">@inspection</span><span class="o">.</span><span class="n">_self_inspects</span>
<span class="k">class</span> <span class="nc">SchemaItem</span><span class="p">(</span><span class="n">SchemaEventTarget</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">Visitable</span><span class="p">):</span>
    <span class="sd">"""Base class for items that define a database schema."""</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"schema_item"</span>

    <span class="k">def</span> <span class="nf">_init_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">"""Initialize the list of child items for this SchemaItem."""</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""used to allow SchemaVisitor access"""</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">generic_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omit_kwarg</span><span class="o">=</span><span class="p">[</span><span class="s2">"info"</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
        <span class="s2">"0.9"</span><span class="p">,</span>
        <span class="s2">"The :attr:`.SchemaItem.quote` attribute is deprecated and will be "</span>
        <span class="s2">"removed in a future release.  Use the :attr:`.quoted_name.quote` "</span>
        <span class="s2">"attribute on the ``name`` field of the target schema item to retrieve"</span>
        <span class="s2">"quoted status."</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">quote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the value of the ``quote`` flag passed</span>
<span class="sd">        to this schema object, for those schema items which</span>
<span class="sd">        have a ``name`` field.</span>

<span class="sd">        """</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">quote</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Info dictionary associated with the object, allowing user-defined</span>
<span class="sd">        data to be associated with this :class:`.SchemaItem`.</span>

<span class="sd">        The dictionary is automatically generated when first accessed.</span>
<span class="sd">        It can also be specified in the constructor of some objects,</span>
<span class="sd">        such as :class:`.Table` and :class:`.Column`.</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_schema_item_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_item</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">"info"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">schema_item</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">schema_item</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">schema_item</span>

    <span class="k">def</span> <span class="nf">_translate_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">effective_schema</span><span class="p">,</span> <span class="n">map_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">effective_schema</span><span class="p">,</span> <span class="n">effective_schema</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Table</span><span class="p">(</span><span class="n">DialectKWArgs</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">,</span> <span class="n">TableClause</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""Represent a table in a database.</span>

<span class="sd">    e.g.::</span>

<span class="sd">        mytable = Table("mytable", metadata,</span>
<span class="sd">                        Column('mytable_id', Integer, primary_key=True),</span>
<span class="sd">                        Column('value', String(50))</span>
<span class="sd">                   )</span>

<span class="sd">    The :class:`.Table` object constructs a unique instance of itself based</span>
<span class="sd">    on its name and optional schema name within the given</span>
<span class="sd">    :class:`.MetaData` object. Calling the :class:`.Table`</span>
<span class="sd">    constructor with the same name and same :class:`.MetaData` argument</span>
<span class="sd">    a second time will return the *same* :class:`.Table` object - in this way</span>
<span class="sd">    the :class:`.Table` constructor acts as a registry function.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`metadata_describing` - Introduction to database metadata</span>

<span class="sd">    Constructor arguments are as follows:</span>

<span class="sd">    :param name: The name of this table as represented in the database.</span>

<span class="sd">        The table name, along with the value of the ``schema`` parameter,</span>
<span class="sd">        forms a key which uniquely identifies this :class:`.Table` within</span>
<span class="sd">        the owning :class:`.MetaData` collection.</span>
<span class="sd">        Additional calls to :class:`.Table` with the same name, metadata,</span>
<span class="sd">        and schema name will return the same :class:`.Table` object.</span>

<span class="sd">        Names which contain no upper case characters</span>
<span class="sd">        will be treated as case insensitive names, and will not be quoted</span>
<span class="sd">        unless they are a reserved word or contain special characters.</span>
<span class="sd">        A name with any number of upper case characters is considered</span>
<span class="sd">        to be case sensitive, and will be sent as quoted.</span>

<span class="sd">        To enable unconditional quoting for the table name, specify the flag</span>
<span class="sd">        ``quote=True`` to the constructor, or use the :class:`.quoted_name`</span>
<span class="sd">        construct to specify the name.</span>

<span class="sd">    :param metadata: a :class:`.MetaData` object which will contain this</span>
<span class="sd">        table.  The metadata is used as a point of association of this table</span>
<span class="sd">        with other tables which are referenced via foreign key.  It also</span>
<span class="sd">        may be used to associate this table with a particular</span>
<span class="sd">        :class:`.Connectable`.</span>

<span class="sd">    :param \*args: Additional positional arguments are used primarily</span>
<span class="sd">        to add the list of :class:`.Column` objects contained within this</span>
<span class="sd">        table. Similar to the style of a CREATE TABLE statement, other</span>
<span class="sd">        :class:`.SchemaItem` constructs may be added here, including</span>
<span class="sd">        :class:`.PrimaryKeyConstraint`, and :class:`.ForeignKeyConstraint`.</span>

<span class="sd">    :param autoload: Defaults to False, unless :paramref:`.Table.autoload_with`</span>
<span class="sd">        is set in which case it defaults to True; :class:`.Column` objects</span>
<span class="sd">        for this table should be reflected from the database, possibly</span>
<span class="sd">        augmenting or replacing existing :class:`.Column` objects that were</span>
<span class="sd">        explicitly specified.</span>

<span class="sd">        .. versionchanged:: 1.0.0 setting the :paramref:`.Table.autoload_with`</span>
<span class="sd">           parameter implies that :paramref:`.Table.autoload` will default</span>
<span class="sd">           to True.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :ref:`metadata_reflection_toplevel`</span>

<span class="sd">    :param autoload_replace: Defaults to ``True``; when using</span>
<span class="sd">        :paramref:`.Table.autoload`</span>
<span class="sd">        in conjunction with :paramref:`.Table.extend_existing`, indicates</span>
<span class="sd">        that :class:`.Column` objects present in the already-existing</span>
<span class="sd">        :class:`.Table` object should be replaced with columns of the same</span>
<span class="sd">        name retrieved from the autoload process.   When ``False``, columns</span>
<span class="sd">        already present under existing names will be omitted from the</span>
<span class="sd">        reflection process.</span>

<span class="sd">        Note that this setting does not impact :class:`.Column` objects</span>
<span class="sd">        specified programmatically within the call to :class:`.Table` that</span>
<span class="sd">        also is autoloading; those :class:`.Column` objects will always</span>
<span class="sd">        replace existing columns of the same name when</span>
<span class="sd">        :paramref:`.Table.extend_existing` is ``True``.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :paramref:`.Table.autoload`</span>

<span class="sd">            :paramref:`.Table.extend_existing`</span>

<span class="sd">    :param autoload_with: An :class:`.Engine` or :class:`.Connection` object</span>
<span class="sd">        with which this :class:`.Table` object will be reflected; when</span>
<span class="sd">        set to a non-None value, it implies that :paramref:`.Table.autoload`</span>
<span class="sd">        is ``True``.   If left unset, but :paramref:`.Table.autoload` is</span>
<span class="sd">        explicitly set to ``True``, an autoload operation will attempt to</span>
<span class="sd">        proceed by locating an :class:`.Engine` or :class:`.Connection` bound</span>
<span class="sd">        to the underlying :class:`.MetaData` object.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :paramref:`.Table.autoload`</span>

<span class="sd">    :param extend_existing: When ``True``, indicates that if this</span>
<span class="sd">        :class:`.Table` is already present in the given :class:`.MetaData`,</span>
<span class="sd">        apply further arguments within the constructor to the existing</span>
<span class="sd">        :class:`.Table`.</span>

<span class="sd">        If :paramref:`.Table.extend_existing` or</span>
<span class="sd">        :paramref:`.Table.keep_existing` are not set, and the given name</span>
<span class="sd">        of the new :class:`.Table` refers to a :class:`.Table` that is</span>
<span class="sd">        already present in the target :class:`.MetaData` collection, and</span>
<span class="sd">        this :class:`.Table` specifies additional columns or other constructs</span>
<span class="sd">        or flags that modify the table's state, an</span>
<span class="sd">        error is raised.  The purpose of these two mutually-exclusive flags</span>
<span class="sd">        is to specify what action should be taken when a :class:`.Table`</span>
<span class="sd">        is specified that matches an existing :class:`.Table`, yet specifies</span>
<span class="sd">        additional constructs.</span>

<span class="sd">        :paramref:`.Table.extend_existing` will also work in conjunction</span>
<span class="sd">        with :paramref:`.Table.autoload` to run a new reflection</span>
<span class="sd">        operation against the database, even if a :class:`.Table`</span>
<span class="sd">        of the same name is already present in the target</span>
<span class="sd">        :class:`.MetaData`; newly reflected :class:`.Column` objects</span>
<span class="sd">        and other options will be added into the state of the</span>
<span class="sd">        :class:`.Table`, potentially overwriting existing columns</span>
<span class="sd">        and options of the same name.</span>

<span class="sd">        As is always the case with :paramref:`.Table.autoload`,</span>
<span class="sd">        :class:`.Column` objects can be specified in the same :class:`.Table`</span>
<span class="sd">        constructor, which will take precedence.  Below, the existing</span>
<span class="sd">        table ``mytable`` will be augmented with :class:`.Column` objects</span>
<span class="sd">        both reflected from the database, as well as the given :class:`.Column`</span>
<span class="sd">        named "y"::</span>

<span class="sd">            Table("mytable", metadata,</span>
<span class="sd">                        Column('y', Integer),</span>
<span class="sd">                        extend_existing=True,</span>
<span class="sd">                        autoload=True,</span>
<span class="sd">                        autoload_with=engine</span>
<span class="sd">                    )</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :paramref:`.Table.autoload`</span>

<span class="sd">            :paramref:`.Table.autoload_replace`</span>

<span class="sd">            :paramref:`.Table.keep_existing`</span>


<span class="sd">    :param implicit_returning: True by default - indicates that</span>
<span class="sd">        RETURNING can be used by default to fetch newly inserted primary key</span>
<span class="sd">        values, for backends which support this.  Note that</span>
<span class="sd">        create_engine() also provides an implicit_returning flag.</span>

<span class="sd">    :param include_columns: A list of strings indicating a subset of</span>
<span class="sd">        columns to be loaded via the ``autoload`` operation; table columns who</span>
<span class="sd">        aren't present in this list will not be represented on the resulting</span>
<span class="sd">        ``Table`` object. Defaults to ``None`` which indicates all columns</span>
<span class="sd">        should be reflected.</span>

<span class="sd">    :param resolve_fks: Whether or not to reflect :class:`.Table` objects</span>
<span class="sd">        related to this one via :class:`.ForeignKey` objects, when</span>
<span class="sd">        :paramref:`.Table.autoload` or :paramref:`.Table.autoload_with` is</span>
<span class="sd">        specified.   Defaults to True.  Set to False to disable reflection of</span>
<span class="sd">        related tables as :class:`.ForeignKey` objects are encountered; may be</span>
<span class="sd">        used either to save on SQL calls or to avoid issues with related tables</span>
<span class="sd">        that can't be accessed. Note that if a related table is already present</span>
<span class="sd">        in the :class:`.MetaData` collection, or becomes present later, a</span>
<span class="sd">        :class:`.ForeignKey` object associated with this :class:`.Table` will</span>
<span class="sd">        resolve to that table normally.</span>

<span class="sd">        .. versionadded:: 1.3</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :paramref:`.MetaData.reflect.resolve_fks`</span>


<span class="sd">    :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">        :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">    :param keep_existing: When ``True``, indicates that if this Table</span>
<span class="sd">        is already present in the given :class:`.MetaData`, ignore</span>
<span class="sd">        further arguments within the constructor to the existing</span>
<span class="sd">        :class:`.Table`, and return the :class:`.Table` object as</span>
<span class="sd">        originally created. This is to allow a function that wishes</span>
<span class="sd">        to define a new :class:`.Table` on first call, but on</span>
<span class="sd">        subsequent calls will return the same :class:`.Table`,</span>
<span class="sd">        without any of the declarations (particularly constraints)</span>
<span class="sd">        being applied a second time.</span>

<span class="sd">        If :paramref:`.Table.extend_existing` or</span>
<span class="sd">        :paramref:`.Table.keep_existing` are not set, and the given name</span>
<span class="sd">        of the new :class:`.Table` refers to a :class:`.Table` that is</span>
<span class="sd">        already present in the target :class:`.MetaData` collection, and</span>
<span class="sd">        this :class:`.Table` specifies additional columns or other constructs</span>
<span class="sd">        or flags that modify the table's state, an</span>
<span class="sd">        error is raised.  The purpose of these two mutually-exclusive flags</span>
<span class="sd">        is to specify what action should be taken when a :class:`.Table`</span>
<span class="sd">        is specified that matches an existing :class:`.Table`, yet specifies</span>
<span class="sd">        additional constructs.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :paramref:`.Table.extend_existing`</span>

<span class="sd">    :param listeners: A list of tuples of the form ``(&lt;eventname&gt;, &lt;fn&gt;)``</span>
<span class="sd">        which will be passed to :func:`.event.listen` upon construction.</span>
<span class="sd">        This alternate hook to :func:`.event.listen` allows the establishment</span>
<span class="sd">        of a listener function specific to this :class:`.Table` before</span>
<span class="sd">        the "autoload" process begins.  Particularly useful for</span>
<span class="sd">        the :meth:`.DDLEvents.column_reflect` event::</span>

<span class="sd">            def listen_for_reflect(table, column_info):</span>
<span class="sd">                "handle the column reflection event"</span>
<span class="sd">                # ...</span>

<span class="sd">            t = Table(</span>
<span class="sd">                'sometable',</span>
<span class="sd">                autoload=True,</span>
<span class="sd">                listeners=[</span>
<span class="sd">                    ('column_reflect', listen_for_reflect)</span>
<span class="sd">                ])</span>

<span class="sd">    :param mustexist: When ``True``, indicates that this Table must already</span>
<span class="sd">        be present in the given :class:`.MetaData` collection, else</span>
<span class="sd">        an exception is raised.</span>

<span class="sd">    :param prefixes:</span>
<span class="sd">        A list of strings to insert after CREATE in the CREATE TABLE</span>
<span class="sd">        statement.  They will be separated by spaces.</span>

<span class="sd">    :param quote: Force quoting of this table's name on or off, corresponding</span>
<span class="sd">        to ``True`` or ``False``.  When left at its default of ``None``,</span>
<span class="sd">        the column identifier will be quoted according to whether the name is</span>
<span class="sd">        case sensitive (identifiers with at least one upper case character are</span>
<span class="sd">        treated as case sensitive), or if it's a reserved word.  This flag</span>
<span class="sd">        is only needed to force quoting of a reserved word which is not known</span>
<span class="sd">        by the SQLAlchemy dialect.</span>

<span class="sd">    :param quote_schema: same as 'quote' but applies to the schema identifier.</span>

<span class="sd">    :param schema: The schema name for this table, which is required if</span>
<span class="sd">        the table resides in a schema other than the default selected schema</span>
<span class="sd">        for the engine's database connection.  Defaults to ``None``.</span>

<span class="sd">        If the owning :class:`.MetaData` of this :class:`.Table` specifies its</span>
<span class="sd">        own :paramref:`.MetaData.schema` parameter, then that schema name will</span>
<span class="sd">        be applied to this :class:`.Table` if the schema parameter here is set</span>
<span class="sd">        to ``None``.  To set a blank schema name on a :class:`.Table` that</span>
<span class="sd">        would otherwise use the schema set on the owning :class:`.MetaData`,</span>
<span class="sd">        specify the special symbol :attr:`.BLANK_SCHEMA`.</span>

<span class="sd">        .. versionadded:: 1.0.14  Added the :attr:`.BLANK_SCHEMA` symbol to</span>
<span class="sd">           allow a :class:`.Table` to have a blank schema name even when the</span>
<span class="sd">           parent :class:`.MetaData` specifies :paramref:`.MetaData.schema`.</span>

<span class="sd">        The quoting rules for the schema name are the same as those for the</span>
<span class="sd">        ``name`` parameter, in that quoting is applied for reserved words or</span>
<span class="sd">        case-sensitive names; to enable unconditional quoting for the schema</span>
<span class="sd">        name, specify the flag ``quote_schema=True`` to the constructor, or use</span>
<span class="sd">        the :class:`.quoted_name` construct to specify the name.</span>

<span class="sd">    :param useexisting: the same as :paramref:`.Table.extend_existing`.</span>

<span class="sd">    :param comment: Optional string that will render an SQL comment on table</span>
<span class="sd">         creation.</span>

<span class="sd">         .. versionadded:: 1.2 Added the :paramref:`.Table.comment` parameter</span>
<span class="sd">            to :class:`.Table`.</span>

<span class="sd">    :param \**kw: Additional keyword arguments not mentioned above are</span>
<span class="sd">        dialect specific, and passed in the form ``&lt;dialectname&gt;_&lt;argname&gt;``.</span>
<span class="sd">        See the documentation regarding an individual dialect at</span>
<span class="sd">        :ref:`dialect_toplevel` for detail on documented arguments.</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"table"</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated_params</span><span class="p">(</span>
        <span class="n">useexisting</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">"0.7"</span><span class="p">,</span>
            <span class="s2">"The :paramref:`.Table.useexisting` parameter is deprecated and "</span>
            <span class="s2">"will be removed in a future release.  Please use "</span>
            <span class="s2">":paramref:`.Table.extend_existing`."</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># python3k pickle seems to call this</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Table() takes at least two arguments"</span><span class="p">)</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"schema"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">elif</span> <span class="n">schema</span> <span class="ow">is</span> <span class="n">BLANK_SCHEMA</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">keep_existing</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"keep_existing"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">extend_existing</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"extend_existing"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"useexisting"</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extend_existing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">"useexisting is synonymous with extend_existing."</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">extend_existing</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"useexisting"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keep_existing</span> <span class="ow">and</span> <span class="n">extend_existing</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"keep_existing and extend_existing are mutually exclusive."</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mustexist</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"mustexist"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_existing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">extend_existing</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s2">"Table '</span><span class="si">%s</span><span class="s2">' is already defined for this MetaData "</span>
                    <span class="s2">"instance.  Specify 'extend_existing=True' "</span>
                    <span class="s2">"to redefine "</span>
                    <span class="s2">"options and columns on an "</span>
                    <span class="s2">"existing Table object."</span> <span class="o">%</span> <span class="n">key</span>
                <span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">extend_existing</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">_init_existing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mustexist</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">"Table '</span><span class="si">%s</span><span class="s2">' not defined"</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">table</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_parent_attach</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">_add_table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_parent_attach</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">table</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">safe_reraise</span><span class="p">():</span>
                    <span class="n">metadata</span><span class="o">.</span><span class="n">_remove_table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
        <span class="s2">"0.9"</span><span class="p">,</span>
        <span class="s2">"The :meth:`.SchemaItem.quote` method is deprecated and will be "</span>
        <span class="s2">"removed in a future release.  Use the :attr:`.quoted_name.quote` "</span>
        <span class="s2">"attribute on the ``schema`` field of the target schema item to "</span>
        <span class="s2">"retrieve quoted status."</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">quote_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the value of the ``quote_schema`` flag passed</span>
<span class="sd">        to this :class:`.Table`.</span>
<span class="sd">        """</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">quote</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">"""Constructor for :class:`~.schema.Table`.</span>

<span class="sd">        This method is a no-op.   See the top-level</span>
<span class="sd">        documentation for :class:`~.schema.Table`</span>
<span class="sd">        for constructor arguments.</span>

<span class="sd">        """</span>
        <span class="c1"># __init__ is overridden to prevent __new__ from</span>
        <span class="c1"># calling the superclass constructor.</span>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Table</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">quoted_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"quote"</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"schema"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="n">BLANK_SCHEMA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quote_schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"quote_schema"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">quoted_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">quote_schema</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">ColumnCollection</span><span class="p">()</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">(</span>
            <span class="n">_implicit_generated</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">autoload_with</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"autoload_with"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">autoload</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"autoload"</span><span class="p">,</span> <span class="n">autoload_with</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># this argument is only used with _init_existing()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"autoload_replace"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">_extend_on</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_extend_on"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">resolve_fks</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"resolve_fks"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">include_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"include_columns"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">implicit_returning</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"implicit_returning"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"comment"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">"info"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"info"</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"listeners"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">listeners</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"listeners"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">evt</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">listeners</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prefixes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"prefixes"</span><span class="p">,</span> <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># load column definitions from the database if 'autoload' is defined</span>
        <span class="c1"># we do it after the table is in the singleton dictionary to support</span>
        <span class="c1"># circular foreign keys</span>
        <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoload</span><span class="p">(</span>
                <span class="n">metadata</span><span class="p">,</span>
                <span class="n">autoload_with</span><span class="p">,</span>
                <span class="n">include_columns</span><span class="p">,</span>
                <span class="n">_extend_on</span><span class="o">=</span><span class="n">_extend_on</span><span class="p">,</span>
                <span class="n">resolve_fks</span><span class="o">=</span><span class="n">resolve_fks</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># initialize all the column, etc. objects.  done after reflection to</span>
        <span class="c1"># allow user-overrides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_items</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_autoload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">,</span>
        <span class="n">autoload_with</span><span class="p">,</span>
        <span class="n">include_columns</span><span class="p">,</span>
        <span class="n">exclude_columns</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">resolve_fks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_extend_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="n">autoload_with</span><span class="p">:</span>
            <span class="n">autoload_with</span><span class="o">.</span><span class="n">run_callable</span><span class="p">(</span>
                <span class="n">autoload_with</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">reflecttable</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">include_columns</span><span class="p">,</span>
                <span class="n">exclude_columns</span><span class="p">,</span>
                <span class="n">resolve_fks</span><span class="p">,</span>
                <span class="n">_extend_on</span><span class="o">=</span><span class="n">_extend_on</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span>
                <span class="n">metadata</span><span class="p">,</span>
                <span class="n">msg</span><span class="o">=</span><span class="s2">"No engine is bound to this Table's MetaData. "</span>
                <span class="s2">"Pass an engine to the Table via "</span>
                <span class="s2">"autoload_with=&lt;someengine&gt;, "</span>
                <span class="s2">"or associate the MetaData with an engine via "</span>
                <span class="s2">"metadata.bind=&lt;someengine&gt;"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">bind</span><span class="o">.</span><span class="n">run_callable</span><span class="p">(</span>
                <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">reflecttable</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">include_columns</span><span class="p">,</span>
                <span class="n">exclude_columns</span><span class="p">,</span>
                <span class="n">resolve_fks</span><span class="p">,</span>
                <span class="n">_extend_on</span><span class="o">=</span><span class="n">_extend_on</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_sorted_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the set of constraints as a list, sorted by creation</span>
<span class="sd">        order.</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">_creation_order</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">foreign_key_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">""":class:`.ForeignKeyConstraint` objects referred to by this</span>
<span class="sd">        :class:`.Table`.</span>

<span class="sd">        This list is produced from the collection of :class:`.ForeignKey`</span>
<span class="sd">        objects currently associated.</span>

<span class="sd">        .. versionadded:: 1.0.0</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">fkc</span><span class="o">.</span><span class="n">constraint</span> <span class="k">for</span> <span class="n">fkc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">autoload_with</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"autoload_with"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">autoload</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"autoload"</span><span class="p">,</span> <span class="n">autoload_with</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">autoload_replace</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"autoload_replace"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"schema"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">_extend_on</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_extend_on"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">schema</span> <span class="ow">and</span> <span class="n">schema</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Can't change schema of existing table from '</span><span class="si">%s</span><span class="s2">' to '</span><span class="si">%s</span><span class="s2">'"</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">schema</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">include_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"include_columns"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">resolve_fks</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"resolve_fks"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include_columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"quote"</span><span class="p">,</span> <span class="s2">"quote_schema"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"Can't redefine 'quote' or 'quote_schema' arguments"</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="s2">"comment"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"comment"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">"info"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"info"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">autoload_replace</span><span class="p">:</span>
                <span class="c1"># don't replace columns already present.</span>
                <span class="c1"># we'd like to do this for constraints also however we don't</span>
                <span class="c1"># have simple de-duping for unnamed constraints.</span>
                <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoload</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">autoload_with</span><span class="p">,</span>
                <span class="n">include_columns</span><span class="p">,</span>
                <span class="n">exclude_columns</span><span class="p">,</span>
                <span class="n">resolve_fks</span><span class="p">,</span>
                <span class="n">_extend_on</span><span class="o">=</span><span class="n">_extend_on</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_items</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extra_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dialect_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_collections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_reset_exported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_autoincrement_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">_autoincrement_column</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the 'key' for this :class:`.Table`.</span>

<span class="sd">        This value is used as the dictionary key within the</span>
<span class="sd">        :attr:`.MetaData.tables` collection.   It is typically the same</span>
<span class="sd">        as that of :attr:`.Table.name` for a table with no</span>
<span class="sd">        :attr:`.Table.schema` set; otherwise it is typically of the form</span>
<span class="sd">        ``schemaname.tablename``.</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"Table(</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
            <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)]</span>
            <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span><span class="s2">"</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"schema"</span><span class="p">]]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the connectable associated with this Table."""</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_is_dependent_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">"""Add a 'dependency' for this Table.</span>

<span class="sd">        This is another Table object which must be created</span>
<span class="sd">        first before this one can, or dropped after this one.</span>

<span class="sd">        Usually, dependencies between tables are determined via</span>
<span class="sd">        ForeignKey objects.   However, for other situations that</span>
<span class="sd">        create dependencies outside of foreign keys (rules, inheriting),</span>
<span class="sd">        this method can manually establish such a link.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">"""Append a :class:`~.schema.Column` to this :class:`~.schema.Table`.</span>

<span class="sd">        The "key" of the newly added :class:`~.schema.Column`, i.e. the</span>
<span class="sd">        value of its ``.key`` attribute, will then be available</span>
<span class="sd">        in the ``.c`` collection of this :class:`~.schema.Table`, and the</span>
<span class="sd">        column definition will be included in any CREATE TABLE, SELECT,</span>
<span class="sd">        UPDATE, etc. statements generated from this :class:`~.schema.Table`</span>
<span class="sd">        construct.</span>

<span class="sd">        Note that this does **not** change the definition of the table</span>
<span class="sd">        as it exists within any underlying database, assuming that</span>
<span class="sd">        table has already been created in the database.   Relational</span>
<span class="sd">        databases support the addition of columns to existing tables</span>
<span class="sd">        using the SQL ALTER command, which would need to be</span>
<span class="sd">        emitted for an already-existing table that doesn't contain</span>
<span class="sd">        the newly added column.</span>

<span class="sd">        """</span>

        <span class="n">column</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
        <span class="sd">"""Append a :class:`~.schema.Constraint` to this</span>
<span class="sd">        :class:`~.schema.Table`.</span>

<span class="sd">        This has the effect of the constraint being included in any</span>
<span class="sd">        future CREATE TABLE statement, assuming specific DDL creation</span>
<span class="sd">        events have not been associated with the given</span>
<span class="sd">        :class:`~.schema.Constraint` object.</span>

<span class="sd">        Note that this does **not** produce the constraint within the</span>
<span class="sd">        relational database automatically, for a table that already exists</span>
<span class="sd">        in the database.   To add a constraint to an</span>
<span class="sd">        existing relational database table, the SQL ALTER command must</span>
<span class="sd">        be used.  SQLAlchemy also provides the</span>
<span class="sd">        :class:`.AddConstraint` construct which can produce this SQL when</span>
<span class="sd">        invoked as an executable clause.</span>

<span class="sd">        """</span>

        <span class="n">constraint</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
        <span class="s2">"0.7"</span><span class="p">,</span>
        <span class="s2">"the :meth:`.Table.append_ddl_listener` method is deprecated and "</span>
        <span class="s2">"will be removed in a future release.  Please refer to "</span>
        <span class="s2">":class:`.DDLEvents`."</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">append_ddl_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
        <span class="sd">"""Append a DDL event listener to this ``Table``.</span>

<span class="sd">        """</span>

        <span class="k">def</span> <span class="nf">adapt_listener</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">listener</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>

        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">""</span> <span class="o">+</span> <span class="n">event_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"-"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">),</span> <span class="n">adapt_listener</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">_add_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">column_collections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema_visitor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">schema_visitor</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TableClause</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">column_collections</span><span class="o">=</span><span class="n">column_collections</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column_collections</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Return True if this table exists."""</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bind</span><span class="o">.</span><span class="n">run_callable</span><span class="p">(</span>
            <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">has_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""Issue a ``CREATE`` statement for this</span>
<span class="sd">        :class:`.Table`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`.MetaData.create_all`.</span>

<span class="sd">        """</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""Issue a ``DROP`` statement for this</span>
<span class="sd">        :class:`.Table`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`.MetaData.drop_all`.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tometadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">RETAIN_SCHEMA</span><span class="p">,</span>
        <span class="n">referred_schema_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">"""Return a copy of this :class:`.Table` associated with a different</span>
<span class="sd">        :class:`.MetaData`.</span>

<span class="sd">        E.g.::</span>

<span class="sd">            m1 = MetaData()</span>

<span class="sd">            user = Table('user', m1, Column('id', Integer, primary_key=True))</span>

<span class="sd">            m2 = MetaData()</span>
<span class="sd">            user_copy = user.tometadata(m2)</span>

<span class="sd">        :param metadata: Target :class:`.MetaData` object, into which the</span>
<span class="sd">         new :class:`.Table` object will be created.</span>

<span class="sd">        :param schema: optional string name indicating the target schema.</span>
<span class="sd">         Defaults to the special symbol :attr:`.RETAIN_SCHEMA` which indicates</span>
<span class="sd">         that no change to the schema name should be made in the new</span>
<span class="sd">         :class:`.Table`.  If set to a string name, the new :class:`.Table`</span>
<span class="sd">         will have this new name as the ``.schema``.  If set to ``None``, the</span>
<span class="sd">         schema will be set to that of the schema set on the target</span>
<span class="sd">         :class:`.MetaData`, which is typically ``None`` as well, unless</span>
<span class="sd">         set explicitly::</span>

<span class="sd">            m2 = MetaData(schema='newschema')</span>

<span class="sd">            # user_copy_one will have "newschema" as the schema name</span>
<span class="sd">            user_copy_one = user.tometadata(m2, schema=None)</span>

<span class="sd">            m3 = MetaData()  # schema defaults to None</span>

<span class="sd">            # user_copy_two will have None as the schema name</span>
<span class="sd">            user_copy_two = user.tometadata(m3, schema=None)</span>

<span class="sd">        :param referred_schema_fn: optional callable which can be supplied</span>
<span class="sd">         in order to provide for the schema name that should be assigned</span>
<span class="sd">         to the referenced table of a :class:`.ForeignKeyConstraint`.</span>
<span class="sd">         The callable accepts this parent :class:`.Table`, the</span>
<span class="sd">         target schema that we are changing to, the</span>
<span class="sd">         :class:`.ForeignKeyConstraint` object, and the existing</span>
<span class="sd">         "target schema" of that constraint.  The function should return the</span>
<span class="sd">         string schema name that should be applied.</span>
<span class="sd">         E.g.::</span>

<span class="sd">                def referred_schema_fn(table, to_schema,</span>
<span class="sd">                                                constraint, referred_schema):</span>
<span class="sd">                    if referred_schema == 'base_tables':</span>
<span class="sd">                        return referred_schema</span>
<span class="sd">                    else:</span>
<span class="sd">                        return to_schema</span>

<span class="sd">                new_table = table.tometadata(m2, schema="alt_schema",</span>
<span class="sd">                                        referred_schema_fn=referred_schema_fn)</span>

<span class="sd">         .. versionadded:: 0.9.2</span>

<span class="sd">        :param name: optional string name indicating the target table name.</span>
<span class="sd">         If not specified or None, the table name is retained.  This allows</span>
<span class="sd">         a :class:`.Table` to be copied to the same :class:`.MetaData` target</span>
<span class="sd">         with a new name.</span>

<span class="sd">         .. versionadded:: 1.0.0</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="n">RETAIN_SCHEMA</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">elif</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">"Table '</span><span class="si">%s</span><span class="s2">' already exists within the given "</span>
                <span class="s2">"MetaData - not copying."</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">))</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ForeignKeyConstraint</span><span class="p">):</span>
                <span class="n">referred_schema</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_referred_schema</span>
                <span class="k">if</span> <span class="n">referred_schema_fn</span><span class="p">:</span>
                    <span class="n">fk_constraint_schema</span> <span class="o">=</span> <span class="n">referred_schema_fn</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">referred_schema</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fk_constraint_schema</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">schema</span> <span class="k">if</span> <span class="n">referred_schema</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append_constraint</span><span class="p">(</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">fk_constraint_schema</span><span class="p">,</span> <span class="n">target_table</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">_type_bound</span><span class="p">:</span>
                <span class="c1"># skip unique constraints that would be generated</span>
                <span class="c1"># by the 'unique' flag on Column</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">_column_flag</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">table</span><span class="o">.</span><span class="n">append_constraint</span><span class="p">(</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">target_table</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
            <span class="c1"># skip indexes that would be generated</span>
            <span class="c1"># by the 'index' flag on Column</span>
            <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">_column_flag</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">Index</span><span class="p">(</span>
                <span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">unique</span><span class="o">=</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">_copy_expression</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">expressions</span>
                <span class="p">],</span>
                <span class="n">_table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                <span class="o">**</span><span class="n">index</span><span class="o">.</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_item_copy</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Column</span><span class="p">(</span><span class="n">DialectKWArgs</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">,</span> <span class="n">ColumnClause</span><span class="p">):</span>
    <span class="sd">"""Represents a column in a database table."""</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"column"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""</span>
<span class="sd">        Construct a new ``Column`` object.</span>

<span class="sd">        :param name: The name of this column as represented in the database.</span>
<span class="sd">          This argument may be the first positional argument, or specified</span>
<span class="sd">          via keyword.</span>

<span class="sd">          Names which contain no upper case characters</span>
<span class="sd">          will be treated as case insensitive names, and will not be quoted</span>
<span class="sd">          unless they are a reserved word.  Names with any number of upper</span>
<span class="sd">          case characters will be quoted and sent exactly.  Note that this</span>
<span class="sd">          behavior applies even for databases which standardize upper</span>
<span class="sd">          case names as case insensitive such as Oracle.</span>

<span class="sd">          The name field may be omitted at construction time and applied</span>
<span class="sd">          later, at any time before the Column is associated with a</span>
<span class="sd">          :class:`.Table`.  This is to support convenient</span>
<span class="sd">          usage within the :mod:`~sqlalchemy.ext.declarative` extension.</span>

<span class="sd">        :param type\_: The column's type, indicated using an instance which</span>
<span class="sd">          subclasses :class:`~sqlalchemy.types.TypeEngine`.  If no arguments</span>
<span class="sd">          are required for the type, the class of the type can be sent</span>
<span class="sd">          as well, e.g.::</span>

<span class="sd">            # use a type with arguments</span>
<span class="sd">            Column('data', String(50))</span>

<span class="sd">            # use no arguments</span>
<span class="sd">            Column('level', Integer)</span>

<span class="sd">          The ``type`` argument may be the second positional argument</span>
<span class="sd">          or specified by keyword.</span>

<span class="sd">          If the ``type`` is ``None`` or is omitted, it will first default to</span>
<span class="sd">          the special type :class:`.NullType`.  If and when this</span>
<span class="sd">          :class:`.Column` is made to refer to another column using</span>
<span class="sd">          :class:`.ForeignKey` and/or :class:`.ForeignKeyConstraint`, the type</span>
<span class="sd">          of the remote-referenced column will be copied to this column as</span>
<span class="sd">          well, at the moment that the foreign key is resolved against that</span>
<span class="sd">          remote :class:`.Column` object.</span>

<span class="sd">          .. versionchanged:: 0.9.0</span>
<span class="sd">            Support for propagation of type to a :class:`.Column` from its</span>
<span class="sd">            :class:`.ForeignKey` object has been improved and should be</span>
<span class="sd">            more reliable and timely.</span>

<span class="sd">        :param \*args: Additional positional arguments include various</span>
<span class="sd">          :class:`.SchemaItem` derived constructs which will be applied</span>
<span class="sd">          as options to the column.  These include instances of</span>
<span class="sd">          :class:`.Constraint`, :class:`.ForeignKey`, :class:`.ColumnDefault`,</span>
<span class="sd">          and :class:`.Sequence`.  In some cases an equivalent keyword</span>
<span class="sd">          argument is available such as ``server_default``, ``default``</span>
<span class="sd">          and ``unique``.</span>

<span class="sd">        :param autoincrement: Set up "auto increment" semantics for an integer</span>
<span class="sd">          primary key column.  The default value is the string ``"auto"``</span>
<span class="sd">          which indicates that a single-column primary key that is of</span>
<span class="sd">          an INTEGER type with no stated client-side or python-side defaults</span>
<span class="sd">          should receive auto increment semantics automatically;</span>
<span class="sd">          all other varieties of primary key columns will not.  This</span>
<span class="sd">          includes that :term:`DDL` such as PostgreSQL SERIAL or MySQL</span>
<span class="sd">          AUTO_INCREMENT will be emitted for this column during a table</span>
<span class="sd">          create, as well as that the column is assumed to generate new</span>
<span class="sd">          integer primary key values when an INSERT statement invokes which</span>
<span class="sd">          will be retrieved by the dialect.</span>

<span class="sd">          The flag may be set to ``True`` to indicate that a column which</span>
<span class="sd">          is part of a composite (e.g. multi-column) primary key should</span>
<span class="sd">          have autoincrement semantics, though note that only one column</span>
<span class="sd">          within a primary key may have this setting.    It can also</span>
<span class="sd">          be set to ``True`` to indicate autoincrement semantics on a</span>
<span class="sd">          column that has a client-side or server-side default configured,</span>
<span class="sd">          however note that not all dialects can accommodate all styles</span>
<span class="sd">          of default as an "autoincrement".  It can also be</span>
<span class="sd">          set to ``False`` on a single-column primary key that has a</span>
<span class="sd">          datatype of INTEGER in order to disable auto increment semantics</span>
<span class="sd">          for that column.</span>

<span class="sd">          .. versionchanged:: 1.1 The autoincrement flag now defaults to</span>
<span class="sd">             ``"auto"`` which indicates autoincrement semantics by default</span>
<span class="sd">             for single-column integer primary keys only; for composite</span>
<span class="sd">             (multi-column) primary keys, autoincrement is never implicitly</span>
<span class="sd">             enabled; as always, ``autoincrement=True`` will allow for</span>
<span class="sd">             at most one of those columns to be an "autoincrement" column.</span>
<span class="sd">             ``autoincrement=True`` may also be set on a :class:`.Column`</span>
<span class="sd">             that has an explicit client-side or server-side default,</span>
<span class="sd">             subject to limitations of the backend database and dialect.</span>


<span class="sd">          The setting *only* has an effect for columns which are:</span>

<span class="sd">          * Integer derived (i.e. INT, SMALLINT, BIGINT).</span>

<span class="sd">          * Part of the primary key</span>

<span class="sd">          * Not referring to another column via :class:`.ForeignKey`, unless</span>
<span class="sd">            the value is specified as ``'ignore_fk'``::</span>

<span class="sd">                # turn on autoincrement for this column despite</span>
<span class="sd">                # the ForeignKey()</span>
<span class="sd">                Column('id', ForeignKey('other.id'),</span>
<span class="sd">                            primary_key=True, autoincrement='ignore_fk')</span>

<span class="sd">            It is typically not desirable to have "autoincrement" enabled on a</span>
<span class="sd">            column that refers to another via foreign key, as such a column is</span>
<span class="sd">            required to refer to a value that originates from elsewhere.</span>

<span class="sd">          The setting has these two effects on columns that meet the</span>
<span class="sd">          above criteria:</span>

<span class="sd">          * DDL issued for the column will include database-specific</span>
<span class="sd">            keywords intended to signify this column as an</span>
<span class="sd">            "autoincrement" column, such as AUTO INCREMENT on MySQL,</span>
<span class="sd">            SERIAL on PostgreSQL, and IDENTITY on MS-SQL.  It does</span>
<span class="sd">            *not* issue AUTOINCREMENT for SQLite since this is a</span>
<span class="sd">            special SQLite flag that is not required for autoincrementing</span>
<span class="sd">            behavior.</span>

<span class="sd">            .. seealso::</span>

<span class="sd">                :ref:`sqlite_autoincrement`</span>

<span class="sd">          * The column will be considered to be available using an</span>
<span class="sd">            "autoincrement" method specific to the backend database, such</span>
<span class="sd">            as calling upon ``cursor.lastrowid``, using RETURNING in an</span>
<span class="sd">            INSERT statement to get at a sequence-generated value, or using</span>
<span class="sd">            special functions such as "SELECT scope_identity()".</span>
<span class="sd">            These methods are highly specific to the DBAPIs and databases in</span>
<span class="sd">            use and vary greatly, so care should be taken when associating</span>
<span class="sd">            ``autoincrement=True`` with a custom default generation function.</span>


<span class="sd">        :param default: A scalar, Python callable, or</span>
<span class="sd">            :class:`.ColumnElement` expression representing the</span>
<span class="sd">            *default value* for this column, which will be invoked upon insert</span>
<span class="sd">            if this column is otherwise not specified in the VALUES clause of</span>
<span class="sd">            the insert. This is a shortcut to using :class:`.ColumnDefault` as</span>
<span class="sd">            a positional argument; see that class for full detail on the</span>
<span class="sd">            structure of the argument.</span>

<span class="sd">            Contrast this argument to :paramref:`.Column.server_default`</span>
<span class="sd">            which creates a default generator on the database side.</span>

<span class="sd">            .. seealso::</span>

<span class="sd">                :ref:`metadata_defaults_toplevel`</span>

<span class="sd">        :param doc: optional String that can be used by the ORM or similar</span>
<span class="sd">            to document attributes on the Python side.   This attribute does</span>
<span class="sd">            **not** render SQL comments; use the :paramref:`.Column.comment`</span>
<span class="sd">            parameter for this purpose.</span>

<span class="sd">        :param key: An optional string identifier which will identify this</span>
<span class="sd">            ``Column`` object on the :class:`.Table`. When a key is provided,</span>
<span class="sd">            this is the only identifier referencing the ``Column`` within the</span>
<span class="sd">            application, including ORM attribute mapping; the ``name`` field</span>
<span class="sd">            is used only when rendering SQL.</span>

<span class="sd">        :param index: When ``True``, indicates that the column is indexed.</span>
<span class="sd">            This is a shortcut for using a :class:`.Index` construct on the</span>
<span class="sd">            table. To specify indexes with explicit names or indexes that</span>
<span class="sd">            contain multiple columns, use the :class:`.Index` construct</span>
<span class="sd">            instead.</span>

<span class="sd">        :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">            :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">        :param nullable: When set to ``False``, will cause the "NOT NULL"</span>
<span class="sd">            phrase to be added when generating DDL for the column.   When</span>
<span class="sd">            ``True``, will normally generate nothing (in SQL this defaults to</span>
<span class="sd">            "NULL"), except in some very specific backend-specific edge cases</span>
<span class="sd">            where "NULL" may render explicitly.   Defaults to ``True`` unless</span>
<span class="sd">            :paramref:`~.Column.primary_key` is also ``True``, in which case it</span>
<span class="sd">            defaults to ``False``.  This parameter is only used when issuing</span>
<span class="sd">            CREATE TABLE statements.</span>

<span class="sd">        :param onupdate: A scalar, Python callable, or</span>
<span class="sd">            :class:`~sqlalchemy.sql.expression.ClauseElement` representing a</span>
<span class="sd">            default value to be applied to the column within UPDATE</span>
<span class="sd">            statements, which will be invoked upon update if this column is not</span>
<span class="sd">            present in the SET clause of the update. This is a shortcut to</span>
<span class="sd">            using :class:`.ColumnDefault` as a positional argument with</span>
<span class="sd">            ``for_update=True``.</span>

<span class="sd">            .. seealso::</span>

<span class="sd">                :ref:`metadata_defaults` - complete discussion of onupdate</span>

<span class="sd">        :param primary_key: If ``True``, marks this column as a primary key</span>
<span class="sd">            column. Multiple columns can have this flag set to specify</span>
<span class="sd">            composite primary keys. As an alternative, the primary key of a</span>
<span class="sd">            :class:`.Table` can be specified via an explicit</span>
<span class="sd">            :class:`.PrimaryKeyConstraint` object.</span>

<span class="sd">        :param server_default: A :class:`.FetchedValue` instance, str, Unicode</span>
<span class="sd">            or :func:`~sqlalchemy.sql.expression.text` construct representing</span>
<span class="sd">            the DDL DEFAULT value for the column.</span>

<span class="sd">            String types will be emitted as-is, surrounded by single quotes::</span>

<span class="sd">                Column('x', Text, server_default="val")</span>

<span class="sd">                x TEXT DEFAULT 'val'</span>

<span class="sd">            A :func:`~sqlalchemy.sql.expression.text` expression will be</span>
<span class="sd">            rendered as-is, without quotes::</span>

<span class="sd">                Column('y', DateTime, server_default=text('NOW()'))</span>

<span class="sd">                y DATETIME DEFAULT NOW()</span>

<span class="sd">            Strings and text() will be converted into a</span>
<span class="sd">            :class:`.DefaultClause` object upon initialization.</span>

<span class="sd">            Use :class:`.FetchedValue` to indicate that an already-existing</span>
<span class="sd">            column will generate a default value on the database side which</span>
<span class="sd">            will be available to SQLAlchemy for post-fetch after inserts. This</span>
<span class="sd">            construct does not specify any DDL and the implementation is left</span>
<span class="sd">            to the database, such as via a trigger.</span>

<span class="sd">            .. seealso::</span>

<span class="sd">                :ref:`server_defaults` - complete discussion of server side</span>
<span class="sd">                defaults</span>

<span class="sd">        :param server_onupdate:   A :class:`.FetchedValue` instance</span>
<span class="sd">             representing a database-side default generation function,</span>
<span class="sd">             such as a trigger. This</span>
<span class="sd">             indicates to SQLAlchemy that a newly generated value will be</span>
<span class="sd">             available after updates. This construct does not actually</span>
<span class="sd">             implement any kind of generation function within the database,</span>
<span class="sd">             which instead must be specified separately.</span>

<span class="sd">            .. seealso::</span>

<span class="sd">                :ref:`triggered_columns`</span>

<span class="sd">        :param quote: Force quoting of this column's name on or off,</span>
<span class="sd">             corresponding to ``True`` or ``False``. When left at its default</span>
<span class="sd">             of ``None``, the column identifier will be quoted according to</span>
<span class="sd">             whether the name is case sensitive (identifiers with at least one</span>
<span class="sd">             upper case character are treated as case sensitive), or if it's a</span>
<span class="sd">             reserved word. This flag is only needed to force quoting of a</span>
<span class="sd">             reserved word which is not known by the SQLAlchemy dialect.</span>

<span class="sd">        :param unique: When ``True``, indicates that this column contains a</span>
<span class="sd">             unique constraint, or if ``index`` is ``True`` as well, indicates</span>
<span class="sd">             that the :class:`.Index` should be created with the unique flag.</span>
<span class="sd">             To specify multiple columns in the constraint/index or to specify</span>
<span class="sd">             an explicit name, use the :class:`.UniqueConstraint` or</span>
<span class="sd">             :class:`.Index` constructs explicitly.</span>

<span class="sd">        :param system: When ``True``, indicates this is a "system" column,</span>
<span class="sd">             that is a column which is automatically made available by the</span>
<span class="sd">             database, and should not be included in the columns list for a</span>
<span class="sd">             ``CREATE TABLE`` statement.</span>

<span class="sd">             For more elaborate scenarios where columns should be</span>
<span class="sd">             conditionally rendered differently on different backends,</span>
<span class="sd">             consider custom compilation rules for :class:`.CreateColumn`.</span>

<span class="sd">        :param comment: Optional string that will render an SQL comment on</span>
<span class="sd">             table creation.</span>

<span class="sd">             .. versionadded:: 1.2 Added the :paramref:`.Column.comment`</span>
<span class="sd">                parameter to :class:`.Column`.</span>


<span class="sd">        """</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"type_"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s2">"May not pass name positionally and as a keyword."</span>
                    <span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">coltype</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="s2">"_sqla_type"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s2">"May not pass type_ positionally and as a keyword."</span>
                    <span class="p">)</span>
                <span class="n">type_</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">quoted_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"quote"</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s2">"quote"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Explicit 'name' is required when "</span> <span class="s2">"sending 'quote' argument"</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"key"</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"primary_key"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"nullable"</span><span class="p">,</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"default"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"server_default"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"server_onupdate"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># these default to None because .index and .unique is *not*</span>
        <span class="c1"># an informational flag about Column - there can still be an</span>
        <span class="c1"># Index or UniqueConstraint referring to this Column.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"index"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"unique"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"system"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"doc"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"onupdate"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoincrement</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"autoincrement"</span><span class="p">,</span> <span class="s2">"auto"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"comment"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># check if this Column is proxying another column</span>
        <span class="k">if</span> <span class="s2">"_proxies"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_proxies"</span><span class="p">)</span>
        <span class="c1"># otherwise, add DDL-related events</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">SchemaEventTarget</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="p">(</span><span class="n">ColumnDefault</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s2">"_warn_on_bytestring"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">binary_type</span><span class="p">):</span>
                        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">"Unicode column '</span><span class="si">%s</span><span class="s2">' has non-unicode "</span>
                            <span class="s2">"default value </span><span class="si">%r</span><span class="s2"> specified."</span>
                            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColumnDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">,</span> <span class="n">FetchedValue</span><span class="p">):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="o">.</span><span class="n">_as_for_update</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DefaultClause</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span> <span class="p">(</span><span class="n">ColumnDefault</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColumnDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="p">,</span> <span class="n">FetchedValue</span><span class="p">):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="o">.</span><span class="n">_as_for_update</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">DefaultClause</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_items</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="n">util</span><span class="o">.</span><span class="n">set_creation_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">"info"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"info"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extra_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dialect_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1">#    @property</span>
    <span class="c1">#    def quote(self):</span>
    <span class="c1">#        return getattr(self.name, "quote", None)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"(no name)"</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">named_with_column</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>

    <span class="k">def</span> <span class="nf">references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">"""Return True if this Column references the given column via foreign</span>
<span class="sd">        key."""</span>

        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">proxy_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">proxy_set</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">append_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fk</span><span class="p">):</span>
        <span class="n">fk</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwarg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"key"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"primary_key"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"nullable"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"onupdate"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"default"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"server_default"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">"Column(</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
            <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)]</span>
            <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="s2">"table=&lt;</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">description</span>
                    <span class="ow">or</span> <span class="s2">"table=None"</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span><span class="s2">"</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwarg</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Column must be constructed with a non-blank name or "</span>
                <span class="s2">"assign a non-blank .name before adding to a Table."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"table"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Column object '</span><span class="si">%s</span><span class="s2">' already assigned to Table '</span><span class="si">%s</span><span class="s2">'"</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">existing</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">foreign_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                        <span class="c1"># this might have been removed</span>
                        <span class="c1"># already, if it's a composite constraint</span>
                        <span class="c1"># and more than one col being replaced</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fk</span><span class="o">.</span><span class="n">constraint</span><span class="p">)</span>

        <span class="n">table</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Trying to redefine primary-key column '</span><span class="si">%s</span><span class="s2">' as a "</span>
                <span class="s2">"non-primary-key column on table '</span><span class="si">%s</span><span class="s2">'"</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"The 'index' keyword argument on Column is boolean only. "</span>
                    <span class="s2">"To create indexes with a specific name, create an "</span>
                    <span class="s2">"explicit Index object external to the Table."</span>
                <span class="p">)</span>
            <span class="n">Index</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">),</span> <span class="n">_column_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"The 'unique' keyword argument on Column is boolean "</span>
                    <span class="s2">"only. To create unique constraints or indexes with a "</span>
                    <span class="s2">"specific name, append an explicit UniqueConstraint to "</span>
                    <span class="s2">"the Table's list of elements, or create an explicit "</span>
                    <span class="s2">"Index object external to the Table."</span>
                <span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append_constraint</span><span class="p">(</span>
                <span class="n">UniqueConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">_column_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_on_memoized_fks</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fk</span><span class="p">:</span> <span class="n">fk</span><span class="o">.</span><span class="n">_set_remote_table</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_setup_on_memoized_fks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="n">fk_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">),</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">fk_key</span><span class="p">,</span> <span class="n">link_to_name</span> <span class="ow">in</span> <span class="n">fk_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fk_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">_fk_memos</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">_fk_memos</span><span class="p">[</span><span class="n">fk_key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">link_to_name</span> <span class="ow">is</span> <span class="n">link_to_name</span><span class="p">:</span>
                        <span class="n">fn</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_table_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"after_parent_attach"</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">"""Create a copy of this ``Column``, uninitialized.</span>

<span class="sd">        This is used in ``Table.tometadata``.</span>

<span class="sd">        """</span>

        <span class="c1"># Constraint objects plus non-constraint-bound ForeignKey objects</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">_type_bound</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">constraint</span><span class="p">]</span>

        <span class="n">type_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">SchemaEventTarget</span><span class="p">):</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">type_</span><span class="o">=</span><span class="n">type_</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">primary_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span>
            <span class="n">nullable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
            <span class="n">system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
            <span class="c1"># quote=self.quote,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">autoincrement</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">autoincrement</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="n">server_default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">,</span>
            <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
            <span class="n">server_onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_item_copy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_proxy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">selectable</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name_is_truncatable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
    <span class="p">):</span>
        <span class="sd">"""Create a *proxy* for this column.</span>

<span class="sd">        This is a copy of this ``Column`` referenced by a different parent</span>
<span class="sd">        (such as an alias or select statement).  The column should</span>
<span class="sd">        be used only in select scenarios, as its full DDL/default</span>
<span class="sd">        information is not transferred.</span>

<span class="sd">        """</span>
        <span class="n">fk</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ForeignKey</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">_constraint</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">constraint</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">"Cannot initialize a sub-selectable"</span>
                <span class="s2">" with this Column object until its 'name' has "</span>
                <span class="s2">"been assigned."</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span>
                <span class="n">_as_truncated</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name_is_truncatable</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">key</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="n">primary_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span>
                <span class="n">nullable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
                <span class="n">_proxies</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span>
                <span class="o">*</span><span class="n">fk</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">raise_from_cause</span><span class="p">(</span>
                <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">"Could not create a copy of this </span><span class="si">%r</span><span class="s2"> object.  "</span>
                    <span class="s2">"Ensure the class includes a _constructor() "</span>
                    <span class="s2">"attribute or method which accepts the "</span>
                    <span class="s2">"standard Column constructor arguments, or "</span>
                    <span class="s2">"references the Column class itself."</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">selectable</span>
        <span class="n">selectable</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selectable</span><span class="o">.</span><span class="n">_is_clone_of</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_is_clone_of</span> <span class="o">=</span> <span class="n">selectable</span><span class="o">.</span><span class="n">_is_clone_of</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">selectable</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_parent_attach</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">selectable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_visitor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">schema_visitor</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">)</span>
                <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ColumnClause</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ForeignKey</span><span class="p">(</span><span class="n">DialectKWArgs</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">"""Defines a dependency between two columns.</span>

<span class="sd">    ``ForeignKey`` is specified as an argument to a :class:`.Column` object,</span>
<span class="sd">    e.g.::</span>

<span class="sd">        t = Table("remote_table", metadata,</span>
<span class="sd">            Column("remote_id", ForeignKey("main_table.id"))</span>
<span class="sd">        )</span>

<span class="sd">    Note that ``ForeignKey`` is only a marker object that defines</span>
<span class="sd">    a dependency between two columns.   The actual constraint</span>
<span class="sd">    is in all cases represented by the :class:`.ForeignKeyConstraint`</span>
<span class="sd">    object.   This object will be generated automatically when</span>
<span class="sd">    a ``ForeignKey`` is associated with a :class:`.Column` which</span>
<span class="sd">    in turn is associated with a :class:`.Table`.   Conversely,</span>
<span class="sd">    when :class:`.ForeignKeyConstraint` is applied to a :class:`.Table`,</span>
<span class="sd">    ``ForeignKey`` markers are automatically generated to be</span>
<span class="sd">    present on each associated :class:`.Column`, which are also</span>
<span class="sd">    associated with the constraint object.</span>

<span class="sd">    Note that you cannot define a "composite" foreign key constraint,</span>
<span class="sd">    that is a constraint between a grouping of multiple parent/child</span>
<span class="sd">    columns, using ``ForeignKey`` objects.   To define this grouping,</span>
<span class="sd">    the :class:`.ForeignKeyConstraint` object must be used, and applied</span>
<span class="sd">    to the :class:`.Table`.   The associated ``ForeignKey`` objects</span>
<span class="sd">    are created automatically.</span>

<span class="sd">    The ``ForeignKey`` objects associated with an individual</span>
<span class="sd">    :class:`.Column` object are available in the `foreign_keys` collection</span>
<span class="sd">    of that column.</span>

<span class="sd">    Further examples of foreign key configuration are in</span>
<span class="sd">    :ref:`metadata_foreignkeys`.</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"foreign_key"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">column</span><span class="p">,</span>
        <span class="n">_constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_alter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">onupdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ondelete</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deferrable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initially</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">link_to_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">dialect_kw</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""</span>
<span class="sd">        Construct a column-level FOREIGN KEY.</span>

<span class="sd">        The :class:`.ForeignKey` object when constructed generates a</span>
<span class="sd">        :class:`.ForeignKeyConstraint` which is associated with the parent</span>
<span class="sd">        :class:`.Table` object's collection of constraints.</span>

<span class="sd">        :param column: A single target column for the key relationship. A</span>
<span class="sd">            :class:`.Column` object or a column name as a string:</span>
<span class="sd">            ``tablename.columnkey`` or ``schema.tablename.columnkey``.</span>
<span class="sd">            ``columnkey`` is the ``key`` which has been assigned to the column</span>
<span class="sd">            (defaults to the column name itself), unless ``link_to_name`` is</span>
<span class="sd">            ``True`` in which case the rendered name of the column is used.</span>

<span class="sd">        :param name: Optional string. An in-database name for the key if</span>
<span class="sd">            `constraint` is not provided.</span>

<span class="sd">        :param onupdate: Optional string. If set, emit ON UPDATE &lt;value&gt; when</span>
<span class="sd">            issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">            DELETE and RESTRICT.</span>

<span class="sd">        :param ondelete: Optional string. If set, emit ON DELETE &lt;value&gt; when</span>
<span class="sd">            issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">            DELETE and RESTRICT.</span>

<span class="sd">        :param deferrable: Optional bool. If set, emit DEFERRABLE or NOT</span>
<span class="sd">            DEFERRABLE when issuing DDL for this constraint.</span>

<span class="sd">        :param initially: Optional string. If set, emit INITIALLY &lt;value&gt; when</span>
<span class="sd">            issuing DDL for this constraint.</span>

<span class="sd">        :param link_to_name: if True, the string name given in ``column`` is</span>
<span class="sd">            the rendered name of the referenced column, not its locally</span>
<span class="sd">            assigned ``key``.</span>

<span class="sd">        :param use_alter: passed to the underlying</span>
<span class="sd">            :class:`.ForeignKeyConstraint` to indicate the constraint should</span>
<span class="sd">            be generated/dropped externally from the CREATE TABLE/ DROP TABLE</span>
<span class="sd">            statement.  See :paramref:`.ForeignKeyConstraint.use_alter`</span>
<span class="sd">            for further description.</span>

<span class="sd">            .. seealso::</span>

<span class="sd">                :paramref:`.ForeignKeyConstraint.use_alter`</span>

<span class="sd">                :ref:`use_alter`</span>

<span class="sd">        :param match: Optional string. If set, emit MATCH &lt;value&gt; when issuing</span>
<span class="sd">            DDL for this constraint. Typical values include SIMPLE, PARTIAL</span>
<span class="sd">            and FULL.</span>

<span class="sd">        :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">            :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">            .. versionadded:: 1.0.0</span>

<span class="sd">        :param \**dialect_kw:  Additional keyword arguments are dialect</span>
<span class="sd">            specific, and passed in the form ``&lt;dialectname&gt;_&lt;argname&gt;``.  The</span>
<span class="sd">            arguments are ultimately handled by a corresponding</span>
<span class="sd">            :class:`.ForeignKeyConstraint`.  See the documentation regarding</span>
<span class="sd">            an individual dialect at :ref:`dialect_toplevel` for detail on</span>
<span class="sd">            documented arguments.</span>

<span class="sd">            .. versionadded:: 0.9.2</span>

<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span> <span class="o">=</span> <span class="n">column</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="s2">"__clause_element__"</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span><span class="p">,</span> <span class="n">ColumnClause</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"String, Column, or Column-bound argument "</span>
                    <span class="s2">"expected, got </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">NoneType</span><span class="p">,</span> <span class="n">TableClause</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"ForeignKey received Column not bound "</span>
                    <span class="s2">"to a Table, got: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span>
                <span class="p">)</span>

        <span class="c1"># the linked ForeignKeyConstraint.</span>
        <span class="c1"># ForeignKey will create this when parent Column</span>
        <span class="c1"># is attached to a Table, *or* ForeignKeyConstraint</span>
        <span class="c1"># object passes itself in when creating ForeignKey</span>
        <span class="c1"># markers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">_constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span> <span class="o">=</span> <span class="n">use_alter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="n">onupdate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="n">ondelete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span> <span class="o">=</span> <span class="n">deferrable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initially</span> <span class="o">=</span> <span class="n">initially</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span> <span class="o">=</span> <span class="n">link_to_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unvalidated_dialect_kw</span> <span class="o">=</span> <span class="n">dialect_kw</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"ForeignKey(</span><span class="si">%r</span><span class="s2">)"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_colspec</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Produce a copy of this :class:`.ForeignKey` object.</span>

<span class="sd">        The new :class:`.ForeignKey` will not be bound</span>
<span class="sd">        to any :class:`.Column`.</span>

<span class="sd">        This method is usually used by the internal</span>
<span class="sd">        copy procedures of :class:`.Column`, :class:`.Table`,</span>
<span class="sd">        and :class:`.MetaData`.</span>

<span class="sd">        :param schema: The returned :class:`.ForeignKey` will</span>
<span class="sd">          reference the original table and column name, qualified</span>
<span class="sd">          by the given string schema name.</span>

<span class="sd">        """</span>

        <span class="n">fk</span> <span class="o">=</span> <span class="n">ForeignKey</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_colspec</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">),</span>
            <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
            <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
            <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
            <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
            <span class="n">link_to_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">,</span>
            <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_unvalidated_dialect_kw</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_item_copy</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_colspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Return a string based 'column specification' for this</span>
<span class="sd">        :class:`.ForeignKey`.</span>

<span class="sd">        This is usually the equivalent of the string-based "tablename.colname"</span>
<span class="sd">        argument first passed to the object's constructor.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="n">_schema</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_tokens</span>
            <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tname</span> <span class="o">=</span> <span class="n">table_name</span>
            <span class="k">return</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="n">schema</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_tokens</span>
            <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_referred_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_table_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_tokens</span>
            <span class="k">return</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

    <span class="n">target_fullname</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_colspec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">"""Return True if the given :class:`.Table` is referenced by this</span>
<span class="sd">        :class:`.ForeignKey`."""</span>

        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_referent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">"""Return the :class:`.Column` in the given :class:`.Table`</span>
<span class="sd">        referenced by this :class:`.ForeignKey`.</span>

<span class="sd">        Returns None if this :class:`.ForeignKey` does not reference the given</span>
<span class="sd">        :class:`.Table`.</span>

<span class="sd">        """</span>

        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">_column_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""parse a string-based _colspec into its component parts."""</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_colspec</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Invalid foreign key column specification: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">tname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># A FK between column 'bar' and table 'foo' can be</span>
        <span class="c1"># specified as 'foo', 'foo.bar', 'dbo.foo.bar',</span>
        <span class="c1"># 'otherdb.dbo.foo.bar'. Once we have the column name and</span>
        <span class="c1"># the table name, treat everything else as the schema</span>
        <span class="c1"># name. Some databases (e.g. Sybase) support</span>
        <span class="c1"># inter-database foreign keys. See tickets#1341 and --</span>
        <span class="c1"># indirectly related -- Ticket #594. This assumes that '.'</span>
        <span class="c1"># will never appear *within* any component of the FK.</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="s2">"."</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">schema</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span>

    <span class="k">def</span> <span class="nf">_resolve_col_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">"this ForeignKey object does not yet have a "</span>
                <span class="s2">"parent Column associated with it."</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">"this ForeignKey's parent column is not yet associated "</span>
                <span class="s2">"with a Table."</span>
            <span class="p">)</span>

        <span class="n">parenttable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">table</span>

        <span class="c1"># assertion</span>
        <span class="c1"># basically Column._make_proxy() sends the actual</span>
        <span class="c1"># target Column to the ForeignKey object, so the</span>
        <span class="c1"># string resolution here is never called.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">base_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="n">parenttable</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>
        <span class="c1">######################</span>

        <span class="n">schema</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_tokens</span>

        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>

        <span class="n">tablekey</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parenttable</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">colname</span>

    <span class="k">def</span> <span class="nf">_link_to_col_by_colstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parenttable</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span> <span class="s2">"_referred_table"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_referred_table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_referred_table</span> <span class="ow">is</span> <span class="n">table</span>

        <span class="n">_column</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">colname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># colname is None in the case that ForeignKey argument</span>
            <span class="c1"># was specified as table name only, in which case we</span>
            <span class="c1"># match the column name to the same column on the</span>
            <span class="c1"># parent.</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">colname</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">colname</span><span class="p">:</span>
                    <span class="n">_column</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">colname</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoReferencedColumnError</span><span class="p">(</span>
                <span class="s2">"Could not initialize target column "</span>
                <span class="s2">"for ForeignKey '</span><span class="si">%s</span><span class="s2">' on table '</span><span class="si">%s</span><span class="s2">': "</span>
                <span class="s2">"table '</span><span class="si">%s</span><span class="s2">' has no column named '</span><span class="si">%s</span><span class="s2">'"</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_target_column</span><span class="p">(</span><span class="n">_column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_target_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="c1"># propagate TypeEngine to parent if it didn't have one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_isnull</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span>

        <span class="c1"># super-edgy case, if other FKs point to our column,</span>
        <span class="c1"># they'd get the type propagated out also.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">set_type</span><span class="p">(</span><span class="n">fk</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_isnull</span><span class="p">:</span>
                    <span class="n">fk</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_setup_on_memoized_fks</span><span class="p">(</span><span class="n">set_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the target :class:`.Column` referenced by this</span>
<span class="sd">        :class:`.ForeignKey`.</span>

<span class="sd">        If no target column has been established, an exception</span>
<span class="sd">        is raised.</span>

<span class="sd">        .. versionchanged:: 0.9.0</span>
<span class="sd">            Foreign key target column resolution now occurs as soon as both</span>
<span class="sd">            the ForeignKey object and the remote Column to which it refers</span>
<span class="sd">            are both associated with the same MetaData object.</span>

<span class="sd">        """</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>

            <span class="n">parenttable</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_col_tokens</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">tablekey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoReferencedTableError</span><span class="p">(</span>
                    <span class="s2">"Foreign key associated with column '</span><span class="si">%s</span><span class="s2">' could not find "</span>
                    <span class="s2">"table '</span><span class="si">%s</span><span class="s2">' with which to generate a "</span>
                    <span class="s2">"foreign key to target column '</span><span class="si">%s</span><span class="s2">'"</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">colname</span><span class="p">),</span>
                    <span class="n">tablekey</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s2">"Table </span><span class="si">%s</span><span class="s2"> is no longer associated with its "</span>
                    <span class="s2">"parent MetaData"</span> <span class="o">%</span> <span class="n">parenttable</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoReferencedColumnError</span><span class="p">(</span>
                    <span class="s2">"Could not initialize target column for "</span>
                    <span class="s2">"ForeignKey '</span><span class="si">%s</span><span class="s2">' on table '</span><span class="si">%s</span><span class="s2">': "</span>
                    <span class="s2">"table '</span><span class="si">%s</span><span class="s2">' has no column named '</span><span class="si">%s</span><span class="s2">'"</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">colname</span><span class="p">),</span>
                    <span class="n">tablekey</span><span class="p">,</span>
                    <span class="n">colname</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="s2">"__clause_element__"</span><span class="p">):</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">_column</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>
            <span class="k">return</span> <span class="n">_column</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">"This ForeignKey already has a parent !"</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">foreign_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_on_table_attach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_remote_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">parenttable</span><span class="p">,</span> <span class="n">tablekey</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_col_tokens</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_link_to_col_by_colstring</span><span class="p">(</span><span class="n">parenttable</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_validate_dest_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_from_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="n">parenttable</span><span class="p">,</span> <span class="n">table_key</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_col_tokens</span><span class="p">()</span>
        <span class="n">fk_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">table_key</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">_fk_memos</span><span class="p">[</span><span class="n">fk_key</span><span class="p">]:</span>
            <span class="c1"># TODO: no test coverage for self not in memos</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">_fk_memos</span><span class="p">[</span><span class="n">fk_key</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="c1"># standalone ForeignKey - create ForeignKeyConstraint</span>
        <span class="c1"># on the hosting Table when attached to the Table.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
                <span class="p">[],</span>
                <span class="p">[],</span>
                <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
                <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
                <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
                <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
                <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_unvalidated_dialect_kw</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_append_element</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">foreign_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># set up remote ".column" attribute, or a note to pick it</span>
        <span class="c1"># up when the other Table/Column shows up</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">parenttable</span><span class="p">,</span> <span class="n">table_key</span><span class="p">,</span> <span class="n">colname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_col_tokens</span><span class="p">()</span>
            <span class="n">fk_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">table_key</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">table_key</span> <span class="ow">in</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_key</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_link_to_col_by_colstring</span><span class="p">(</span><span class="n">parenttable</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoReferencedColumnError</span><span class="p">:</span>
                    <span class="c1"># this is OK, we'll try later</span>
                    <span class="k">pass</span>
            <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">_fk_memos</span><span class="p">[</span><span class="n">fk_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="s2">"__clause_element__"</span><span class="p">):</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_target_column</span><span class="p">(</span><span class="n">_column</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_target_column</span><span class="p">(</span><span class="n">_column</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_NotAColumnExpr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_not_a_column_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
            <span class="s2">"This </span><span class="si">%s</span><span class="s2"> cannot be used directly "</span>
            <span class="s2">"as a column expression."</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">)</span>

    <span class="n">__clause_element__</span> <span class="o">=</span> <span class="n">self_group</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_not_a_column_expr</span><span class="p">()</span>
    <span class="n">_from_objects</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_not_a_column_expr</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">DefaultGenerator</span><span class="p">(</span><span class="n">_NotAColumnExpr</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">"""Base class for column *default* values."""</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"default_generator"</span>

    <span class="n">is_sequence</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_server_default</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="n">for_update</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bind</span><span class="o">.</span><span class="n">_execute_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_on_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">multiparams</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">_execute_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiparams</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the connectable associated with this default."""</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"column"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">bind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">ColumnDefault</span><span class="p">(</span><span class="n">DefaultGenerator</span><span class="p">):</span>
    <span class="sd">"""A plain default value on a column.</span>

<span class="sd">    This could correspond to a constant, a callable function,</span>
<span class="sd">    or a SQL clause.</span>

<span class="sd">    :class:`.ColumnDefault` is generated automatically</span>
<span class="sd">    whenever the ``default``, ``onupdate`` arguments of</span>
<span class="sd">    :class:`.Column` are used.  A :class:`.ColumnDefault`</span>
<span class="sd">    can be passed positionally as well.</span>

<span class="sd">    For example, the following::</span>

<span class="sd">        Column('foo', Integer, default=50)</span>

<span class="sd">    Is equivalent to::</span>

<span class="sd">        Column('foo', Integer, ColumnDefault(50))</span>


<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">""""Construct a new :class:`.ColumnDefault`.</span>


<span class="sd">        :param arg: argument representing the default value.</span>
<span class="sd">         May be one of the following:</span>

<span class="sd">         * a plain non-callable Python value, such as a</span>
<span class="sd">           string, integer, boolean, or other simple type.</span>
<span class="sd">           The default value will be used as is each time.</span>
<span class="sd">         * a SQL expression, that is one which derives from</span>
<span class="sd">           :class:`.ColumnElement`.  The SQL expression will</span>
<span class="sd">           be rendered into the INSERT or UPDATE statement,</span>
<span class="sd">           or in the case of a primary key column when</span>
<span class="sd">           RETURNING is not used may be</span>
<span class="sd">           pre-executed before an INSERT within a SELECT.</span>
<span class="sd">         * A Python callable.  The function will be invoked for each</span>
<span class="sd">           new row subject to an INSERT or UPDATE.</span>
<span class="sd">           The callable must accept exactly</span>
<span class="sd">           zero or one positional arguments.  The one-argument form</span>
<span class="sd">           will receive an instance of the :class:`.ExecutionContext`,</span>
<span class="sd">           which provides contextual information as to the current</span>
<span class="sd">           :class:`.Connection` in use as well as the current</span>
<span class="sd">           statement and parameters.</span>

<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ColumnDefault</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">FetchedValue</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"ColumnDefault may not be a server-side default type."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_wrap_callable</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">is_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">is_clause_element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">ClauseElement</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">is_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_callable</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_clause_element</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sequence</span>
        <span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="nd">@util</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="s2">"sqlalchemy.sql.sqltypes"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_arg_is_typed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqltypes</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_clause_element</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">NullType</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_maybe_wrap_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="sd">"""Wrap callables that don't accept a context.</span>

<span class="sd">        This is to allow easy compatibility with default callables</span>
<span class="sd">        that aren't specific to accepting of a context.</span>

<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">argspec</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_callable_argspec</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">no_self</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">wrap_callable</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">fn</span><span class="p">(),</span> <span class="n">fn</span><span class="p">)</span>

        <span class="n">defaulted</span> <span class="o">=</span> <span class="n">argspec</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">positionals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">defaulted</span>

        <span class="k">if</span> <span class="n">positionals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">wrap_callable</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">fn</span><span class="p">(),</span> <span class="n">fn</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">positionals</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"ColumnDefault Python function takes zero or one "</span>
                <span class="s2">"positional arguments"</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_visit_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"column_onupdate"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"column_default"</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_visit_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"ColumnDefault(</span><span class="si">%r</span><span class="s2">)"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">Sequence</span><span class="p">(</span><span class="n">DefaultGenerator</span><span class="p">):</span>
    <span class="sd">"""Represents a named database sequence.</span>

<span class="sd">    The :class:`.Sequence` object represents the name and configurational</span>
<span class="sd">    parameters of a database sequence.   It also represents</span>
<span class="sd">    a construct that can be "executed" by a SQLAlchemy :class:`.Engine`</span>
<span class="sd">    or :class:`.Connection`, rendering the appropriate "next value" function</span>
<span class="sd">    for the target database and returning a result.</span>

<span class="sd">    The :class:`.Sequence` is typically associated with a primary key column::</span>

<span class="sd">        some_table = Table(</span>
<span class="sd">            'some_table', metadata,</span>
<span class="sd">            Column('id', Integer, Sequence('some_table_seq'),</span>
<span class="sd">            primary_key=True)</span>
<span class="sd">        )</span>

<span class="sd">    When CREATE TABLE is emitted for the above :class:`.Table`, if the</span>
<span class="sd">    target platform supports sequences, a CREATE SEQUENCE statement will</span>
<span class="sd">    be emitted as well.   For platforms that don't support sequences,</span>
<span class="sd">    the :class:`.Sequence` construct is ignored.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :class:`.CreateSequence`</span>

<span class="sd">        :class:`.DropSequence`</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"sequence"</span>

    <span class="n">is_sequence</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">increment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">minvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">maxvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nominvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nomaxvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cycle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">quote</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">quote_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">"""Construct a :class:`.Sequence` object.</span>

<span class="sd">        :param name: The name of the sequence.</span>
<span class="sd">        :param start: the starting index of the sequence.  This value is</span>
<span class="sd">         used when the CREATE SEQUENCE command is emitted to the database</span>
<span class="sd">         as the value of the "START WITH" clause.   If ``None``, the</span>
<span class="sd">         clause is omitted, which on most platforms indicates a starting</span>
<span class="sd">         value of 1.</span>
<span class="sd">        :param increment: the increment value of the sequence.  This</span>
<span class="sd">         value is used when the CREATE SEQUENCE command is emitted to</span>
<span class="sd">         the database as the value of the "INCREMENT BY" clause.  If ``None``,</span>
<span class="sd">         the clause is omitted, which on most platforms indicates an</span>
<span class="sd">         increment of 1.</span>
<span class="sd">        :param minvalue: the minimum value of the sequence.  This</span>
<span class="sd">         value is used when the CREATE SEQUENCE command is emitted to</span>
<span class="sd">         the database as the value of the "MINVALUE" clause.  If ``None``,</span>
<span class="sd">         the clause is omitted, which on most platforms indicates a</span>
<span class="sd">         minvalue of 1 and -2^63-1 for ascending and descending sequences,</span>
<span class="sd">         respectively.</span>

<span class="sd">         .. versionadded:: 1.0.7</span>

<span class="sd">        :param maxvalue: the maximum value of the sequence.  This</span>
<span class="sd">         value is used when the CREATE SEQUENCE command is emitted to</span>
<span class="sd">         the database as the value of the "MAXVALUE" clause.  If ``None``,</span>
<span class="sd">         the clause is omitted, which on most platforms indicates a</span>
<span class="sd">         maxvalue of 2^63-1 and -1 for ascending and descending sequences,</span>
<span class="sd">         respectively.</span>

<span class="sd">         .. versionadded:: 1.0.7</span>

<span class="sd">        :param nominvalue: no minimum value of the sequence.  This</span>
<span class="sd">         value is used when the CREATE SEQUENCE command is emitted to</span>
<span class="sd">         the database as the value of the "NO MINVALUE" clause.  If ``None``,</span>
<span class="sd">         the clause is omitted, which on most platforms indicates a</span>
<span class="sd">         minvalue of 1 and -2^63-1 for ascending and descending sequences,</span>
<span class="sd">         respectively.</span>

<span class="sd">         .. versionadded:: 1.0.7</span>

<span class="sd">        :param nomaxvalue: no maximum value of the sequence.  This</span>
<span class="sd">         value is used when the CREATE SEQUENCE command is emitted to</span>
<span class="sd">         the database as the value of the "NO MAXVALUE" clause.  If ``None``,</span>
<span class="sd">         the clause is omitted, which on most platforms indicates a</span>
<span class="sd">         maxvalue of 2^63-1 and -1 for ascending and descending sequences,</span>
<span class="sd">         respectively.</span>

<span class="sd">         .. versionadded:: 1.0.7</span>

<span class="sd">        :param cycle: allows the sequence to wrap around when the maxvalue</span>
<span class="sd">         or minvalue has been reached by an ascending or descending sequence</span>
<span class="sd">         respectively.  This value is used when the CREATE SEQUENCE command</span>
<span class="sd">         is emitted to the database as the "CYCLE" clause.  If the limit is</span>
<span class="sd">         reached, the next number generated will be the minvalue or maxvalue,</span>
<span class="sd">         respectively.  If cycle=False (the default) any calls to nextval</span>
<span class="sd">         after the sequence has reached its maximum value will return an</span>
<span class="sd">         error.</span>

<span class="sd">         .. versionadded:: 1.0.7</span>

<span class="sd">        :param schema: Optional schema name for the sequence, if located</span>
<span class="sd">         in a schema other than the default.  The rules for selecting the</span>
<span class="sd">         schema name when a :class:`.MetaData` is also present are the same</span>
<span class="sd">         as that of :paramref:`.Table.schema`.</span>

<span class="sd">        :param cache: optional integer value; number of future values in the</span>
<span class="sd">         sequence which are calculated in advance.  Renders the CACHE keyword</span>
<span class="sd">         understood by Oracle and PostgreSQL.</span>

<span class="sd">         .. versionadded:: 1.1.12</span>

<span class="sd">        :param order: optional boolean value; if true, renders the</span>
<span class="sd">         ORDER keyword, understood by Oracle, indicating the sequence is</span>
<span class="sd">         definitively ordered.   May be necessary to provide deterministic</span>
<span class="sd">         ordering using Oracle RAC.</span>

<span class="sd">         .. versionadded:: 1.1.12</span>

<span class="sd">        :param optional: boolean value, when ``True``, indicates that this</span>
<span class="sd">         :class:`.Sequence` object only needs to be explicitly generated</span>
<span class="sd">         on backends that don't provide another way to generate primary</span>
<span class="sd">         key identifiers.  Currently, it essentially means, "don't create</span>
<span class="sd">         this sequence on the PostgreSQL backend, where the SERIAL keyword</span>
<span class="sd">         creates a sequence for us automatically".</span>
<span class="sd">        :param quote: boolean value, when ``True`` or ``False``, explicitly</span>
<span class="sd">         forces quoting of the schema name on or off.  When left at its</span>
<span class="sd">         default of ``None``, normal quoting rules based on casing and</span>
<span class="sd">         reserved words take place.</span>
<span class="sd">        :param quote_schema: set the quoting preferences for the ``schema``</span>
<span class="sd">         name.</span>

<span class="sd">        :param metadata: optional :class:`.MetaData` object which this</span>
<span class="sd">         :class:`.Sequence` will be associated with.  A :class:`.Sequence`</span>
<span class="sd">         that is associated with a :class:`.MetaData` gains the following</span>
<span class="sd">         capabilities:</span>

<span class="sd">         * The :class:`.Sequence` will inherit the :paramref:`.MetaData.schema`</span>
<span class="sd">           parameter specified to the target :class:`.MetaData`, which</span>
<span class="sd">           affects the production of CREATE / DROP DDL, if any.</span>

<span class="sd">         * The :meth:`.Sequence.create` and :meth:`.Sequence.drop` methods</span>
<span class="sd">           automatically use the engine bound to the :class:`.MetaData`</span>
<span class="sd">           object, if any.</span>

<span class="sd">         * The :meth:`.MetaData.create_all` and :meth:`.MetaData.drop_all`</span>
<span class="sd">           methods will emit CREATE / DROP for this :class:`.Sequence`,</span>
<span class="sd">           even if the :class:`.Sequence` is not associated with any</span>
<span class="sd">           :class:`.Table` / :class:`.Column` that's a member of this</span>
<span class="sd">           :class:`.MetaData`.</span>

<span class="sd">         The above behaviors can only occur if the :class:`.Sequence` is</span>
<span class="sd">         explicitly associated with the :class:`.MetaData` via this parameter.</span>

<span class="sd">         .. seealso::</span>

<span class="sd">            :ref:`sequence_metadata` - full discussion of the</span>
<span class="sd">            :paramref:`.Sequence.metadata` parameter.</span>

<span class="sd">        :param for_update: Indicates this :class:`.Sequence`, when associated</span>
<span class="sd">         with a :class:`.Column`, should be invoked for UPDATE statements</span>
<span class="sd">         on that column's table, rather than for INSERT statements, when</span>
<span class="sd">         no value is otherwise present for that column in the statement.</span>

<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">for_update</span><span class="o">=</span><span class="n">for_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">quoted_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">quote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increment</span> <span class="o">=</span> <span class="n">increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minvalue</span> <span class="o">=</span> <span class="n">minvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxvalue</span> <span class="o">=</span> <span class="n">maxvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominvalue</span> <span class="o">=</span> <span class="n">nominvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nomaxvalue</span> <span class="o">=</span> <span class="n">nomaxvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="n">optional</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="n">BLANK_SCHEMA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">quoted_name</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">quote_schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">is_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">is_clause_element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="s2">"sqlalchemy.sql.functions.func"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">next_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">"""Return a :class:`.next_value` function element</span>
<span class="sd">        which will render the appropriate increment function</span>
<span class="sd">        for this :class:`.Sequence` within any SQL expression.</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">next_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="n">column</span><span class="o">.</span><span class="n">_on_table_attach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metadata</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">_sequences</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Creates this sequence in the database."""</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Drops this sequence from the database."""</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_not_a_column_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
            <span class="s2">"This </span><span class="si">%s</span><span class="s2"> cannot be used directly "</span>
            <span class="s2">"as a column expression.  Use func.next_value(sequence) "</span>
            <span class="s2">"to produce a 'next value' function that's usable "</span>
            <span class="s2">"as a column element."</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">)</span>


<span class="nd">@inspection</span><span class="o">.</span><span class="n">_self_inspects</span>
<span class="k">class</span> <span class="nc">FetchedValue</span><span class="p">(</span><span class="n">_NotAColumnExpr</span><span class="p">,</span> <span class="n">SchemaEventTarget</span><span class="p">):</span>
    <span class="sd">"""A marker for a transparent database-side default.</span>

<span class="sd">    Use :class:`.FetchedValue` when the database is configured</span>
<span class="sd">    to provide some automatic default for a column.</span>

<span class="sd">    E.g.::</span>

<span class="sd">        Column('foo', Integer, FetchedValue())</span>

<span class="sd">    Would indicate that some trigger or default generator</span>
<span class="sd">    will create a new value for the ``foo`` column during an</span>
<span class="sd">    INSERT.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`triggered_columns`</span>

<span class="sd">    """</span>

    <span class="n">is_server_default</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">reflected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">has_argument</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="n">for_update</span>

    <span class="k">def</span> <span class="nf">_as_for_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">for_update</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">for_update</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"column"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="n">for_update</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">server_onupdate</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">server_default</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">generic_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DefaultClause</span><span class="p">(</span><span class="n">FetchedValue</span><span class="p">):</span>
    <span class="sd">"""A DDL-specified DEFAULT column value.</span>

<span class="sd">    :class:`.DefaultClause` is a :class:`.FetchedValue`</span>
<span class="sd">    that also generates a "DEFAULT" clause when</span>
<span class="sd">    "CREATE TABLE" is emitted.</span>

<span class="sd">    :class:`.DefaultClause` is generated automatically</span>
<span class="sd">    whenever the ``server_default``, ``server_onupdate`` arguments of</span>
<span class="sd">    :class:`.Column` are used.  A :class:`.DefaultClause`</span>
<span class="sd">    can be passed positionally as well.</span>

<span class="sd">    For example, the following::</span>

<span class="sd">        Column('foo', Integer, server_default="50")</span>

<span class="sd">    Is equivalent to::</span>

<span class="sd">        Column('foo', Integer, DefaultClause("50"))</span>

<span class="sd">    """</span>

    <span class="n">has_argument</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_reflected</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">util</span><span class="o">.</span><span class="n">assert_arg_type</span><span class="p">(</span>
            <span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ClauseElement</span><span class="p">,</span> <span class="n">TextClause</span><span class="p">),</span> <span class="s2">"arg"</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefaultClause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">for_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflected</span> <span class="o">=</span> <span class="n">_reflected</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"DefaultClause(</span><span class="si">%r</span><span class="s2">, for_update=</span><span class="si">%r</span><span class="s2">)"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">)</span>


<span class="nd">@util</span><span class="o">.</span><span class="n">deprecated_cls</span><span class="p">(</span>
    <span class="s2">"0.6"</span><span class="p">,</span>
    <span class="s2">":class:`.PassiveDefault` is deprecated and will be removed in a "</span>
    <span class="s2">"future release.  Please refer to :class:`.DefaultClause`."</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">PassiveDefault</span><span class="p">(</span><span class="n">DefaultClause</span><span class="p">):</span>
    <span class="sd">"""A DDL-specified DEFAULT column value.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">DefaultClause</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Constraint</span><span class="p">(</span><span class="n">DialectKWArgs</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">"""A table-level SQL constraint."""</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"constraint"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deferrable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initially</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_create_rule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_type_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">dialect_kw</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Create a SQL constraint.</span>

<span class="sd">        :param name:</span>
<span class="sd">          Optional, the in-database name of this ``Constraint``.</span>

<span class="sd">        :param deferrable:</span>
<span class="sd">          Optional bool.  If set, emit DEFERRABLE or NOT DEFERRABLE when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param initially:</span>
<span class="sd">          Optional string.  If set, emit INITIALLY &lt;value&gt; when issuing DDL</span>
<span class="sd">          for this constraint.</span>

<span class="sd">        :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">            :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">            .. versionadded:: 1.0.0</span>

<span class="sd">        :param _create_rule:</span>
<span class="sd">          a callable which is passed the DDLCompiler object during</span>
<span class="sd">          compilation. Returns True or False to signal inline generation of</span>
<span class="sd">          this Constraint.</span>

<span class="sd">          The AddConstraint and DropConstraint DDL constructs provide</span>
<span class="sd">          DDLElement's more comprehensive "conditional DDL" approach that is</span>
<span class="sd">          passed a database connection when DDL is being issued. _create_rule</span>
<span class="sd">          is instead called during any CREATE TABLE compilation, where there</span>
<span class="sd">          may not be any transaction/connection in progress. However, it</span>
<span class="sd">          allows conditional compilation of the constraint even for backends</span>
<span class="sd">          which do not support addition of constraints through ALTER TABLE,</span>
<span class="sd">          which currently includes SQLite.</span>

<span class="sd">          _create_rule is used by some types to create constraints.</span>
<span class="sd">          Currently, its call signature is subject to change at any time.</span>

<span class="sd">        :param \**dialect_kw:  Additional keyword arguments are dialect</span>
<span class="sd">            specific, and passed in the form ``&lt;dialectname&gt;_&lt;argname&gt;``.  See</span>
<span class="sd">            the documentation regarding an individual dialect at</span>
<span class="sd">            :ref:`dialect_toplevel` for detail on documented arguments.</span>

<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span> <span class="o">=</span> <span class="n">deferrable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initially</span> <span class="o">=</span> <span class="n">initially</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_rule</span> <span class="o">=</span> <span class="n">_create_rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type_bound</span> <span class="o">=</span> <span class="n">_type_bound</span>
        <span class="n">util</span><span class="o">.</span><span class="n">set_creation_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dialect_kwargs</span><span class="p">(</span><span class="n">dialect_kw</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
            <span class="s2">"This constraint is not bound to a table.  Did you "</span>
            <span class="s2">"mean to call table.append_constraint(constraint) ?"</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_to_schema_column</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">"__clause_element__"</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="s2">"schema.Column object expected"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">element</span>


<span class="k">def</span> <span class="nf">_to_schema_column_or_string</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">element</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">"__clause_element__"</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span> <span class="o">+</span> <span class="p">(</span><span class="n">ColumnElement</span><span class="p">,)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Element </span><span class="si">%r</span><span class="s2"> is not a string name or column element"</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">element</span>


<span class="k">class</span> <span class="nc">ColumnCollectionMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">"""A :class:`.ColumnCollection` of :class:`.Column` objects.</span>

<span class="sd">    This collection represents the columns which are referred to by</span>
<span class="sd">    this object.</span>

<span class="sd">    """</span>

    <span class="n">_allow_multiple_tables</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">_autoattach</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_autoattach"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_flag</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_column_flag"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ColumnCollection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_to_schema_column_or_string</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">_autoattach</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_attach</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_extract_col_expression_collection</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
            <span class="n">strname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">"__clause_element__"</span><span class="p">):</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="n">ColumnElement</span><span class="p">,</span> <span class="n">TextClause</span><span class="p">)):</span>
                <span class="c1"># this assumes a string</span>
                <span class="n">strname</span> <span class="o">=</span> <span class="n">expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">visitors</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">"column"</span><span class="p">:</span> <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">add_element</span> <span class="o">=</span> <span class="n">column</span> <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">strname</span>
            <span class="k">yield</span> <span class="n">expr</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">strname</span><span class="p">,</span> <span class="n">add_element</span>

    <span class="k">def</span> <span class="nf">_check_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">col_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Column</span><span class="p">)]</span>

        <span class="n">cols_w_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_objs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)]</span>

        <span class="n">cols_wo_table</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">col_objs</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">cols_w_table</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cols_wo_table</span><span class="p">:</span>
            <span class="c1"># feature #3341 - place event listeners for Column objects</span>
            <span class="c1"># such that when all those cols are attached, we autoattach.</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">evt</span><span class="p">,</span> <span class="s2">"Should not reach here on event call"</span>

            <span class="c1"># issue #3411 - don't do the per-column auto-attach if some of the</span>
            <span class="c1"># columns are specified as strings.</span>
            <span class="n">has_string_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">col_objs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_string_cols</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">_col_attached</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
                    <span class="c1"># this isinstance() corresponds with the</span>
                    <span class="c1"># isinstance() above; only want to count Table-bound</span>
                    <span class="c1"># columns</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                        <span class="n">cols_wo_table</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">cols_wo_table</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_check_attach</span><span class="p">(</span><span class="n">evt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_cols_wo_table</span> <span class="o">=</span> <span class="n">cols_wo_table</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_wo_table</span><span class="p">:</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">_on_table_attach</span><span class="p">(</span><span class="n">_col_attached</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="n">cols_w_table</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_multiple_tables</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
            <span class="n">others</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">table</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">others</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"Column(s) </span><span class="si">%s</span><span class="s2"> are not part of table '</span><span class="si">%s</span><span class="s2">'."</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">others</span><span class="p">),</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_col_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="n">col</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_expressions</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ColumnCollectionConstraint</span><span class="p">(</span><span class="n">ColumnCollectionMixin</span><span class="p">,</span> <span class="n">Constraint</span><span class="p">):</span>
    <span class="sd">"""A constraint that proxies a ColumnCollection."""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""</span>
<span class="sd">        :param \*columns:</span>
<span class="sd">          A sequence of column names or Column objects.</span>

<span class="sd">        :param name:</span>
<span class="sd">          Optional, the in-database name of this constraint.</span>

<span class="sd">        :param deferrable:</span>
<span class="sd">          Optional bool.  If set, emit DEFERRABLE or NOT DEFERRABLE when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param initially:</span>
<span class="sd">          Optional string.  If set, emit INITIALLY &lt;value&gt; when issuing DDL</span>
<span class="sd">          for this constraint.</span>

<span class="sd">        :param \**kw: other keyword arguments including dialect-specific</span>
<span class="sd">          arguments are propagated to the :class:`.Constraint` superclass.</span>

<span class="sd">        """</span>
        <span class="n">_autoattach</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_autoattach"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">_column_flag</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_column_flag"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">Constraint</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="n">_autoattach</span><span class="o">=</span><span class="n">_autoattach</span><span class="p">,</span> <span class="n">_column_flag</span><span class="o">=</span><span class="n">_column_flag</span>
        <span class="p">)</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">"""A :class:`.ColumnCollection` representing the set of columns</span>
<span class="sd">    for this constraint.</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">Constraint</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
            <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_item_copy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contains_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">"""Return True if this constraint contains the given column.</span>

<span class="sd">        Note that this object also contains an attribute ``.columns``</span>
<span class="sd">        which is a :class:`.ColumnCollection` of :class:`.Column` objects.</span>

<span class="sd">        """</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># inlining of</span>
        <span class="c1"># return iter(self.columns)</span>
        <span class="c1"># ColumnCollection-&gt;OrderedProperties-&gt;OrderedDict</span>
        <span class="n">ordered_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">_data</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ordered_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ordered_dict</span><span class="o">.</span><span class="n">_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CheckConstraint</span><span class="p">(</span><span class="n">ColumnCollectionConstraint</span><span class="p">):</span>
    <span class="sd">"""A table- or column-level CHECK constraint.</span>

<span class="sd">    Can be included in the definition of a Table or Column.</span>
<span class="sd">    """</span>

    <span class="n">_allow_multiple_tables</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@_document_text_coercion</span><span class="p">(</span>
        <span class="s2">"sqltext"</span><span class="p">,</span>
        <span class="s2">":class:`.CheckConstraint`"</span><span class="p">,</span>
        <span class="s2">":paramref:`.CheckConstraint.sqltext`"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sqltext</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deferrable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initially</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_create_rule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_autoattach</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_type_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Construct a CHECK constraint.</span>

<span class="sd">        :param sqltext:</span>
<span class="sd">         A string containing the constraint definition, which will be used</span>
<span class="sd">         verbatim, or a SQL expression construct.   If given as a string,</span>
<span class="sd">         the object is converted to a :func:`.text` object. If the textual</span>
<span class="sd">         string includes a colon character, escape this using a backslash::</span>

<span class="sd">           CheckConstraint(r"foo ~ E'a(?\:b|c)d")</span>

<span class="sd">        :param name:</span>
<span class="sd">          Optional, the in-database name of the constraint.</span>

<span class="sd">        :param deferrable:</span>
<span class="sd">          Optional bool.  If set, emit DEFERRABLE or NOT DEFERRABLE when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param initially:</span>
<span class="sd">          Optional string.  If set, emit INITIALLY &lt;value&gt; when issuing DDL</span>
<span class="sd">          for this constraint.</span>

<span class="sd">        :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">            :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">            .. versionadded:: 1.0.0</span>

<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span> <span class="o">=</span> <span class="n">_literal_as_text</span><span class="p">(</span><span class="n">sqltext</span><span class="p">,</span> <span class="n">allow_coercion_to_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visitors</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">"column"</span><span class="p">:</span> <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">})</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CheckConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">deferrable</span><span class="o">=</span><span class="n">deferrable</span><span class="p">,</span>
            <span class="n">initially</span><span class="o">=</span><span class="n">initially</span><span class="p">,</span>
            <span class="n">_create_rule</span><span class="o">=</span><span class="n">_create_rule</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">_type_bound</span><span class="o">=</span><span class="n">_type_bound</span><span class="p">,</span>
            <span class="n">_autoattach</span><span class="o">=</span><span class="n">_autoattach</span><span class="p">,</span>
            <span class="o">*</span><span class="n">columns</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__visit_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">"check_constraint"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"column_check_constraint"</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">__visit_name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">target_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sqltext</span> <span class="o">=</span> <span class="n">_copy_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">target_table</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sqltext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">CheckConstraint</span><span class="p">(</span>
            <span class="n">sqltext</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
            <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
            <span class="n">_create_rule</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_rule</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">target_table</span><span class="p">,</span>
            <span class="n">_autoattach</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">_type_bound</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_bound</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_item_copy</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ForeignKeyConstraint</span><span class="p">(</span><span class="n">ColumnCollectionConstraint</span><span class="p">):</span>
    <span class="sd">"""A table-level FOREIGN KEY constraint.</span>

<span class="sd">    Defines a single column or composite FOREIGN KEY ... REFERENCES</span>
<span class="sd">    constraint. For a no-frills, single column foreign key, adding a</span>
<span class="sd">    :class:`.ForeignKey` to the definition of a :class:`.Column` is a</span>
<span class="sd">    shorthand equivalent for an unnamed, single column</span>
<span class="sd">    :class:`.ForeignKeyConstraint`.</span>

<span class="sd">    Examples of foreign key configuration are in :ref:`metadata_foreignkeys`.</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"foreign_key_constraint"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">,</span>
        <span class="n">refcolumns</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">onupdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ondelete</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deferrable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initially</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_alter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">link_to_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">dialect_kw</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Construct a composite-capable FOREIGN KEY.</span>

<span class="sd">        :param columns: A sequence of local column names. The named columns</span>
<span class="sd">          must be defined and present in the parent Table. The names should</span>
<span class="sd">          match the ``key`` given to each column (defaults to the name) unless</span>
<span class="sd">          ``link_to_name`` is True.</span>

<span class="sd">        :param refcolumns: A sequence of foreign column names or Column</span>
<span class="sd">          objects. The columns must all be located within the same Table.</span>

<span class="sd">        :param name: Optional, the in-database name of the key.</span>

<span class="sd">        :param onupdate: Optional string. If set, emit ON UPDATE &lt;value&gt; when</span>
<span class="sd">          issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">          DELETE and RESTRICT.</span>

<span class="sd">        :param ondelete: Optional string. If set, emit ON DELETE &lt;value&gt; when</span>
<span class="sd">          issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">          DELETE and RESTRICT.</span>

<span class="sd">        :param deferrable: Optional bool. If set, emit DEFERRABLE or NOT</span>
<span class="sd">          DEFERRABLE when issuing DDL for this constraint.</span>

<span class="sd">        :param initially: Optional string. If set, emit INITIALLY &lt;value&gt; when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param link_to_name: if True, the string name given in ``column`` is</span>
<span class="sd">          the rendered name of the referenced column, not its locally assigned</span>
<span class="sd">          ``key``.</span>

<span class="sd">        :param use_alter: If True, do not emit the DDL for this constraint as</span>
<span class="sd">          part of the CREATE TABLE definition. Instead, generate it via an</span>
<span class="sd">          ALTER TABLE statement issued after the full collection of tables</span>
<span class="sd">          have been created, and drop it via an ALTER TABLE statement before</span>
<span class="sd">          the full collection of tables are dropped.</span>

<span class="sd">          The use of :paramref:`.ForeignKeyConstraint.use_alter` is</span>
<span class="sd">          particularly geared towards the case where two or more tables</span>
<span class="sd">          are established within a mutually-dependent foreign key constraint</span>
<span class="sd">          relationship; however, the :meth:`.MetaData.create_all` and</span>
<span class="sd">          :meth:`.MetaData.drop_all` methods will perform this resolution</span>
<span class="sd">          automatically, so the flag is normally not needed.</span>

<span class="sd">          .. versionchanged:: 1.0.0  Automatic resolution of foreign key</span>
<span class="sd">             cycles has been added, removing the need to use the</span>
<span class="sd">             :paramref:`.ForeignKeyConstraint.use_alter` in typical use</span>
<span class="sd">             cases.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">                :ref:`use_alter`</span>

<span class="sd">        :param match: Optional string. If set, emit MATCH &lt;value&gt; when issuing</span>
<span class="sd">          DDL for this constraint. Typical values include SIMPLE, PARTIAL</span>
<span class="sd">          and FULL.</span>

<span class="sd">        :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">            :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">            .. versionadded:: 1.0.0</span>

<span class="sd">        :param \**dialect_kw:  Additional keyword arguments are dialect</span>
<span class="sd">          specific, and passed in the form ``&lt;dialectname&gt;_&lt;argname&gt;``.  See</span>
<span class="sd">          the documentation regarding an individual dialect at</span>
<span class="sd">          :ref:`dialect_toplevel` for detail on documented arguments.</span>

<span class="sd">            .. versionadded:: 0.9.2</span>

<span class="sd">        """</span>

        <span class="n">Constraint</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">deferrable</span><span class="o">=</span><span class="n">deferrable</span><span class="p">,</span>
            <span class="n">initially</span><span class="o">=</span><span class="n">initially</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dialect_kw</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="n">onupdate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="n">ondelete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span> <span class="o">=</span> <span class="n">link_to_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span> <span class="o">=</span> <span class="n">use_alter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">refcolumns</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
                <span class="c1"># e.g. FOREIGN KEY (a, a) REFERENCES r (b, c)</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"ForeignKeyConstraint with duplicate source column "</span>
                    <span class="s2">"references are not supported."</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># e.g. FOREIGN KEY (a) REFERENCES r (b, c)</span>
                <span class="c1"># paraphrasing https://www.postgresql.org/docs/9.2/static/\</span>
                <span class="c1"># ddl-constraints.html</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"ForeignKeyConstraint number "</span>
                    <span class="s2">"of constrained columns must match the number of "</span>
                    <span class="s2">"referenced columns."</span>
                <span class="p">)</span>

        <span class="c1"># standalone ForeignKeyConstraint - create</span>
        <span class="c1"># associated ForeignKey objects which will be applied to hosted</span>
        <span class="c1"># Column objects (in col.foreign_keys), either now or when attached</span>
        <span class="c1"># to the Table for string-specified names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ForeignKey</span><span class="p">(</span>
                <span class="n">refcol</span><span class="p">,</span>
                <span class="n">_constraint</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
                <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
                <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span>
                <span class="n">link_to_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">,</span>
                <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">,</span>
                <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
                <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect_kwargs</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">refcol</span> <span class="ow">in</span> <span class="n">refcolumns</span>
        <span class="p">]</span>

        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"parent"</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">table</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_append_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">fk</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">"""A :class:`.ColumnCollection` representing the set of columns</span>
<span class="sd">    for this constraint.</span>

<span class="sd">    """</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">"""A sequence of :class:`.ForeignKey` objects.</span>

<span class="sd">    Each :class:`.ForeignKey` represents a single referring column/referred</span>
<span class="sd">    column pair.</span>

<span class="sd">    This collection is intended to be read-only.</span>

<span class="sd">    """</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># legacy - provide a dictionary view of (column_key, fk)</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_referred_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">elem</span><span class="o">.</span><span class="n">_referred_schema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">referred_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""The :class:`.Table` object to which this</span>
<span class="sd">        :class:`.ForeignKeyConstraint` references.</span>

<span class="sd">        This is a dynamically calculated attribute which may not be available</span>
<span class="sd">        if the constraint and/or parent table is not yet associated with</span>
<span class="sd">        a metadata collection that contains the referred table.</span>

<span class="sd">        .. versionadded:: 1.0.0</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span>

    <span class="k">def</span> <span class="nf">_validate_dest_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">table_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">elem</span><span class="o">.</span><span class="n">_table_key</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">])</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_keys</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">table_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">elem0</span><span class="p">,</span> <span class="n">elem1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">table_keys</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"ForeignKeyConstraint on </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">) refers to "</span>
                <span class="s2">"multiple remote tables: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_description</span><span class="p">,</span> <span class="n">elem0</span><span class="p">,</span> <span class="n">elem1</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return a list of string keys representing the local</span>
<span class="sd">        columns in this :class:`.ForeignKeyConstraint`.</span>

<span class="sd">        This list is either the original string arguments sent</span>
<span class="sd">        to the constructor of the :class:`.ForeignKeyConstraint`,</span>
<span class="sd">        or if the constraint has been initialized with :class:`.Column`</span>
<span class="sd">        objects, is the string .key of each element.</span>

<span class="sd">        .. versionadded:: 1.0.0</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"parent"</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">col</span><span class="o">.</span><span class="n">key</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">ColumnElement</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span>
            <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_col_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">Constraint</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ColumnCollectionConstraint</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Can't create ForeignKeyConstraint "</span>
                <span class="s2">"on table '</span><span class="si">%s</span><span class="s2">': no column "</span>
                <span class="s2">"named '</span><span class="si">%s</span><span class="s2">' is present."</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">ke</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">fk</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fk</span><span class="p">,</span> <span class="s2">"parent"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fk</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">col</span><span class="p">:</span>
                <span class="n">fk</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dest_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">fkc</span> <span class="o">=</span> <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">],</span>
            <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">_get_colspec</span><span class="p">(</span>
                    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                    <span class="n">table_name</span><span class="o">=</span><span class="n">target_table</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">target_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">_table_key</span><span class="p">()</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">key</span>
                    <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
            <span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
            <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
            <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span>
            <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
            <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
            <span class="n">link_to_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">,</span>
            <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">self_fk</span><span class="p">,</span> <span class="n">other_fk</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="n">fkc</span><span class="o">.</span><span class="n">elements</span><span class="p">):</span>
            <span class="n">self_fk</span><span class="o">.</span><span class="n">_schema_item_copy</span><span class="p">(</span><span class="n">other_fk</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_item_copy</span><span class="p">(</span><span class="n">fkc</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">ColumnCollectionConstraint</span><span class="p">):</span>
    <span class="sd">"""A table-level PRIMARY KEY constraint.</span>

<span class="sd">    The :class:`.PrimaryKeyConstraint` object is present automatically</span>
<span class="sd">    on any :class:`.Table` object; it is assigned a set of</span>
<span class="sd">    :class:`.Column` objects corresponding to those marked with</span>
<span class="sd">    the :paramref:`.Column.primary_key` flag::</span>

<span class="sd">        &gt;&gt;&gt; my_table = Table('mytable', metadata,</span>
<span class="sd">        ...                 Column('id', Integer, primary_key=True),</span>
<span class="sd">        ...                 Column('version_id', Integer, primary_key=True),</span>
<span class="sd">        ...                 Column('data', String(50))</span>
<span class="sd">        ...     )</span>
<span class="sd">        &gt;&gt;&gt; my_table.primary_key</span>
<span class="sd">        PrimaryKeyConstraint(</span>
<span class="sd">            Column('id', Integer(), table=&lt;mytable&gt;,</span>
<span class="sd">                   primary_key=True, nullable=False),</span>
<span class="sd">            Column('version_id', Integer(), table=&lt;mytable&gt;,</span>
<span class="sd">                   primary_key=True, nullable=False)</span>
<span class="sd">        )</span>

<span class="sd">    The primary key of a :class:`.Table` can also be specified by using</span>
<span class="sd">    a :class:`.PrimaryKeyConstraint` object explicitly; in this mode of usage,</span>
<span class="sd">    the "name" of the constraint can also be specified, as well as other</span>
<span class="sd">    options which may be recognized by dialects::</span>

<span class="sd">        my_table = Table('mytable', metadata,</span>
<span class="sd">                    Column('id', Integer),</span>
<span class="sd">                    Column('version_id', Integer),</span>
<span class="sd">                    Column('data', String(50)),</span>
<span class="sd">                    PrimaryKeyConstraint('id', 'version_id',</span>
<span class="sd">                                         name='mytable_pk')</span>
<span class="sd">                )</span>

<span class="sd">    The two styles of column-specification should generally not be mixed.</span>
<span class="sd">    An warning is emitted if the columns present in the</span>
<span class="sd">    :class:`.PrimaryKeyConstraint`</span>
<span class="sd">    don't match the columns that were marked as ``primary_key=True``, if both</span>
<span class="sd">    are present; in this case, the columns are taken strictly from the</span>
<span class="sd">    :class:`.PrimaryKeyConstraint` declaration, and those columns otherwise</span>
<span class="sd">    marked as ``primary_key=True`` are ignored.  This behavior is intended to</span>
<span class="sd">    be backwards compatible with previous behavior.</span>

<span class="sd">    .. versionchanged:: 0.9.2  Using a mixture of columns within a</span>
<span class="sd">       :class:`.PrimaryKeyConstraint` in addition to columns marked as</span>
<span class="sd">       ``primary_key=True`` now emits a warning if the lists don't match.</span>
<span class="sd">       The ultimate behavior of ignoring those columns marked with the flag</span>
<span class="sd">       only is currently maintained for backwards compatibility; this warning</span>
<span class="sd">       may raise an exception in a future release.</span>

<span class="sd">    For the use case where specific options are to be specified on the</span>
<span class="sd">    :class:`.PrimaryKeyConstraint`, but the usual style of using</span>
<span class="sd">    ``primary_key=True`` flags is still desirable, an empty</span>
<span class="sd">    :class:`.PrimaryKeyConstraint` may be specified, which will take on the</span>
<span class="sd">    primary key column collection from the :class:`.Table` based on the</span>
<span class="sd">    flags::</span>

<span class="sd">        my_table = Table('mytable', metadata,</span>
<span class="sd">                    Column('id', Integer, primary_key=True),</span>
<span class="sd">                    Column('version_id', Integer, primary_key=True),</span>
<span class="sd">                    Column('data', String(50)),</span>
<span class="sd">                    PrimaryKeyConstraint(name='mytable_pk',</span>
<span class="sd">                                         mssql_clustered=True)</span>
<span class="sd">                )</span>

<span class="sd">    .. versionadded:: 0.9.2 an empty :class:`.PrimaryKeyConstraint` may now</span>
<span class="sd">       be specified for the purposes of establishing keyword arguments with</span>
<span class="sd">       the constraint, independently of the specification of "primary key"</span>
<span class="sd">       columns within the :class:`.Table` itself; columns marked as</span>
<span class="sd">       ``primary_key=True`` will be gathered into the empty constraint's</span>
<span class="sd">       column collection.</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"primary_key_constraint"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_implicit_generated</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_implicit_generated"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrimaryKeyConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrimaryKeyConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">table_pks</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">columns</span>
            <span class="ow">and</span> <span class="n">table_pks</span>
            <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">"Table '</span><span class="si">%s</span><span class="s2">' specifies columns </span><span class="si">%s</span><span class="s2"> as primary_key=True, "</span>
                <span class="s2">"not matching locally specified columns </span><span class="si">%s</span><span class="s2">; setting the "</span>
                <span class="s2">"current primary key columns to </span><span class="si">%s</span><span class="s2">. This warning "</span>
                <span class="s2">"may become an exception in a future release"</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table_pks</span><span class="p">),</span>
                    <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                    <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">table_pks</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">c</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">table_pks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">"""repopulate this :class:`.PrimaryKeyConstraint` given</span>
<span class="sd">        a set of columns.</span>

<span class="sd">        Existing columns in the table that are marked as primary_key=True</span>
<span class="sd">        are maintained.</span>

<span class="sd">        Also fires a new event.</span>

<span class="sd">        This is basically like putting a whole new</span>
<span class="sd">        :class:`.PrimaryKeyConstraint` object on the parent</span>
<span class="sd">        :class:`.Table` object without actually replacing the object.</span>

<span class="sd">        The ordering of the given list of columns is also maintained; these</span>
<span class="sd">        columns will be appended to the list of columns after any which</span>
<span class="sd">        are already present.</span>

<span class="sd">        """</span>

        <span class="c1"># set the primary key flag on new columns.</span>
        <span class="c1"># note any existing PK cols on the table also have their</span>
        <span class="c1"># flag still set.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">col</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">PrimaryKeyConstraint</span><span class="o">.</span><span class="n">_autoincrement_column</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">PrimaryKeyConstraint</span><span class="o">.</span><span class="n">_autoincrement_column</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns_autoinc_first</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">autoinc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autoincrement_column</span>

        <span class="k">if</span> <span class="n">autoinc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">autoinc</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">autoinc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">_autoincrement_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_validate_autoinc</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">autoinc_true</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_type_affinity</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span>
                <span class="n">col</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_type_affinity</span><span class="p">,</span> <span class="n">type_api</span><span class="o">.</span><span class="n">INTEGERTYPE</span><span class="o">.</span><span class="n">_type_affinity</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">autoinc_true</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s2">"Column type </span><span class="si">%s</span><span class="s2"> on column '</span><span class="si">%s</span><span class="s2">' is not "</span>
                        <span class="s2">"compatible with autoincrement=True"</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">Sequence</span><span class="p">))</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">autoinc_true</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">autoinc_true</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">autoincrement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="s2">"ignore_fk"</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">autoincrement</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">_validate_autoinc</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">col</span>
            <span class="k">elif</span> <span class="n">col</span><span class="o">.</span><span class="n">autoincrement</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">"auto"</span><span class="p">,</span>
                <span class="s2">"ignore_fk"</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">_validate_autoinc</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">col</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">autoinc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">autoincrement</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">_validate_autoinc</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">autoinc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                            <span class="s2">"Only one Column may be marked "</span>
                            <span class="s2">"autoincrement=True, found both </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">autoinc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">autoinc</span> <span class="o">=</span> <span class="n">col</span>

            <span class="k">return</span> <span class="n">autoinc</span>


<span class="k">class</span> <span class="nc">UniqueConstraint</span><span class="p">(</span><span class="n">ColumnCollectionConstraint</span><span class="p">):</span>
    <span class="sd">"""A table-level UNIQUE constraint.</span>

<span class="sd">    Defines a single column or composite UNIQUE constraint. For a no-frills,</span>
<span class="sd">    single column constraint, adding ``unique=True`` to the ``Column``</span>
<span class="sd">    definition is a shorthand equivalent for an unnamed, single column</span>
<span class="sd">    UniqueConstraint.</span>
<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"unique_constraint"</span>


<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">DialectKWArgs</span><span class="p">,</span> <span class="n">ColumnCollectionMixin</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">"""A table-level INDEX.</span>

<span class="sd">    Defines a composite (one or more column) INDEX.</span>

<span class="sd">    E.g.::</span>

<span class="sd">        sometable = Table("sometable", metadata,</span>
<span class="sd">                        Column("name", String(50)),</span>
<span class="sd">                        Column("address", String(100))</span>
<span class="sd">                    )</span>

<span class="sd">        Index("some_index", sometable.c.name)</span>

<span class="sd">    For a no-frills, single column index, adding</span>
<span class="sd">    :class:`.Column` also supports ``index=True``::</span>

<span class="sd">        sometable = Table("sometable", metadata,</span>
<span class="sd">                        Column("name", String(50), index=True)</span>
<span class="sd">                    )</span>

<span class="sd">    For a composite index, multiple columns can be specified::</span>

<span class="sd">        Index("some_index", sometable.c.name, sometable.c.address)</span>

<span class="sd">    Functional indexes are supported as well, typically by using the</span>
<span class="sd">    :data:`.func` construct in conjunction with table-bound</span>
<span class="sd">    :class:`.Column` objects::</span>

<span class="sd">        Index("some_index", func.lower(sometable.c.name))</span>

<span class="sd">    An :class:`.Index` can also be manually associated with a :class:`.Table`,</span>
<span class="sd">    either through inline declaration or using</span>
<span class="sd">    :meth:`.Table.append_constraint`.  When this approach is used, the names</span>
<span class="sd">    of the indexed columns can be specified as strings::</span>

<span class="sd">        Table("sometable", metadata,</span>
<span class="sd">                        Column("name", String(50)),</span>
<span class="sd">                        Column("address", String(100)),</span>
<span class="sd">                        Index("some_index", "name", "address")</span>
<span class="sd">                )</span>

<span class="sd">    To support functional or expression-based indexes in this form, the</span>
<span class="sd">    :func:`.text` construct may be used::</span>

<span class="sd">        from sqlalchemy import text</span>

<span class="sd">        Table("sometable", metadata,</span>
<span class="sd">                        Column("name", String(50)),</span>
<span class="sd">                        Column("address", String(100)),</span>
<span class="sd">                        Index("some_index", text("lower(name)"))</span>
<span class="sd">                )</span>

<span class="sd">    .. versionadded:: 0.9.5 the :func:`.text` construct may be used to</span>
<span class="sd">       specify :class:`.Index` expressions, provided the :class:`.Index`</span>
<span class="sd">       is explicitly associated with the :class:`.Table`.</span>


<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`schema_indexes` - General information on :class:`.Index`.</span>

<span class="sd">        :ref:`postgresql_indexes` - PostgreSQL-specific options available for</span>
<span class="sd">        the :class:`.Index` construct.</span>

<span class="sd">        :ref:`mysql_indexes` - MySQL-specific options available for the</span>
<span class="sd">        :class:`.Index` construct.</span>

<span class="sd">        :ref:`mssql_indexes` - MSSQL-specific options available for the</span>
<span class="sd">        :class:`.Index` construct.</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"index"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Construct an index object.</span>

<span class="sd">        :param name:</span>
<span class="sd">          The name of the index</span>

<span class="sd">        :param \*expressions:</span>
<span class="sd">          Column expressions to include in the index.   The expressions</span>
<span class="sd">          are normally instances of :class:`.Column`, but may also</span>
<span class="sd">          be arbitrary SQL expressions which ultimately refer to a</span>
<span class="sd">          :class:`.Column`.</span>

<span class="sd">        :param unique=False:</span>
<span class="sd">            Keyword only argument; if True, create a unique index.</span>

<span class="sd">        :param quote=None:</span>
<span class="sd">            Keyword only argument; whether to apply quoting to the name of</span>
<span class="sd">            the index.  Works in the same manner as that of</span>
<span class="sd">            :paramref:`.Column.quote`.</span>

<span class="sd">        :param info=None: Optional data dictionary which will be populated</span>
<span class="sd">            into the :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">            .. versionadded:: 1.0.0</span>

<span class="sd">        :param \**kw: Additional keyword arguments not mentioned above are</span>
<span class="sd">            dialect specific, and passed in the form</span>
<span class="sd">            ``&lt;dialectname&gt;_&lt;argname&gt;``. See the documentation regarding an</span>
<span class="sd">            individual dialect at :ref:`dialect_toplevel` for detail on</span>
<span class="sd">            documented arguments.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">processed_expressions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">expr</span><span class="p">,</span>
            <span class="n">column</span><span class="p">,</span>
            <span class="n">strname</span><span class="p">,</span>
            <span class="n">add_element</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_col_expression_collection</span><span class="p">(</span><span class="n">expressions</span><span class="p">):</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_element</span><span class="p">)</span>
            <span class="n">processed_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="n">processed_expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">quoted_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"quote"</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"unique"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">_column_flag</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_column_flag"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"info"</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"info"</span><span class="p">)</span>

        <span class="c1"># TODO: consider "table" argument being public, but for</span>
        <span class="c1"># the purpose of the fix here, it starts as private.</span>
        <span class="k">if</span> <span class="s2">"_table"</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"_table"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_dialect_kwargs</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

        <span class="c1"># will call _set_parent() if table-bound column</span>
        <span class="c1"># objects are present</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="n">_column_flag</span><span class="o">=</span><span class="n">_column_flag</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">"Index '</span><span class="si">%s</span><span class="s2">' is against table '</span><span class="si">%s</span><span class="s2">', and "</span>
                <span class="s2">"cannot be associated with table '</span><span class="si">%s</span><span class="s2">'."</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="n">table</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">expressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span>
        <span class="n">col_expressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_expressions</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">expressions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_expressions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">expr</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ClauseElement</span><span class="p">)</span> <span class="k">else</span> <span class="n">colexpr</span>
            <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">colexpr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">col_expressions</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the connectable associated with this Index."""</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">bind</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Issue a ``CREATE`` statement for this</span>
<span class="sd">        :class:`.Index`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`.MetaData.create_all`.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Issue a ``DROP`` statement for this</span>
<span class="sd">        :class:`.Index`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`.MetaData.drop_all`.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"Index(</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
                <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="ow">and</span> <span class="p">[</span><span class="s2">"unique=True"</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="n">DEFAULT_NAMING_CONVENTION</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">({</span><span class="s2">"ix"</span><span class="p">:</span> <span class="s2">"ix_</span><span class="si">%(column_0_label)s</span><span class="s2">"</span><span class="p">})</span>


<span class="k">class</span> <span class="nc">MetaData</span><span class="p">(</span><span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">"""A collection of :class:`.Table` objects and their associated schema</span>
<span class="sd">    constructs.</span>

<span class="sd">    Holds a collection of :class:`.Table` objects as well as</span>
<span class="sd">    an optional binding to an :class:`.Engine` or</span>
<span class="sd">    :class:`.Connection`.  If bound, the :class:`.Table` objects</span>
<span class="sd">    in the collection and their columns may participate in implicit SQL</span>
<span class="sd">    execution.</span>

<span class="sd">    The :class:`.Table` objects themselves are stored in the</span>
<span class="sd">    :attr:`.MetaData.tables` dictionary.</span>

<span class="sd">    :class:`.MetaData` is a thread-safe object for read operations.</span>
<span class="sd">    Construction of new tables within a single :class:`.MetaData` object,</span>
<span class="sd">    either explicitly or via reflection, may not be completely thread-safe.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`metadata_describing` - Introduction to database metadata</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"metadata"</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated_params</span><span class="p">(</span>
        <span class="n">reflect</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">"0.8"</span><span class="p">,</span>
            <span class="s2">"The :paramref:`.MetaData.reflect` flag is deprecated and will "</span>
            <span class="s2">"be removed in a future release.   Please use the "</span>
            <span class="s2">":meth:`.MetaData.reflect` method."</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">reflect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">quote_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">naming_convention</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">"""Create a new MetaData object.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          An Engine or Connection to bind to.  May also be a string or URL</span>
<span class="sd">          instance, these are passed to create_engine() and this MetaData will</span>
<span class="sd">          be bound to the resulting engine.</span>

<span class="sd">        :param reflect:</span>
<span class="sd">          Optional, automatically load all tables from the bound database.</span>
<span class="sd">          Defaults to False. ``bind`` is required when this option is set.</span>

<span class="sd">        :param schema:</span>
<span class="sd">           The default schema to use for the :class:`.Table`,</span>
<span class="sd">           :class:`.Sequence`, and potentially other objects associated with</span>
<span class="sd">           this :class:`.MetaData`. Defaults to ``None``.</span>

<span class="sd">           When this value is set, any :class:`.Table` or :class:`.Sequence`</span>
<span class="sd">           which specifies ``None`` for the schema parameter will instead</span>
<span class="sd">           have this schema name defined.  To build a :class:`.Table`</span>
<span class="sd">           or :class:`.Sequence` that still has ``None`` for the schema</span>
<span class="sd">           even when this parameter is present, use the :attr:`.BLANK_SCHEMA`</span>
<span class="sd">           symbol.</span>

<span class="sd">           .. note::</span>

<span class="sd">                As referred above, the :paramref:`.MetaData.schema` parameter</span>
<span class="sd">                only refers to the **default value** that will be applied to</span>
<span class="sd">                the :paramref:`.Table.schema` parameter of an incoming</span>
<span class="sd">                :class:`.Table` object.   It does not refer to how the</span>
<span class="sd">                :class:`.Table` is catalogued within the :class:`.MetaData`,</span>
<span class="sd">                which remains consistent vs. a :class:`.MetaData` collection</span>
<span class="sd">                that does not define this parameter.  The :class:`.Table`</span>
<span class="sd">                within the :class:`.MetaData` will still be keyed based on its</span>
<span class="sd">                schema-qualified name, e.g.</span>
<span class="sd">                ``my_metadata.tables["some_schema.my_table"]``.</span>

<span class="sd">                The current behavior of the :class:`.ForeignKey` object is to</span>
<span class="sd">                circumvent this restriction, where it can locate a table given</span>
<span class="sd">                the table name alone, where the schema will be assumed to be</span>
<span class="sd">                present from this value as specified on the owning</span>
<span class="sd">                :class:`.MetaData` collection.  However, this implies  that a</span>
<span class="sd">                table qualified with BLANK_SCHEMA cannot currently be referred</span>
<span class="sd">                to by string name from :class:`.ForeignKey`.    Other parts of</span>
<span class="sd">                SQLAlchemy such as Declarative may not have similar behaviors</span>
<span class="sd">                built in, however may do so in a future release, along with a</span>
<span class="sd">                consistent method of referring to a table in BLANK_SCHEMA.</span>


<span class="sd">           .. seealso::</span>

<span class="sd">                :paramref:`.Table.schema`</span>

<span class="sd">                :paramref:`.Sequence.schema`</span>

<span class="sd">        :param quote_schema:</span>
<span class="sd">            Sets the ``quote_schema`` flag for those :class:`.Table`,</span>
<span class="sd">            :class:`.Sequence`, and other objects which make usage of the</span>
<span class="sd">            local ``schema`` name.</span>

<span class="sd">        :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">            :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">            .. versionadded:: 1.0.0</span>

<span class="sd">        :param naming_convention: a dictionary referring to values which</span>
<span class="sd">          will establish default naming conventions for :class:`.Constraint`</span>
<span class="sd">          and :class:`.Index` objects, for those objects which are not given</span>
<span class="sd">          a name explicitly.</span>

<span class="sd">          The keys of this dictionary may be:</span>

<span class="sd">          * a constraint or Index class, e.g. the :class:`.UniqueConstraint`,</span>
<span class="sd">            :class:`.ForeignKeyConstraint` class, the :class:`.Index` class</span>

<span class="sd">          * a string mnemonic for one of the known constraint classes;</span>
<span class="sd">            ``"fk"``, ``"pk"``, ``"ix"``, ``"ck"``, ``"uq"`` for foreign key,</span>
<span class="sd">            primary key, index, check, and unique constraint, respectively.</span>

<span class="sd">          * the string name of a user-defined "token" that can be used</span>
<span class="sd">            to define new naming tokens.</span>

<span class="sd">          The values associated with each "constraint class" or "constraint</span>
<span class="sd">          mnemonic" key are string naming templates, such as</span>
<span class="sd">          ``"uq_%(table_name)s_%(column_0_name)s"``,</span>
<span class="sd">          which describe how the name should be composed.  The values</span>
<span class="sd">          associated with user-defined "token" keys should be callables of the</span>
<span class="sd">          form ``fn(constraint, table)``, which accepts the constraint/index</span>
<span class="sd">          object and :class:`.Table` as arguments, returning a string</span>
<span class="sd">          result.</span>

<span class="sd">          The built-in names are as follows, some of which may only be</span>
<span class="sd">          available for certain types of constraint:</span>

<span class="sd">            * ``%(table_name)s`` - the name of the :class:`.Table` object</span>
<span class="sd">              associated with the constraint.</span>

<span class="sd">            * ``%(referred_table_name)s`` - the name of the :class:`.Table`</span>
<span class="sd">              object associated with the referencing target of a</span>
<span class="sd">              :class:`.ForeignKeyConstraint`.</span>

<span class="sd">            * ``%(column_0_name)s`` - the name of the :class:`.Column` at</span>
<span class="sd">              index position "0" within the constraint.</span>

<span class="sd">            * ``%(column_0N_name)s`` - the name of all :class:`.Column`</span>
<span class="sd">              objects in order within the constraint, joined without a</span>
<span class="sd">              separator.</span>

<span class="sd">            * ``%(column_0_N_name)s`` - the name of all :class:`.Column`</span>
<span class="sd">              objects in order within the constraint, joined with an</span>
<span class="sd">              underscore as a separator.</span>

<span class="sd">            * ``%(column_0_label)s``, ``%(column_0N_label)s``,</span>
<span class="sd">              ``%(column_0_N_label)s`` - the label of either the zeroth</span>
<span class="sd">              :class:`.Column` or all :class:`.Columns`, separated with</span>
<span class="sd">              or without an underscore</span>

<span class="sd">            * ``%(column_0_key)s``, ``%(column_0N_key)s``,</span>
<span class="sd">              ``%(column_0_N_key)s`` - the key of either the zeroth</span>
<span class="sd">              :class:`.Column` or all :class:`.Columns`, separated with</span>
<span class="sd">              or without an underscore</span>

<span class="sd">            * ``%(referred_column_0_name)s``, ``%(referred_column_0N_name)s``</span>
<span class="sd">              ``%(referred_column_0_N_name)s``,  ``%(referred_column_0_key)s``,</span>
<span class="sd">              ``%(referred_column_0N_key)s``, ...  column tokens which</span>
<span class="sd">              render the names/keys/labels of columns that are referenced</span>
<span class="sd">              by a  :class:`.ForeignKeyConstraint`.</span>

<span class="sd">            * ``%(constraint_name)s`` - a special key that refers to the</span>
<span class="sd">              existing name given to the constraint.  When this key is</span>
<span class="sd">              present, the :class:`.Constraint` object's existing name will be</span>
<span class="sd">              replaced with one that is composed from template string that</span>
<span class="sd">              uses this token. When this token is present, it is required that</span>
<span class="sd">              the :class:`.Constraint` is given an explicit name ahead of time.</span>

<span class="sd">            * user-defined: any additional token may be implemented by passing</span>
<span class="sd">              it along with a ``fn(constraint, table)`` callable to the</span>
<span class="sd">              naming_convention dictionary.</span>

<span class="sd">          .. versionadded:: 1.3.0 - added new ``%(column_0N_name)s``,</span>
<span class="sd">             ``%(column_0_N_name)s``, and related tokens that produce</span>
<span class="sd">             concatenations of names, keys, or labels for all columns referred</span>
<span class="sd">             to by a given constraint.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">                :ref:`constraint_naming_conventions` - for detailed usage</span>
<span class="sd">                examples.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">quoted_name</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">quote_schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naming_convention</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">naming_convention</span>
            <span class="k">if</span> <span class="n">naming_convention</span>
            <span class="k">else</span> <span class="n">DEFAULT_NAMING_CONVENTION</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fk_memos</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>
        <span class="k">if</span> <span class="n">reflect</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bind</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s2">"A bind must be supplied in conjunction "</span>
                    <span class="s2">"with reflect=True"</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reflect</span><span class="p">()</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">"""A dictionary of :class:`.Table` objects keyed to their name or "table key".</span>

<span class="sd">    The exact key is that determined by the :attr:`.Table.key` attribute;</span>
<span class="sd">    for a table with no :attr:`.Table.schema` attribute, this is the same</span>
<span class="sd">    as :attr:`.Table.name`.  For a table with a schema, it is typically of the</span>
<span class="sd">    form ``schemaname.tablename``.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :attr:`.MetaData.sorted_tables`</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"MetaData(bind=</span><span class="si">%r</span><span class="s2">)"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_or_key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_or_key</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">table_or_key</span> <span class="o">=</span> <span class="n">table_or_key</span><span class="o">.</span><span class="n">key</span>
        <span class="k">return</span> <span class="n">table_or_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>

    <span class="k">def</span> <span class="nf">_add_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">removed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">removed</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
                <span class="n">fk</span><span class="o">.</span><span class="n">_remove_from_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">schema</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"tables"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span>
            <span class="s2">"schema"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
            <span class="s2">"schemas"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="p">,</span>
            <span class="s2">"sequences"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span><span class="p">,</span>
            <span class="s2">"fk_memos"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fk_memos</span><span class="p">,</span>
            <span class="s2">"naming_convention"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">naming_convention</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">"tables"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">"schema"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naming_convention</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">"naming_convention"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">"sequences"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">"schemas"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fk_memos</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">"fk_memos"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">is_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""True if this MetaData is bound to an Engine or Connection."""</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""An :class:`.Engine` or :class:`.Connection` to which this</span>
<span class="sd">        :class:`.MetaData` is bound.</span>

<span class="sd">        Typically, a :class:`.Engine` is assigned to this attribute</span>
<span class="sd">        so that "implicit execution" may be used, or alternatively</span>
<span class="sd">        as a means of providing engine binding information to an</span>
<span class="sd">        ORM :class:`.Session` object::</span>

<span class="sd">            engine = create_engine("someurl://")</span>
<span class="sd">            metadata.bind = engine</span>

<span class="sd">        .. seealso::</span>

<span class="sd">           :ref:`dbengine_implicit` - background on "bound metadata"</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="s2">"sqlalchemy.engine.url"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_bind_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">bind</span><span class="p">):</span>
        <span class="sd">"""Bind this MetaData to an Engine, Connection, string or URL."""</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span> <span class="o">+</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">URL</span><span class="p">,)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="n">bind</span>

    <span class="n">bind</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">_bind_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Clear all Table objects from this MetaData."""</span>

        <span class="nb">dict</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fk_memos</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">"""Remove the given Table object from this MetaData."""</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_table</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sorted_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Returns a list of :class:`.Table` objects sorted in order of</span>
<span class="sd">        foreign key dependency.</span>

<span class="sd">        The sorting will place :class:`.Table` objects that have dependencies</span>
<span class="sd">        first, before the dependencies themselves, representing the</span>
<span class="sd">        order in which they can be created.   To get the order in which</span>
<span class="sd">        the tables would be dropped, use the ``reversed()`` Python built-in.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The :attr:`.sorted_tables` accessor cannot by itself accommodate</span>
<span class="sd">            automatic resolution of dependency cycles between tables, which</span>
<span class="sd">            are usually caused by mutually dependent foreign key constraints.</span>
<span class="sd">            To resolve these cycles, either the</span>
<span class="sd">            :paramref:`.ForeignKeyConstraint.use_alter` parameter may be</span>
<span class="sd">            applied to those constraints, or use the</span>
<span class="sd">            :func:`.schema.sort_tables_and_constraints` function which will</span>
<span class="sd">            break out foreign key constraints involved in cycles separately.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :func:`.schema.sort_tables`</span>

<span class="sd">            :func:`.schema.sort_tables_and_constraints`</span>

<span class="sd">            :attr:`.MetaData.tables`</span>

<span class="sd">            :meth:`.Inspector.get_table_names`</span>

<span class="sd">            :meth:`.Inspector.get_sorted_table_and_fkc_names`</span>


<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">ddl</span><span class="o">.</span><span class="n">sort_tables</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">reflect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">views</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extend_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">autoload_replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">resolve_fks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">dialect_kwargs</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""Load all available table definitions from the database.</span>

<span class="sd">        Automatically creates ``Table`` entries in this ``MetaData`` for any</span>
<span class="sd">        table available in the database but not yet present in the</span>
<span class="sd">        ``MetaData``.  May be called multiple times to pick up tables recently</span>
<span class="sd">        added to the database, however no special action is taken if a table</span>
<span class="sd">        in this ``MetaData`` no longer exists in the database.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          A :class:`.Connectable` used to access the database; if None, uses</span>
<span class="sd">          the existing bind on this ``MetaData``, if any.</span>

<span class="sd">        :param schema:</span>
<span class="sd">          Optional, query and reflect tables from an alternate schema.</span>
<span class="sd">          If None, the schema associated with this :class:`.MetaData`</span>
<span class="sd">          is used, if any.</span>

<span class="sd">        :param views:</span>
<span class="sd">          If True, also reflect views.</span>

<span class="sd">        :param only:</span>
<span class="sd">          Optional.  Load only a sub-set of available named tables.  May be</span>
<span class="sd">          specified as a sequence of names or a callable.</span>

<span class="sd">          If a sequence of names is provided, only those tables will be</span>
<span class="sd">          reflected.  An error is raised if a table is requested but not</span>
<span class="sd">          available.  Named tables already present in this ``MetaData`` are</span>
<span class="sd">          ignored.</span>

<span class="sd">          If a callable is provided, it will be used as a boolean predicate to</span>
<span class="sd">          filter the list of potential table names.  The callable is called</span>
<span class="sd">          with a table name and this ``MetaData`` instance as positional</span>
<span class="sd">          arguments and should return a true value for any table to reflect.</span>

<span class="sd">        :param extend_existing: Passed along to each :class:`.Table` as</span>
<span class="sd">          :paramref:`.Table.extend_existing`.</span>

<span class="sd">          .. versionadded:: 0.9.1</span>

<span class="sd">        :param autoload_replace: Passed along to each :class:`.Table` as</span>
<span class="sd">          :paramref:`.Table.autoload_replace`.</span>

<span class="sd">          .. versionadded:: 0.9.1</span>

<span class="sd">        :param resolve_fks: if True, reflect :class:`.Table` objects linked</span>
<span class="sd">         to :class:`.ForeignKey` objects located in each :class:`.Table`.</span>
<span class="sd">         For :meth:`.MetaData.reflect`, this has the effect of reflecting</span>
<span class="sd">         related tables that might otherwise not be in the list of tables</span>
<span class="sd">         being reflected, for example if the referenced table is in a</span>
<span class="sd">         different schema or is omitted via the</span>
<span class="sd">         :paramref:`.MetaData.reflect.only` parameter.  When False,</span>
<span class="sd">         :class:`.ForeignKey` objects are not followed to the :class:`.Table`</span>
<span class="sd">         in which they link, however if the related table is also part of the</span>
<span class="sd">         list of tables that would be reflected in any case, the</span>
<span class="sd">         :class:`.ForeignKey` object will still resolve to its related</span>
<span class="sd">         :class:`.Table` after the :meth:`.MetaData.reflect` operation is</span>
<span class="sd">         complete.   Defaults to True.</span>

<span class="sd">         .. versionadded:: 1.3.0</span>

<span class="sd">         .. seealso::</span>

<span class="sd">            :paramref:`.Table.resolve_fks`</span>

<span class="sd">        :param \**dialect_kwargs: Additional keyword arguments not mentioned</span>
<span class="sd">         above are dialect specific, and passed in the form</span>
<span class="sd">         ``&lt;dialectname&gt;_&lt;argname&gt;``.  See the documentation regarding an</span>
<span class="sd">         individual dialect at :ref:`dialect_toplevel` for detail on</span>
<span class="sd">         documented arguments.</span>

<span class="sd">          .. versionadded:: 0.9.2 - Added</span>
<span class="sd">             :paramref:`.MetaData.reflect.**dialect_kwargs` to support</span>
<span class="sd">             dialect-level reflection options for all :class:`.Table`</span>
<span class="sd">             objects reflected.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">bind</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

            <span class="n">reflect_opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"autoload"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">"autoload_with"</span><span class="p">:</span> <span class="n">conn</span><span class="p">,</span>
                <span class="s2">"extend_existing"</span><span class="p">:</span> <span class="n">extend_existing</span><span class="p">,</span>
                <span class="s2">"autoload_replace"</span><span class="p">:</span> <span class="n">autoload_replace</span><span class="p">,</span>
                <span class="s2">"resolve_fks"</span><span class="p">:</span> <span class="n">resolve_fks</span><span class="p">,</span>
                <span class="s2">"_extend_on"</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="n">reflect_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dialect_kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>

            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reflect_opts</span><span class="p">[</span><span class="s2">"schema"</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span>

            <span class="n">available</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">(</span>
                <span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">table_names</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">views</span><span class="p">:</span>
                <span class="n">available</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">get_view_names</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">available_w_schema</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">"</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">available</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">available_w_schema</span> <span class="o">=</span> <span class="n">available</span>

            <span class="n">current</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">only</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">load</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">name</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">available</span><span class="p">,</span> <span class="n">available_w_schema</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">extend_existing</span> <span class="ow">or</span> <span class="n">schname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">util</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="n">only</span><span class="p">):</span>
                <span class="n">load</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">name</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">available</span><span class="p">,</span> <span class="n">available_w_schema</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">extend_existing</span> <span class="ow">or</span> <span class="n">schname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">only</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">only</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">" schema '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">schema</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">""</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                        <span class="s2">"Could not reflect: requested table(s) not available "</span>
                        <span class="s2">"in </span><span class="si">%r%s</span><span class="s2">: (</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="n">load</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">name</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">only</span>
                    <span class="k">if</span> <span class="n">extend_existing</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span>
                <span class="p">]</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">load</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">reflect_opts</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnreflectableTableError</span> <span class="k">as</span> <span class="n">uerr</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Skipping table </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uerr</span><span class="p">))</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
        <span class="s2">"0.7"</span><span class="p">,</span>
        <span class="s2">"the :meth:`.MetaData.append_ddl_listener` method is deprecated and "</span>
        <span class="s2">"will be removed in a future release.  Please refer to "</span>
        <span class="s2">":class:`.DDLEvents`."</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">append_ddl_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
        <span class="sd">"""Append a DDL event listener to this ``MetaData``.</span>


<span class="sd">        """</span>

        <span class="k">def</span> <span class="nf">adapt_listener</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">"tables"</span><span class="p">]</span>
            <span class="n">listener</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">)</span>

        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">""</span> <span class="o">+</span> <span class="n">event_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"-"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">),</span> <span class="n">adapt_listener</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Create all tables stored in this metadata.</span>

<span class="sd">        Conditional by default, will not attempt to recreate tables already</span>
<span class="sd">        present in the target database.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          A :class:`.Connectable` used to access the</span>
<span class="sd">          database; if None, uses the existing bind on this ``MetaData``, if</span>
<span class="sd">          any.</span>

<span class="sd">        :param tables:</span>
<span class="sd">          Optional list of ``Table`` objects, which is a subset of the total</span>
<span class="sd">          tables in the ``MetaData`` (others are ignored).</span>

<span class="sd">        :param checkfirst:</span>
<span class="sd">          Defaults to True, don't issue CREATEs for tables already present</span>
<span class="sd">          in the target database.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">tables</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""Drop all tables stored in this metadata.</span>

<span class="sd">        Conditional by default, will not attempt to drop tables not present in</span>
<span class="sd">        the target database.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          A :class:`.Connectable` used to access the</span>
<span class="sd">          database; if None, uses the existing bind on this ``MetaData``, if</span>
<span class="sd">          any.</span>

<span class="sd">        :param tables:</span>
<span class="sd">          Optional list of ``Table`` objects, which is a subset of the</span>
<span class="sd">          total tables in the ``MetaData`` (others are ignored).</span>

<span class="sd">        :param checkfirst:</span>
<span class="sd">          Defaults to True, only issue DROPs for tables confirmed to be</span>
<span class="sd">          present in the target database.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span>
            <span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">tables</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ThreadLocalMetaData</span><span class="p">(</span><span class="n">MetaData</span><span class="p">):</span>
    <span class="sd">"""A MetaData variant that presents a different ``bind`` in every thread.</span>

<span class="sd">    Makes the ``bind`` property of the MetaData a thread-local value, allowing</span>
<span class="sd">    this collection of tables to be bound to different ``Engine``</span>
<span class="sd">    implementations or connections in each thread.</span>

<span class="sd">    The ThreadLocalMetaData starts off bound to None in each thread.  Binds</span>
<span class="sd">    must be made explicitly by assigning to the ``bind`` property or using</span>
<span class="sd">    ``connect()``.  You can also re-bind dynamically multiple times per</span>
<span class="sd">    thread, just like a regular ``MetaData``.</span>

<span class="sd">    """</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">"metadata"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Construct a ThreadLocalMetaData."""</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadLocalMetaData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""The bound Engine or Connection for this thread.</span>

<span class="sd">        This property may be assigned an Engine or Connection, or assigned a</span>
<span class="sd">        string or URL to automatically create a basic Engine for this bind</span>
<span class="sd">        with ``create_engine()``."""</span>

        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">"_engine"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="s2">"sqlalchemy.engine.url"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_bind_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">bind</span><span class="p">):</span>
        <span class="sd">"""Bind to a Connectable in the caller's thread."""</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span> <span class="o">+</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">URL</span><span class="p">,)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">[</span><span class="n">bind</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">[</span><span class="n">bind</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: this is squirrely.  we shouldn't have to hold onto engines</span>
            <span class="c1"># in a case like this</span>
            <span class="k">if</span> <span class="n">bind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">[</span><span class="n">bind</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">bind</span>

    <span class="n">bind</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">_bind_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""True if there is a bind for this thread."""</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">"_engine"</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Dispose all bound engines, in all thread contexts."""</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">"dispose"</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_SchemaTranslateMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""Provide translation of schema names based on a mapping.</span>

<span class="sd">    Also provides helpers for producing cache keys and optimized</span>
<span class="sd">    access when no mapping is present.</span>

<span class="sd">    Used by the :paramref:`.Connection.execution_options.schema_translate_map`</span>
<span class="sd">    feature.</span>

<span class="sd">    .. versionadded:: 1.1</span>


<span class="sd">    """</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">"map_"</span><span class="p">,</span> <span class="s2">"__call__"</span><span class="p">,</span> <span class="s2">"hash_key"</span><span class="p">,</span> <span class="s2">"is_default"</span>

    <span class="n">_default_schema_getter</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">"schema"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_</span> <span class="o">=</span> <span class="n">map_</span>
        <span class="k">if</span> <span class="n">map_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">schema_for_object</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="n">effective_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_schema_getter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">effective_schema</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_translate_schema</span><span class="p">(</span>
                    <span class="n">effective_schema</span><span class="p">,</span> <span class="n">map_</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">effective_schema</span>

            <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="n">schema_for_object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span> <span class="o">=</span> <span class="s2">";"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">"</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">map_</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">map_</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_default</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_schema_getter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_default</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_schema_getter</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">map_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">map_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_default_schema_map</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_</span><span class="p">,</span> <span class="n">_SchemaTranslateMap</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SchemaTranslateMap</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>


<span class="n">_default_schema_map</span> <span class="o">=</span> <span class="n">_SchemaTranslateMap</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">_schema_getter</span> <span class="o">=</span> <span class="n">_SchemaTranslateMap</span><span class="o">.</span><span class="n">_schema_getter</span>
</pre></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Ax</a></h1>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ax.html">ax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark.html">ax.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core.html">ax.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../exceptions.html">ax.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics.html">ax.metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modelbridge.html">ax.modelbridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">ax.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot.html">ax.plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../runners.html">ax.runners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../service.html">ax.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">ax.storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">ax.utils</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="../../../index.html">Documentation overview</a><ul>
<li><a href="../../index.html">Module code</a><ul>
</ul></li>
</ul></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" name="q" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div></div></div><footer class="nav-footer" id="footer"><a href="https://code.facebook.com/projects/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/versions/0.1.6/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2019 Facebook Inc.</section></footer></div></body></html>