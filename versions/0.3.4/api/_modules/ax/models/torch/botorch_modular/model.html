<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Ax · Adaptive Experimentation Platform</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Adaptive Experimentation Platform"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Ax · Adaptive Experimentation Platform"/><meta property="og:type" content="website"/><meta property="og:url" content="https://ax.dev//versions/0.3.4/index.html"/><meta property="og:description" content="Adaptive Experimentation Platform"/><meta property="og:image" content="https://ax.dev//versions/0.3.4/img/ax.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://ax.dev//versions/0.3.4/img/ax.svg"/><link rel="shortcut icon" href="/versions/0.3.4/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-139570076-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script><script type="text/javascript" src="/versions/0.3.4/js/plotUtils.js"></script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/versions/0.3.4/js/mathjax.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/versions/0.3.4/js/scrollSpy.js"></script><link rel="stylesheet" href="/versions/0.3.4/css/main.css"/><script src="/versions/0.3.4/js/codetabs.js"></script></head><body><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/versions/0.3.4/"><img class="logo" src="/versions/0.3.4/img/ax_lockup_white.svg" alt="Ax"/><h2 class="headerTitleWithLogo">Ax</h2></a><a href="/versions/0.3.4/versions.html"><h3>0.3.4</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/versions/0.3.4/docs/why-ax.html" target="_self">Docs</a></li><li class=""><a href="/versions/0.3.4/tutorials/" target="_self">Tutorials</a></li><li class=""><a href="/versions/0.3.4/api/" target="_self">API</a></li><li class=""><a href="https://github.com/facebook/Ax" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div>
<script type="text/javascript" id="documentation_options" data-url_root="./"
src="/js/documentation_options.js">
</script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/doctools.js"></script>
<script type="text/javascript" src="/js/language_data.js"></script>
<script type="text/javascript" src="/js/searchtools.js"></script>
<div class="sphinx"><div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for ax.models.torch.botorch_modular.model</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">ax.core.search_space</span> <span class="kn">import</span> <span class="n">SearchSpaceDigest</span>
<span class="kn">from</span> <span class="nn">ax.core.types</span> <span class="kn">import</span> <span class="n">TCandidateMetadata</span><span class="p">,</span> <span class="n">TGenMetadata</span>
<span class="kn">from</span> <span class="nn">ax.exceptions.core</span> <span class="kn">import</span> <span class="n">UnsupportedError</span><span class="p">,</span> <span class="n">UserInputError</span>
<span class="kn">from</span> <span class="nn">ax.models.torch.botorch</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_feature_importances_from_botorch_model</span><span class="p">,</span>
    <span class="n">get_rounding_func</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ax.models.torch.botorch_modular.acquisition</span> <span class="kn">import</span> <span class="n">Acquisition</span>
<span class="kn">from</span> <span class="nn">ax.models.torch.botorch_modular.surrogate</span> <span class="kn">import</span> <span class="n">Surrogate</span>
<span class="kn">from</span> <span class="nn">ax.models.torch.botorch_modular.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">choose_botorch_acqf_class</span><span class="p">,</span>
    <span class="n">construct_acquisition_and_optimizer_options</span><span class="p">,</span>
    <span class="n">convert_to_block_design</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ax.models.torch.utils</span> <span class="kn">import</span> <span class="n">_to_inequality_constraints</span>
<span class="kn">from</span> <span class="nn">ax.models.torch_base</span> <span class="kn">import</span> <span class="n">TorchGenResults</span><span class="p">,</span> <span class="n">TorchModel</span><span class="p">,</span> <span class="n">TorchOptConfig</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.base</span> <span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.constants</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.docutils</span> <span class="kn">import</span> <span class="n">copy_doc</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.typeutils</span> <span class="kn">import</span> <span class="n">checked_cast</span>
<span class="kn">from</span> <span class="nn">botorch.acquisition.acquisition</span> <span class="kn">import</span> <span class="n">AcquisitionFunction</span>
<span class="kn">from</span> <span class="nn">botorch.models</span> <span class="kn">import</span> <span class="n">ModelList</span>
<span class="kn">from</span> <span class="nn">botorch.models.deterministic</span> <span class="kn">import</span> <span class="n">FixedSingleSampleModel</span>
<span class="kn">from</span> <span class="nn">botorch.models.model</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">botorch.models.transforms.input</span> <span class="kn">import</span> <span class="n">InputTransform</span>
<span class="kn">from</span> <span class="nn">botorch.models.transforms.outcome</span> <span class="kn">import</span> <span class="n">OutcomeTransform</span>
<span class="kn">from</span> <span class="nn">botorch.utils.datasets</span> <span class="kn">import</span> <span class="n">SupervisedDataset</span>
<span class="kn">from</span> <span class="nn">gpytorch.kernels.kernel</span> <span class="kn">import</span> <span class="n">Kernel</span>
<span class="kn">from</span> <span class="nn">gpytorch.likelihoods</span> <span class="kn">import</span> <span class="n">Likelihood</span>
<span class="kn">from</span> <span class="nn">gpytorch.mlls.exact_marginal_log_likelihood</span> <span class="kn">import</span> <span class="n">ExactMarginalLogLikelihood</span>
<span class="kn">from</span> <span class="nn">gpytorch.mlls.marginal_log_likelihood</span> <span class="kn">import</span> <span class="n">MarginalLogLikelihood</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"T"</span><span class="p">)</span>


<div class="viewcode-block" id="single_surrogate_only"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.single_surrogate_only">[docs]</a><span class="k">def</span> <span class="nf">single_surrogate_only</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    For use as a decorator on functions only implemented for BotorchModels with a</span>
<span class="sd">    single Surrogate.</span>
<span class="sd">    """</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">impl</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">"BoTorchModel"</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> not implemented for multi-surrogate case. Found "</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="si">=}</span><span class="s2">."</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">impl</span></div>


<div class="viewcode-block" id="SurrogateSpec"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.SurrogateSpec">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SurrogateSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Fields in the SurrogateSpec dataclass correspond to arguments in</span>
<span class="sd">    ``Surrogate.__init__``, except for ``outcomes`` which is used to specify which</span>
<span class="sd">    outcomes the Surrogate is responsible for modeling.</span>
<span class="sd">    When ``BotorchModel.fit`` is called, these fields will be used to construct the</span>
<span class="sd">    requisite Surrogate objects.</span>
<span class="sd">    If ``outcomes`` is left empty then no outcomes will be fit to the Surrogate.</span>
<span class="sd">    """</span>

    <span class="n">botorch_model_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Model</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">botorch_model_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">mll_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MarginalLogLikelihood</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExactMarginalLogLikelihood</span>
    <span class="n">mll_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">covar_module_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Kernel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">covar_module_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">likelihood_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Likelihood</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">likelihood_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">input_transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InputTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">outcome_transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OutcomeTransform</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">allow_batched_models</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">outcomes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoTorchModel"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel">[docs]</a><span class="k">class</span> <span class="nc">BoTorchModel</span><span class="p">(</span><span class="n">TorchModel</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""**All classes in 'botorch_modular' directory are under</span>
<span class="sd">    construction, incomplete, and should be treated as alpha</span>
<span class="sd">    versions only.**</span>

<span class="sd">    Modular `Model` class for combining BoTorch subcomponents</span>
<span class="sd">    in Ax. Specified via `Surrogate` and `Acquisition`, which wrap</span>
<span class="sd">    BoTorch `Model` and `AcquisitionFunction`, respectively, for</span>
<span class="sd">    convenient use in Ax.</span>

<span class="sd">    Args:</span>
<span class="sd">        acquisition_class: Type of `Acquisition` to be used in</span>
<span class="sd">            this model, auto-selected based on experiment and data</span>
<span class="sd">            if not specified.</span>
<span class="sd">        acquisition_options: Optional dict of kwargs, passed to</span>
<span class="sd">            the constructor of BoTorch `AcquisitionFunction`.</span>
<span class="sd">        botorch_acqf_class: Type of `AcquisitionFunction` to be</span>
<span class="sd">            used in this model, auto-selected based on experiment</span>
<span class="sd">            and data if not specified.</span>
<span class="sd">        surrogate_specs: Optional Mapping of names onto SurrogateSpecs, which specify</span>
<span class="sd">            how to initialize specific Surrogates to model specific outcomes. If None</span>
<span class="sd">            is provided a single Surrogate will be created and set up automatically</span>
<span class="sd">            based on the data provided.</span>
<span class="sd">        surrogate: In liu of SurrogateSpecs, an instance of `Surrogate` may be</span>
<span class="sd">            provided to be used as the sole Surrogate for all outcomes</span>
<span class="sd">        refit_on_update: Whether to reoptimize model parameters during call</span>
<span class="sd">            to `BoTorchModel.update`. If false, training data for the model</span>
<span class="sd">            (used for inference) is still swapped for new training data, but</span>
<span class="sd">            model parameters are not reoptimized.</span>
<span class="sd">        refit_on_cv: Whether to reoptimize model parameters during call to</span>
<span class="sd">            `BoTorchmodel.cross_validate`.</span>
<span class="sd">        warm_start_refit: Whether to load parameters from either the provided</span>
<span class="sd">            state dict or the state dict of the current BoTorch `Model` during</span>
<span class="sd">            refitting. If False, model parameters will be reoptimized from</span>
<span class="sd">            scratch on refit. NOTE: This setting is ignored during `update` or</span>
<span class="sd">            `cross_validate` if the corresponding `refit_on_...` is False.</span>
<span class="sd">    """</span>

    <span class="n">acquisition_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Acquisition</span><span class="p">]</span>
    <span class="n">acquisition_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="n">surrogate_specs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SurrogateSpec</span><span class="p">]</span>
    <span class="n">_surrogates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Surrogate</span><span class="p">]</span>

    <span class="n">_botorch_acqf_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">AcquisitionFunction</span><span class="p">]]</span>
    <span class="n">_search_space_digest</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SearchSpaceDigest</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_supports_robust_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">surrogate_specs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SurrogateSpec</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">surrogate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Surrogate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">acquisition_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Acquisition</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">acquisition_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">botorch_acqf_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">AcquisitionFunction</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">refit_on_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">refit_on_cv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">warm_start_refit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Ensure only surrogate_specs or surrogate is provided</span>
        <span class="k">if</span> <span class="n">surrogate_specs</span> <span class="ow">and</span> <span class="n">surrogate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserInputError</span><span class="p">(</span>
                <span class="s2">"Only one of `surrogate_specs` and `surrogate` arguments is expected."</span>
            <span class="p">)</span>

        <span class="c1"># Ensure each outcome is only modeled by one Surrogate in the SurrogateSpecs</span>
        <span class="k">if</span> <span class="n">surrogate_specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outcomes_by_surrogate_label</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">label</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">outcomes</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">surrogate_specs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span> <span class="k">for</span> <span class="n">outcomes</span> <span class="ow">in</span> <span class="n">outcomes_by_surrogate_label</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="o">*</span><span class="n">outcomes_by_surrogate_label</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
                <span class="k">raise</span> <span class="n">UserInputError</span><span class="p">(</span>
                    <span class="s2">"Each outcome may be modeled by only one Surrogate, found "</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">outcomes_by_surrogate_label</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

        <span class="c1"># Ensure user does not use reserved Surrogate labels</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">surrogate_specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span>
                <span class="p">{</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="p">,</span> <span class="n">Keys</span><span class="o">.</span><span class="n">AUTOSET_SURROGATE</span><span class="p">}</span> <span class="o">-</span> <span class="n">surrogate_specs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">&lt;</span> <span class="mi">2</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserInputError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"SurrogateSpecs may not be labeled </span><span class="si">{</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="si">}</span><span class="s2"> or "</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">Keys</span><span class="o">.</span><span class="n">AUTOSET_SURROGATE</span><span class="si">}</span><span class="s2">, these are reserved."</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_specs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">surrogate_specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_specs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SurrogateSpec</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">label</span><span class="p">:</span> <span class="n">spec</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">surrogate_specs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">surrogate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span> <span class="o">=</span> <span class="p">{</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="p">:</span> <span class="n">surrogate</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_class</span> <span class="o">=</span> <span class="n">acquisition_class</span> <span class="ow">or</span> <span class="n">Acquisition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_options</span> <span class="o">=</span> <span class="n">acquisition_options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_botorch_acqf_class</span> <span class="o">=</span> <span class="n">botorch_acqf_class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">refit_on_update</span> <span class="o">=</span> <span class="n">refit_on_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refit_on_cv</span> <span class="o">=</span> <span class="n">refit_on_cv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warm_start_refit</span> <span class="o">=</span> <span class="n">warm_start_refit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">surrogates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Surrogate</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Surrogates by label"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span>

    <span class="nd">@property</span>
    <span class="nd">@single_surrogate_only</span>
    <span class="k">def</span> <span class="nf">surrogate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Surrogate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Surrogate, if there is only one."""</span>

        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="nd">@property</span>
    <span class="nd">@single_surrogate_only</span>
    <span class="k">def</span> <span class="nf">Xs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""A list of tensors, each of shape ``batch_shape x n_i x d``,</span>
<span class="sd">        where `n_i` is the number of training inputs for the i-th model.</span>

<span class="sd">        NOTE: This is an accessor for ``self.surrogate.Xs``</span>
<span class="sd">        and returns it unchanged.</span>
<span class="sd">        """</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogate</span><span class="o">.</span><span class="n">Xs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">botorch_acqf_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">AcquisitionFunction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""BoTorch ``AcquisitionFunction`` class, associated with this model.</span>
<span class="sd">        Raises an error if one is not yet set.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_botorch_acqf_class</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"BoTorch `AcquisitionFunction` has not yet been set."</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_botorch_acqf_class</span>

<div class="viewcode-block" id="BoTorchModel.fit"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SupervisedDataset</span><span class="p">],</span>
        <span class="n">metric_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">search_space_digest</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">,</span>
        <span class="n">candidate_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">TCandidateMetadata</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># state dict by surrogate label</span>
        <span class="n">state_dicts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">refit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Fit model to m outcomes.</span>

<span class="sd">        Args:</span>
<span class="sd">            datasets: A list of ``SupervisedDataset`` containers, each</span>
<span class="sd">                corresponding to the data of one metric (outcome).</span>
<span class="sd">            metric_names: A list of metric names, with the i-th metric</span>
<span class="sd">                corresponding to the i-th dataset.</span>
<span class="sd">            search_space_digest: A ``SearchSpaceDigest`` object containing</span>
<span class="sd">                metadata on the features in the datasets.</span>
<span class="sd">            candidate_metadata: Model-produced metadata for candidates, in</span>
<span class="sd">                the order corresponding to the Xs.</span>
<span class="sd">            state_dicts: Optional state dict to load by model label as passed in via</span>
<span class="sd">                surrogate_specs. If using a single, pre-instantiated model use</span>
<span class="sd">                `Keys.ONLY_SURROGATE.</span>
<span class="sd">            refit: Whether to re-optimize model parameters.</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Length of datasets and metric_names must match, but your inputs "</span>
                <span class="sa">f</span><span class="s2">"are of lengths </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)</span><span class="si">}</span><span class="s2">, "</span>
                <span class="s2">"respectively."</span>
            <span class="p">)</span>

        <span class="c1"># Store search space info for later use (e.g. during generation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_digest</span> <span class="o">=</span> <span class="n">search_space_digest</span>

        <span class="c1"># Step 0. If the user passed in a preconstructed surrogate we won't have a</span>
        <span class="c1"># SurrogateSpec and must assume we're fitting all metrics</span>
        <span class="k">if</span> <span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span><span class="p">[</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
                <span class="n">metric_names</span><span class="o">=</span><span class="n">metric_names</span><span class="p">,</span>
                <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
                <span class="n">candidate_metadata</span><span class="o">=</span><span class="n">candidate_metadata</span><span class="p">,</span>
                <span class="n">state_dict</span><span class="o">=</span><span class="n">state_dicts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">state_dicts</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">refit</span><span class="o">=</span><span class="n">refit</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Step 1. Initialize a Surrogate for every SurrogateSpec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">Surrogate</span><span class="p">(</span>
                <span class="c1"># if None, Surrogate will autoset class per outcome at construct time</span>
                <span class="n">botorch_model_class</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">botorch_model_class</span><span class="p">,</span>
                <span class="n">model_options</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">botorch_model_kwargs</span><span class="p">,</span>
                <span class="n">mll_class</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">mll_class</span><span class="p">,</span>
                <span class="n">mll_options</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">mll_kwargs</span><span class="p">,</span>
                <span class="n">covar_module_class</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">covar_module_class</span><span class="p">,</span>
                <span class="n">covar_module_options</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">covar_module_kwargs</span><span class="p">,</span>
                <span class="n">likelihood_class</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">likelihood_class</span><span class="p">,</span>
                <span class="n">likelihood_options</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">likelihood_kwargs</span><span class="p">,</span>
                <span class="n">input_transform</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">input_transform</span><span class="p">,</span>
                <span class="n">outcome_transform</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">outcome_transform</span><span class="p">,</span>
                <span class="n">allow_batched_models</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">allow_batched_models</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_specs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># Step 1.5. If any outcomes are not explicitly assigned to a Surrogate, create</span>
        <span class="c1"># a new Surrogate for all these metrics (which will autoset its botorch model</span>
        <span class="c1"># class per outcome) UNLESS there is only one SurrogateSpec with no outcomes</span>
        <span class="c1"># assigned to it, in which case that will be used for all metrics.</span>
        <span class="n">assigned_metric_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">item</span>
            <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">outcomes</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_specs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span>
        <span class="p">}</span>
        <span class="n">unassigned_metric_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">metric_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assigned_metric_names</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unassigned_metric_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span><span class="p">[</span><span class="n">Keys</span><span class="o">.</span><span class="n">AUTOSET_SURROGATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">Surrogate</span><span class="p">()</span>

        <span class="c1"># Step 2. Fit each Surrogate iteratively using its assigned outcomes</span>
        <span class="n">datasets_by_metric_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">metric_names</span><span class="p">,</span> <span class="n">datasets</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surrogate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">Keys</span><span class="o">.</span><span class="n">AUTOSET_SURROGATE</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">subset_metric_names</span> <span class="o">=</span> <span class="n">unassigned_metric_names</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subset_metric_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_specs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outcomes</span>

            <span class="n">subset_datasets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">datasets_by_metric_name</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">subset_metric_names</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">subset_datasets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="c1"># if Surrogate's model is none a ModelList will be autoset</span>
                <span class="ow">and</span> <span class="n">surrogate</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surrogate</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">ModelList</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># Note: If the datasets do not confirm to a block design then this</span>
                <span class="c1"># will filter the data and drop observations to make sure that it does.</span>
                <span class="c1"># This can happen e.g. if only some metrics are observed at some points</span>
                <span class="n">subset_datasets</span><span class="p">,</span> <span class="n">metric_names</span> <span class="o">=</span> <span class="n">convert_to_block_design</span><span class="p">(</span>
                    <span class="n">datasets</span><span class="o">=</span><span class="n">subset_datasets</span><span class="p">,</span>
                    <span class="n">metric_names</span><span class="o">=</span><span class="n">metric_names</span><span class="p">,</span>
                    <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">surrogate</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">=</span><span class="n">subset_datasets</span><span class="p">,</span>
                <span class="n">metric_names</span><span class="o">=</span><span class="n">subset_metric_names</span><span class="p">,</span>
                <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
                <span class="n">candidate_metadata</span><span class="o">=</span><span class="n">candidate_metadata</span><span class="p">,</span>
                <span class="n">state_dict</span><span class="o">=</span><span class="p">(</span><span class="n">state_dicts</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
                <span class="n">refit</span><span class="o">=</span><span class="n">refit</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BoTorchModel.update"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.update">[docs]</a>    <span class="nd">@copy_doc</span><span class="p">(</span><span class="n">TorchModel</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">SupervisedDataset</span><span class="p">]],</span>
        <span class="n">metric_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">search_space_digest</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">,</span>
        <span class="n">candidate_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">TCandidateMetadata</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedError</span><span class="p">(</span><span class="s2">"Cannot update model that has not been fitted."</span><span class="p">)</span>

        <span class="c1"># store search space info  for later use (e.g. during generation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_digest</span> <span class="o">=</span> <span class="n">search_space_digest</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surrogate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Sometimes the model fit should be restarted from scratch on update, for</span>
            <span class="c1"># models that are prone to overfitting. In those cases,</span>
            <span class="c1"># `self.warm_start_refit` should be false and `Surrogate.update` will not</span>
            <span class="c1"># receive a state dict and will not pass it to the underlying</span>
            <span class="c1"># `Surrogate.fit`.</span>

            <span class="n">state_dict</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refit_on_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_start_refit</span>
                <span class="k">else</span> <span class="n">surrogate</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UnsupportedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.update requires data for all outcomes."</span>
                <span class="p">)</span>

            <span class="c1"># Only update each Surrogate on its own metrics unless it was the</span>
            <span class="c1"># preconstructed Surrogate</span>
            <span class="n">datasets_by_metric_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">metric_names</span><span class="p">,</span> <span class="n">datasets</span><span class="p">))</span>
            <span class="n">subset_metric_names</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_specs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outcomes</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="p">,</span> <span class="n">Keys</span><span class="o">.</span><span class="n">AUTOSET_SURROGATE</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">metric_names</span>
            <span class="p">)</span>
            <span class="n">subset_datasets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">datasets_by_metric_name</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">subset_metric_names</span>
            <span class="p">]</span>

            <span class="n">surrogate</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">=</span><span class="n">subset_datasets</span><span class="p">,</span>
                <span class="n">metric_names</span><span class="o">=</span><span class="n">subset_metric_names</span><span class="p">,</span>
                <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
                <span class="n">candidate_metadata</span><span class="o">=</span><span class="n">candidate_metadata</span><span class="p">,</span>
                <span class="n">state_dict</span><span class="o">=</span><span class="n">state_dict</span><span class="p">,</span>
                <span class="n">refit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refit_on_update</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BoTorchModel.predict"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.predict">[docs]</a>    <span class="nd">@single_surrogate_only</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Predict if only one Surrogate, Error if there are many"""</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogate</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoTorchModel.predict_from_surrogate"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.predict_from_surrogate">[docs]</a>    <span class="k">def</span> <span class="nf">predict_from_surrogate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">surrogate_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Predict from the Surrogate with the given label."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="p">[</span><span class="n">surrogate_label</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoTorchModel.gen"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.gen">[docs]</a>    <span class="nd">@copy_doc</span><span class="p">(</span><span class="n">TorchModel</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">gen</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">search_space_digest</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">,</span>
        <span class="n">torch_opt_config</span><span class="p">:</span> <span class="n">TorchOptConfig</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TorchGenResults</span><span class="p">:</span>
        <span class="n">acq_options</span><span class="p">,</span> <span class="n">opt_options</span> <span class="o">=</span> <span class="n">construct_acquisition_and_optimizer_options</span><span class="p">(</span>
            <span class="n">acqf_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition_options</span><span class="p">,</span>
            <span class="n">model_gen_options</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">model_gen_options</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># update bounds / target fidelities</span>
        <span class="n">search_space_digest</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_space_digest</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">search_space_digest</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">target_fidelities</span><span class="o">=</span><span class="n">search_space_digest</span><span class="o">.</span><span class="n">target_fidelities</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="p">)</span>

        <span class="n">acqf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_acquisition</span><span class="p">(</span>
            <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
            <span class="n">torch_opt_config</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="p">,</span>
            <span class="n">acq_options</span><span class="o">=</span><span class="n">acq_options</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">botorch_rounding_func</span> <span class="o">=</span> <span class="n">get_rounding_func</span><span class="p">(</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">rounding_func</span><span class="p">)</span>
        <span class="n">candidates</span><span class="p">,</span> <span class="n">expected_acquisition_value</span> <span class="o">=</span> <span class="n">acqf</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
            <span class="n">inequality_constraints</span><span class="o">=</span><span class="n">_to_inequality_constraints</span><span class="p">(</span>
                <span class="n">linear_constraints</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">linear_constraints</span>
            <span class="p">),</span>
            <span class="n">fixed_features</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">fixed_features</span><span class="p">,</span>
            <span class="n">rounding_func</span><span class="o">=</span><span class="n">botorch_rounding_func</span><span class="p">,</span>
            <span class="n">optimizer_options</span><span class="o">=</span><span class="n">checked_cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">opt_options</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">gen_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gen_metadata_from_acqf</span><span class="p">(</span>
            <span class="n">acqf</span><span class="o">=</span><span class="n">acqf</span><span class="p">,</span>
            <span class="n">torch_opt_config</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="p">,</span>
            <span class="n">expected_acquisition_value</span><span class="o">=</span><span class="n">expected_acquisition_value</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">TorchGenResults</span><span class="p">(</span>
            <span class="n">points</span><span class="o">=</span><span class="n">candidates</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">gen_metadata</span><span class="o">=</span><span class="n">gen_metadata</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_gen_metadata_from_acqf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">acqf</span><span class="p">:</span> <span class="n">Acquisition</span><span class="p">,</span>
        <span class="n">torch_opt_config</span><span class="p">:</span> <span class="n">TorchOptConfig</span><span class="p">,</span>
        <span class="n">expected_acquisition_value</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TGenMetadata</span><span class="p">:</span>
        <span class="n">gen_metadata</span><span class="p">:</span> <span class="n">TGenMetadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">Keys</span><span class="o">.</span><span class="n">EXPECTED_ACQF_VAL</span><span class="p">:</span> <span class="n">expected_acquisition_value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">torch_opt_config</span><span class="o">.</span><span class="n">objective_weights</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gen_metadata</span><span class="p">[</span><span class="s2">"objective_thresholds"</span><span class="p">]</span> <span class="o">=</span> <span class="n">acqf</span><span class="o">.</span><span class="n">objective_thresholds</span>
            <span class="n">gen_metadata</span><span class="p">[</span><span class="s2">"objective_weights"</span><span class="p">]</span> <span class="o">=</span> <span class="n">acqf</span><span class="o">.</span><span class="n">objective_weights</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">acqf</span><span class="o">.</span><span class="n">acqf</span><span class="p">,</span> <span class="s2">"outcome_model"</span><span class="p">):</span>
            <span class="n">outcome_model</span> <span class="o">=</span> <span class="n">acqf</span><span class="o">.</span><span class="n">acqf</span><span class="o">.</span><span class="n">outcome_model</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">outcome_model</span><span class="p">,</span>
                <span class="n">FixedSingleSampleModel</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">gen_metadata</span><span class="p">[</span><span class="s2">"outcome_model_fixed_draw_weights"</span><span class="p">]</span> <span class="o">=</span> <span class="n">outcome_model</span><span class="o">.</span><span class="n">w</span>
        <span class="k">return</span> <span class="n">gen_metadata</span>

<div class="viewcode-block" id="BoTorchModel.best_point"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.best_point">[docs]</a>    <span class="nd">@copy_doc</span><span class="p">(</span><span class="n">TorchModel</span><span class="o">.</span><span class="n">best_point</span><span class="p">)</span>
    <span class="nd">@single_surrogate_only</span>
    <span class="k">def</span> <span class="nf">best_point</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">search_space_digest</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">,</span>
        <span class="n">torch_opt_config</span><span class="p">:</span> <span class="n">TorchOptConfig</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogate</span><span class="o">.</span><span class="n">best_in_sample_point</span><span class="p">(</span>
                <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
                <span class="n">torch_opt_config</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BoTorchModel.evaluate_acquisition_function"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.evaluate_acquisition_function">[docs]</a>    <span class="nd">@copy_doc</span><span class="p">(</span><span class="n">TorchModel</span><span class="o">.</span><span class="n">evaluate_acquisition_function</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">evaluate_acquisition_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">search_space_digest</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">,</span>
        <span class="n">torch_opt_config</span><span class="p">:</span> <span class="n">TorchOptConfig</span><span class="p">,</span>
        <span class="n">acq_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="n">acqf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_acquisition</span><span class="p">(</span>
            <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
            <span class="n">torch_opt_config</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="p">,</span>
            <span class="n">acq_options</span><span class="o">=</span><span class="n">acq_options</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">acqf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoTorchModel.cross_validate"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.cross_validate">[docs]</a>    <span class="nd">@copy_doc</span><span class="p">(</span><span class="n">TorchModel</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cross_validate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SupervisedDataset</span><span class="p">],</span>
        <span class="n">metric_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">X_test</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">search_space_digest</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
        <span class="c1"># Will fail if metric_names exist across multiple models</span>
        <span class="n">surrogate_labels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span>
                <span class="n">label</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_specs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">metric</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">outcomes</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_names</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="k">else</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surrogate_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserInputError</span><span class="p">(</span>
                <span class="s2">"May not cross validate multiple Surrogates at once. Please input "</span>
                <span class="sa">f</span><span class="s2">"metric_names that exist on one Surrogate. </span><span class="si">{</span><span class="n">metric_names</span><span class="si">}</span><span class="s2"> spans "</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">surrogate_labels</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
        <span class="n">surrogate_label</span> <span class="o">=</span> <span class="n">surrogate_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">current_surrogates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span>
        <span class="c1"># If we should be refitting but not warm-starting the refit, set</span>
        <span class="c1"># `state_dicts` to None to avoid loading it.</span>
        <span class="n">state_dicts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refit_on_cv</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_start_refit</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">label</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">surrogate</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surrogate</span> <span class="ow">in</span> <span class="n">current_surrogates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Temporarily set `_surrogates` to cloned surrogates to set</span>
        <span class="c1"># the training data on cloned surrogates to train set and</span>
        <span class="c1"># use it to predict the test point.</span>
        <span class="n">surrogate_clones</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">surrogate</span><span class="o">.</span><span class="n">clone_reset</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surrogate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span> <span class="o">=</span> <span class="n">surrogate_clones</span>
        <span class="c1"># Remove the robust_digest since we do not want to use perturbations here.</span>
        <span class="n">search_space_digest</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">search_space_digest</span><span class="p">,</span>
            <span class="n">robust_digest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
                <span class="n">metric_names</span><span class="o">=</span><span class="n">metric_names</span><span class="p">,</span>
                <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
                <span class="n">state_dicts</span><span class="o">=</span><span class="n">state_dicts</span><span class="p">,</span>
                <span class="n">refit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refit_on_cv</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">X_test_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_from_surrogate</span><span class="p">(</span>
                <span class="n">surrogate_label</span><span class="o">=</span><span class="n">surrogate_label</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_test</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Reset the surrogates back to this model's surrogate, make</span>
            <span class="c1"># sure the cloned surrogate doesn't stay around if fit or</span>
            <span class="c1"># predict fail.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_surrogates</span> <span class="o">=</span> <span class="n">current_surrogates</span>
        <span class="k">return</span> <span class="n">X_test_prediction</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Torch data type of the tensors in the training data used in the model,</span>
<span class="sd">        of which this ``Acquisition`` is a subcomponent.</span>
<span class="sd">        """</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">surrogate</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surrogate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">dtypes_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">dtypes_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">dtypes_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtypes_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Expected all Surrogates to have same dtype, found </span><span class="si">{</span><span class="n">dtypes</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">dtypes_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Torch device type of the tensors in the training data used in the model,</span>
<span class="sd">        of which this ``Acquisition`` is a subcomponent.</span>
<span class="sd">        """</span>

        <span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">surrogate</span><span class="o">.</span><span class="n">device</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">surrogate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">devices_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">devices</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">devices_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">devices_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Expected all Surrogates to have same device, found </span><span class="si">{</span><span class="n">devices</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">devices_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_instantiate_acquisition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">search_space_digest</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">,</span>
        <span class="n">torch_opt_config</span><span class="p">:</span> <span class="n">TorchOptConfig</span><span class="p">,</span>
        <span class="n">acq_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Acquisition</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Set a BoTorch acquisition function class for this model if needed and</span>
<span class="sd">        instantiate it.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A BoTorch ``AcquisitionFunction`` instance.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_botorch_acqf_class</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch_opt_config</span><span class="o">.</span><span class="n">risk_measure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># TODO[T131759261]: Implement selection of acqf for robust opt.</span>
                <span class="c1"># This will depend on the properties of the robust search space and</span>
                <span class="c1"># the risk measure being used.</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_botorch_acqf_class</span> <span class="o">=</span> <span class="n">choose_botorch_acqf_class</span><span class="p">(</span>
                <span class="n">pending_observations</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">pending_observations</span><span class="p">,</span>
                <span class="n">outcome_constraints</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">outcome_constraints</span><span class="p">,</span>
                <span class="n">linear_constraints</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">linear_constraints</span><span class="p">,</span>
                <span class="n">fixed_features</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">fixed_features</span><span class="p">,</span>
                <span class="n">objective_thresholds</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">objective_thresholds</span><span class="p">,</span>
                <span class="n">objective_weights</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="o">.</span><span class="n">objective_weights</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_class</span><span class="p">(</span>
            <span class="n">surrogates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="p">,</span>
            <span class="n">botorch_acqf_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">botorch_acqf_class</span><span class="p">,</span>
            <span class="n">search_space_digest</span><span class="o">=</span><span class="n">search_space_digest</span><span class="p">,</span>
            <span class="n">torch_opt_config</span><span class="o">=</span><span class="n">torch_opt_config</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">acq_options</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BoTorchModel.feature_importances"><a class="viewcode-back" href="../../../../../models.html#ax.models.torch.botorch_modular.model.BoTorchModel.feature_importances">[docs]</a>    <span class="k">def</span> <span class="nf">feature_importances</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute feature importances from the model.</span>

<span class="sd">        Caveat: This assumes the following:</span>
<span class="sd">            1. There is a single surrogate model (potentially a `ModelList`).</span>
<span class="sd">            2. We can get model lengthscales from `covar_module.base_kernel.lengthscale`</span>

<span class="sd">        Returns:</span>
<span class="sd">            The feature importances as a numpy array of size len(metrics) x 1 x dim</span>
<span class="sd">            where each row sums to 1.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Only support a single surrogate model for now"</span><span class="p">)</span>
        <span class="n">surrogate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="p">[</span><span class="n">Keys</span><span class="o">.</span><span class="n">ONLY_SURROGATE</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">get_feature_importances_from_botorch_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">surrogate</span><span class="o">.</span><span class="n">model</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">search_space_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SearchSpaceDigest</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_digest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">"`search_space_digest` is not initialized. Must `fit` the model first."</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_digest</span>

    <span class="nd">@search_space_digest</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">search_space_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">SearchSpaceDigest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Setting search_space_digest manually is disallowed."</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outcomes_by_surrogate_label</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Retuns a dictionary mapping from surrogate label to a list of outcomes."""</span>
        <span class="n">outcomes_by_surrogate_label</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surrogates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">outcomes_by_surrogate_label</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">outcomes</span>
        <span class="k">return</span> <span class="n">outcomes_by_surrogate_label</span></div>
</pre></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">Ax</a></h1>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ax.html">ax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../benchmark.html">ax.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../core.html">ax.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../exceptions.html">ax.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../metrics.html">ax.metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modelbridge.html">ax.modelbridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../models.html">ax.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../plot.html">ax.plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../runners.html">ax.runners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../service.html">ax.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../storage.html">ax.storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../telemetry.html">ax.telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../utils.html">ax.utils</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="../../../../../index.html">Documentation overview</a><ul>
<li><a href="../../../../index.html">Module code</a><ul>
</ul></li>
</ul></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" autocapitalize="off" autocomplete="off" autocorrect="off" name="q" spellcheck="false" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
</div>
</div>
<div class="clearer"></div>
</div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><div class="footerSection"><h5>Legal</h5><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noreferrer noopener">Privacy</a><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noreferrer noopener">Terms</a></div></section><a href="https://code.facebook.com/projects/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/versions/0.3.4/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2023 Meta Platforms, Inc.</section></footer></div></body></html>