<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Models · Ax</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Using models in Ax"/><meta name="docsearch:version" content="0.1.17"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Models · Ax"/><meta property="og:type" content="website"/><meta property="og:url" content="https://ax.dev//versions/0.1.17/index.html"/><meta property="og:description" content="## Using models in Ax"/><meta property="og:image" content="https://ax.dev//versions/0.1.17/img/ax.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://ax.dev//versions/0.1.17/img/ax.svg"/><link rel="shortcut icon" href="/versions/0.1.17/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-139570076-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script><script type="text/javascript" src="/versions/0.1.17/js/plotUtils.js"></script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/versions/0.1.17/js/mathjax.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/versions/0.1.17/js/scrollSpy.js"></script><link rel="stylesheet" href="/versions/0.1.17/css/main.css"/><script src="/versions/0.1.17/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/versions/0.1.17/"><img class="logo" src="/versions/0.1.17/img/ax_lockup_white.svg" alt="Ax"/><h2 class="headerTitleWithLogo">Ax</h2></a><a href="/versions/0.1.17/versions.html"><h3>0.1.17</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/versions/0.1.17/docs/why-ax.html" target="_self">Docs</a></li><li class=""><a href="/versions/0.1.17/tutorials/" target="_self">Tutorials</a></li><li class=""><a href="/versions/0.1.17/api/" target="_self">API</a></li><li class=""><a href="https://github.com/facebook/Ax" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Components</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/why-ax.html">Why Ax?</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/installation.html">Installation</a></li><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/api.html">APIs</a></li><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/glossary.html">Glossary</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Algorithms</h3><ul class=""><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/bayesopt.html">Bayesian Optimization</a></li><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/banditopt.html">Bandit Optimization</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Components</h3><ul class=""><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/core.html">Core</a></li><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/trial-evaluation.html">Trial Evaluation</a></li><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/data.html">Data</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/versions/0.1.17/docs/models.html">Models</a></li><li class="navListItem"><a class="navItem" href="/versions/0.1.17/docs/storage.html">Storage</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Models</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="using-models-in-ax"></a><a href="#using-models-in-ax" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using models in Ax</h2>
<p>In the optimization algorithms implemented by Ax, models predict the outcomes of metrics within an experiment evaluated at a parameterization, and are used to predict metrics or suggest new parameterizations for trials. Models in Ax are created using factory functions from the <a href="../api/modelbridge.html#module-ax.modelbridge.factory"><code>ax.modelbridge.factory</code></a>. All of these models share a common API with <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict()</code></a> to make predictions at new points and <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.gen"><code>gen()</code></a> to generate new candidates to be tested. There are a variety of models available in the factory; here we describe the usage patterns for the primary model types and show how the various Ax utilities can be used with models.</p>
<h4><a class="anchor" aria-hidden="true" id="sobol-sequence"></a><a href="#sobol-sequence" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sobol sequence</h4>
<p>The <a href="../api/modelbridge.html#ax.modelbridge.factory.get_sobol"><code>get_sobol</code></a> function is used to construct a model that produces a quasirandom Sobol sequence when<a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.gen"><code>gen</code></a> is called. This code generates a scrambled Sobol sequence of 10 points:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.modelbridge.factory <span class="hljs-keyword">import</span> get_sobol

m = get_sobol(search_space)
gr = m.gen(n=<span class="hljs-number">10</span>)
</code></pre>
<p>The output of <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.gen"><code>gen</code></a> is a <a href="../api/core.html#ax.core.generator_run.GeneratorRun"><code>GeneratorRun</code></a> object that contains the generated points, along with metadata about the generation process. The generated arms can be accessed at <a href="../api/core.html#ax.core.generator_run.GeneratorRun.arms"><code>GeneratorRun.arms</code></a>.</p>
<p>Additional arguments can be passed to <a href="../api/modelbridge.html#ax.modelbridge.factory.get_sobol"><code>get_sobol</code></a> such as <code>scramble=False</code> to disable scrambling, and <code>seed</code> to set a seed (see <a href="../api/models.html#ax.models.random.sobol.SobolGenerator">model API</a>).</p>
<p>Sobol sequences are typically used to select initialization points, and this model does not implement <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict</code></a>. It can be used on search spaces with any combination of discrete and continuous parameters.</p>
<h4><a class="anchor" aria-hidden="true" id="gaussian-process-with-ei"></a><a href="#gaussian-process-with-ei" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Gaussian Process with EI</h4>
<p>Gaussian Processes (GPs) are used for <a href="/versions/0.1.17/docs/bayesopt.html">Bayesian Optimization</a> in Ax, the <a href="../api/modelbridge.html#ax.modelbridge.factory.get_gpei"><code>get_GPEI</code></a> function constructs a model that fits a GP to the data, and uses the EI acquisition function to generate new points on calls to <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.gen"><code>gen</code></a>. This code fits a GP and generates a batch of 5 points which maximizes EI:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.modelbridge.factory <span class="hljs-keyword">import</span> get_GPEI

m = get_GPEI(experiment, data)
gr = m.gen(n=<span class="hljs-number">5</span>, optimization_config=optimization_config)
</code></pre>
<p>In contrast to <a href="../api/modelbridge.html#ax.modelbridge.factory.get_sobol"><code>get_sobol</code></a>, the GP requires data and is able to make predictions. We make predictions by constructing a list of <a href="../api/core.html#ax.core.observation.ObservationFeatures"><code>ObservationFeatures</code></a> objects with the parameter values for which we want predictions:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.core.observation <span class="hljs-keyword">import</span> ObservationFeatures

obs_feats = [
    ObservationFeatures(parameters={<span class="hljs-string">'x1'</span>: <span class="hljs-number">3.14</span>, <span class="hljs-string">'x2'</span>: <span class="hljs-number">2.72</span>}),
    ObservationFeatures(parameters={<span class="hljs-string">'x1'</span>: <span class="hljs-number">1.41</span>, <span class="hljs-string">'x2'</span>: <span class="hljs-number">1.62</span>}),
]
f, cov = m.predict(obs_feats)
</code></pre>
<p>The output of <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict</code></a> is the mean estimate of each metric and the covariance (across metrics) for each point.</p>
<p>All Ax models that implement <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict</code></a> can be used with the built-in plotting utilities, which can produce plots of model predictions on 1-d or 2-d slices of the parameter space:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.plot.slice <span class="hljs-keyword">import</span> plot_slice
<span class="hljs-keyword">from</span> ax.utils.notebook.plotting <span class="hljs-keyword">import</span> render, init_notebook_plotting

init_notebook_plotting()
render(plot_slice(
    model=m,
    param_name=<span class="hljs-string">'x1'</span>,  <span class="hljs-comment"># slice on values of 'x1'</span>
    metric_name=<span class="hljs-string">'metric_a'</span>,
    slice_values={<span class="hljs-string">'x2'</span>: <span class="hljs-number">7.5</span>},  <span class="hljs-comment"># Fix at this value for the slice</span>
))
</code></pre>
<div id="slice" style="width: 100%;"></div>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.plot.contour <span class="hljs-keyword">import</span> plot_contour

render(plot_contour(
    model=m,
    param_x=<span class="hljs-string">'x1'</span>,
    param_y=<span class="hljs-string">'x2'</span>,
    metric_name=<span class="hljs-string">'metric_a'</span>,
))
</code></pre>
<div id="contour" style="width: 100%;"></div>
<p>Ax also includes utilities for cross validation to assess model predictive performance. Leave-one-out cross validation can be performed as follows:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.modelbridge.cross_validation <span class="hljs-keyword">import</span> cross_validate, compute_diagnostics

cv = cross_validate(model)
diagnostics = compute_diagnostics(cv)
</code></pre>
<p><a href="../api/modelbridge.html#ax.modelbridge.cross_validation.compute_diagnostics"><code>compute_diagnostics</code></a> computes a collection of diagnostics of model predictions, such as the correlation between predictions and actual values, and the p-value for a Fisher test of the model's ability to distinguish high values from low. A very useful tool for assessing model performance is to plot the cross validated predictions against the actual observed values:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.plot.diagnostic <span class="hljs-keyword">import</span> interact_cross_validation

render(interact_cross_validation(cv))
</code></pre>
<div id="cv" style="width: 100%;"></div>
<p>If the model fits the data well, the values will lie along the diagonal. Poor GP fits tend to produce cross validation plots that are flat with high predictive uncertainty - such fits are unlikely to produce good candidates in <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.gen"><code>gen</code></a>.</p>
<p>By default, this model will apply a number of transformations to the feature space, such as one-hot encoding of <a href="../api/core.html#ax.core.parameter.ChoiceParameter"><code>ChoiceParameters</code></a> and log transformation of <a href="../api/core.html#ax.core.parameter.RangeParameter"><code>RangeParameters</code></a> which have <code>log_scale</code> set to <code>True</code>. Transforms are also applied to the observed outcomes, such as standardizing the data for each metric. See <a href="/versions/0.1.17/docs/models.html#Transforms">the section below on Transforms</a> for a description of the default transforms, and how new transforms can be implemented and included.</p>
<p>GPs typically does a good job of modeling continuous parameters (<a href="../api/core.html#ax.core.parameter.RangeParameter"><code>RangeParameters</code></a>). If the search space contains <a href="../api/core.html#ax.core.parameter.ChoiceParameter"><code>ChoiceParameters</code></a>, they will be one-hot-encoded and the GP fit in the encoded space. A search space with a mix of continuous parameters and <a href="../api/core.html#ax.core.parameter.ChoiceParameter"><code>ChoiceParameters</code></a> that take a small number of values can be modeled effectively with a GP, but model performance may be poor if there are more than about 20 parameters after one-hot encoding. Cross validation is an effective tool for determining usefulness of the GP on a particular problem.</p>
<p>In discrete spaces where the GP does not predict well, a multi-armed bandit approach is often preferred, and we now discuss the models suitable for that approach.</p>
<h4><a class="anchor" aria-hidden="true" id="empirical-bayes-and-thompson-sampling"></a><a href="#empirical-bayes-and-thompson-sampling" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Empirical Bayes and Thompson sampling</h4>
<p>For <a href="/versions/0.1.17/docs/banditopt.html">Bandit optimization</a>, The <a href="../api/modelbridge.html#ax.modelbridge.factory.get_empirical_bayes_thompson"><code>get_empirical_bayes_thompson</code></a> factory function returns a model that applies <a href="/versions/0.1.17/docs/banditopt.html#empirical-bayes">empirical Bayes shrinkage</a> to a discrete set of arms, and then uses Thompson sampling to construct a policy with the weight that should be allocated to each arms. Here we apply empirical Bayes to the data and use Thompson sampling to generate a policy that is truncated at <code>n=10</code> arms:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.modelbridge.factory <span class="hljs-keyword">import</span> get_empirical_bayes_thompson

m = get_empirical_bayes_thompson(experiment, data)
gr = m.gen(n=<span class="hljs-number">10</span>, optimization_config=optimization_config)
</code></pre>
<p>The arms and their corresponding weights can be accessed as <code>gr.arm_weights</code>.</p>
<p>As with the GP, we can use <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict</code></a> to evaluate the model at points of our choosing. However, because this is a purely in-sample model, those points should correspond to arms that were in the data. The model prediction will return the estimate at that point after applying the empirical Bayes shrinkage:</p>
<pre><code class="hljs css language-Python">f, cov = m.predict([ObservationFeatures(parameters={<span class="hljs-string">'x1'</span>: <span class="hljs-number">3.14</span>, <span class="hljs-string">'x2'</span>: <span class="hljs-number">2.72</span>})])
</code></pre>
<p>We can generate a plot that shows the predictions for each arm with the shrinkage using <a href="../api/plot.html#ax.plot.scatter.plot_fitted"><code>plot_fitted</code></a>, which shows model predictions on all in-sample arms:</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.plot.scatter <span class="hljs-keyword">import</span> plot_fitted

render(plot_fitted(m, metric=<span class="hljs-string">"metric_a"</span>, rel=<span class="hljs-literal">False</span>))
</code></pre>
<div id="fitted" style="width: 100%;"></div>
<h4><a class="anchor" aria-hidden="true" id="factorial-designs"></a><a href="#factorial-designs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Factorial designs</h4>
<p>The factory function <a href="../api/modelbridge.html#ax.modelbridge.factory.get_factorial"><code>get_factorial</code></a> can be used to construct a factorial design on a set of <a href="../api/core.html#ax.core.parameter.ChoiceParameter"><code>ChoiceParameters</code></a>.</p>
<pre><code class="hljs css language-Python"><span class="hljs-keyword">from</span> ax.modelbridge.factory <span class="hljs-keyword">import</span> get_factorial

m = get_factorial(search_space)
gr = m.gen(n=<span class="hljs-number">10</span>)
</code></pre>
<p>Like the Sobol sequence, the factorial model is only used to generate points and does not implement <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict</code></a>.</p>
<h2><a class="anchor" aria-hidden="true" id="deeper-dive-organization-of-the-modeling-stack"></a><a href="#deeper-dive-organization-of-the-modeling-stack" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deeper dive: organization of the modeling stack</h2>
<p>Ax uses a bridge design to provide a unified interface for models, while still allowing for modularity in how different types of models are implemented. The modeling stack consists of two layers: the <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> and the Model.</p>
<p>The <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> is the object that is directly used in Ax: model factories return <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> objects, and plotting and cross validation tools operate on a <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a>. The <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> defines a unified API for all of the models used in Ax via methods like <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict</code></a> and <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.gen"><code>gen</code></a>. Internally, it is responsible for transforming Ax objects like <a href="../api/core.html#ax.core.arm.Arm"><code>Arm</code></a> and <a href="../api/core.html#ax.core.data.Data"><code>Data</code></a> into objects which are then consumed downstream by a Model.</p>
<p>Model objects are only used in Ax via a <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a>. Each Model object defines an API which does not use Ax objects, allowing for modularity of different model types and making it easy to implement new models. For example, the TorchModel defines an API for a model that operates on torch tensors. There is a 1-to-1 link between <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> objects and Model objects. For instance, the TorchModelBridge takes in Ax objects, converts them to torch tensors, and sends them along to the TorchModel. Similar pairings exist for all of the different model types:</p>
<table>
<thead>
<tr><th>ModelBridge</th><th>Model</th><th>Example implementation</th></tr>
</thead>
<tbody>
<tr><td><a href="../api/modelbridge.html#module-ax.modelbridge.torch"><code>TorchModelBridge</code></a></td><td><a href="../api/models.html#ax.models.torch_base.TorchModel"><code>TorchModel</code></a></td><td><a href="../api/models.html#ax.models.torch.botorch.BotorchModel"><code>BotorchModel</code></a></td></tr>
<tr><td><a href="../api/modelbridge.html#module-ax.modelbridge.numpy"><code>NumpyModelBridge</code></a></td><td><a href="../api/models.html#ax.models.numpy_base.NumpyModel"><code>NumpyModel</code></a></td><td><a href="../api/models.html#ax.models.numpy.randomforest.RandomForest"><code>RandomForest</code></a></td></tr>
<tr><td><a href="../api/modelbridge.html#module-ax.modelbridge.discrete"><code>DiscreteModelBridge</code></a></td><td><a href="../api/models.html#ax.models.discrete_base.DiscreteModel"><code>DiscreteModel</code></a></td><td><a href="../api/models.html#ax.models.discrete.thompson.ThompsonSampler"><code>ThompsonSampler</code></a></td></tr>
<tr><td><a href="../api/modelbridge.html#module-ax.modelbridge.random"><code>RandomModelBridge</code></a></td><td><a href="../api/models.html#ax.models.random.base.RandomModel"><code>RandomModel</code></a></td><td><a href="../api/models.html#ax.models.random.sobol.SobolGenerator"><code>SobolGenerator</code></a></td></tr>
</tbody>
</table>
<p>This structure allows for different models like the GP in BotorchModel and the Random Forest in RandomForest to share an interface and use common plotting tools at the level of the ModelBridge, while each is implemented using its own torch or numpy structures.</p>
<p>The primary role of the <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> is to act as a transformation layer. This includes transformations to the data, search space, and optimization config such as standardization and log transforms, as well as the final transform from Ax objects into the objects consumed by the Model. We now describe how transforms are implemented and used in the ModelBridge.</p>
<h2><a class="anchor" aria-hidden="true" id="transforms"></a><a href="#transforms" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Transforms</h2>
<p>The transformations in the <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> are done by chaining together a set of individual Transform objects. For continuous space models obtained via factory functions (<a href="/api/data.html#.data.users.adamobeng.fbsource.fbcode.ax.ax.modelbridge.factory.get_sobol"><code>get_sobol</code></a> and <a href="/api/data.html#.data.users.adamobeng.fbsource.fbcode.ax.ax.modelbridge.factory.get_GPEI"><code>get_GPEI</code></a>), the following transforms will be applied by default, in this sequence:</p>
<ul>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.remove_fixed.RemoveFixed"><code>RemoveFixed</code></a>: Remove <a href="../api/core.html#ax.core.parameter.FixedParameter"><code>FixedParameters</code></a> from the search space.</li>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.ordered_choice_encode.OrderedChoiceEncode"><code>OrderedChoiceEncode</code></a>: <a href="../api/core.html#ax.core.parameter.ChoiceParameter"><code>ChoiceParameters</code></a> with <code>is_ordered</code> set to <code>True</code> are encoded as a sequence of integers.</li>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.one_hot.OneHot"><code>OneHot</code></a>: <a href="../api/core.html#ax.core.parameter.ChoiceParameter"><code>ChoiceParameters</code></a> with <code>is_ordered</code> set to <code>False</code> are one-hot encoded.</li>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.int_to_float.IntToFloat"><code>IntToFloat</code></a>: Integer-valued <a href="../api/core.html#ax.core.parameter.RangeParameter"><code>RangeParameters</code></a> are converted to have float values.</li>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.log.Log"><code>Log</code></a>: <a href="../api/core.html#ax.core.parameter.RangeParameter"><code>RangeParameters</code></a> with <code>log_scale</code> set to <code>True</code> are log transformed.</li>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.unit_x.UnitX"><code>UnitX</code></a>: All float <a href="../api/core.html#ax.core.parameter.RangeParameter"><code>RangeParameters</code></a> are mapped to <code>[0, 1]</code>.</li>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.derelativize.Derelativize"><code>Derelativize</code></a>: Constraints relative to status quo are converted to constraints on raw values.</li>
<li><a href="../api/modelbridge.html#ax.modelbridge.transforms.standardize_y.StandardizeY"><code>StandardizeY</code></a>: The Y values for each metric are standardized (subtract mean, divide by standard deviation).</li>
</ul>
<p>Each transform defines both a forward and backwards transform. Arm parameters are passed through the forward transform before being sent along to the Model. The Model works entirely in the transformed space, and when new candidates are generated, they are passed through all of the backwards transforms so the <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> returns points in the original space.</p>
<p>New transforms can be implemented by creating a subclass of <a href="../api/modelbridge.html#ax.modelbridge.transforms.base.Transform"><code>Transform</code></a>, which defines the interface for all transforms. There are separate methods for transforming the search space, optimization config, observation features, and observation data. Transforms that operate on only some aspects of the problem do not need to implement all methods, for instance, <a href="../api/modelbridge.html#ax.modelbridge.transforms.log.Log"><code>Log</code></a> implements only <a href="../api/modelbridge.html#ax.modelbridge.transforms.log.Log.transform_observation_features"><code>transform_observation_features</code></a> (to log transform the parameters), <a href="../api/modelbridge.html#ax.modelbridge.transforms.log.Log.transform_search_space"><code>transform_search_space</code></a> (to log transform the search space bounds), and <a href="../api/modelbridge.html#ax.modelbridge.transforms.log.Log.untransform_observation_features"><code>untransform_observation_features</code></a> (to apply the inverse transform).</p>
<p>The (ordered) list of transforms to apply is an input to the ModelBridge, and so can easily be altered to add new transforms. It is important that transforms be applied in the right order. For instance, the <code>StandardizeY</code> and <code>Winsorize</code> transforms both transform the observed metric values. Applying them in the order <code>[StandardizeY, Winsorize]</code> could produce very different results than <code>[Winsorize, StandardizeY]</code>. In the former case, outliers would have already been included in the standardization (a procedure sensitive to outliers), and so the second approach that winsorizes first is preferred.</p>
<p>See <a href="../api/modelbridge.html#transforms">the API reference</a> for the full collection of implemented transforms.</p>
<h2><a class="anchor" aria-hidden="true" id="implementing-new-models"></a><a href="#implementing-new-models" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implementing new models</h2>
<p>The structure of the modeling stack makes it easy to implement new models and use them inside Ax. There are two ways this might be done.</p>
<h3><a class="anchor" aria-hidden="true" id="using-an-existing-model-interface"></a><a href="#using-an-existing-model-interface" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using an existing Model interface</h3>
<p>The easiest way to implement a new model is if it can be adapted to the one of the existing Model interfaces: (<a href="api/models.html#ax.models.torch_base.TorchModel"><code>TorchModel</code></a>, <a href="../api/models.html#ax.models.numpy_base.NumpyModel"><code>NumpyModel</code></a>, <a href="../api/models.html#ax.models.discrete_base.DiscreteModel"><code>DiscreteModel</code></a>, or <a href="../api/models.html#ax.models.random.base.RandomModel"><code>RandomModel</code></a>). The class definition provides the interface for each of the methods that should be implemented in order for Ax to be able to fully use the new model. Note however that not all methods must need be implemented to use some Ax functionality. For instance, an implementation of <a href="../api/models.html#ax.models.numpy_base.NumpyModel"><code>NumpyModel</code></a> that implements only <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.fit"><code>fit</code></a> and <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.predict"><code>predict</code></a> can be used to fit data and make plots in Ax; however, it will not be able to generate new candidates (requires implementing <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.gen"><code>gen</code></a>) or be used with Ax's cross validation utility (requires implementing <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge.cross_validate"><code>cross_validate</code></a>).</p>
<p>Once the new model has been implemented, it can be used in Ax with the corresponding <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> from the table above. For instance, suppose a new numpy-based model was implemented as a subclass of <a href="../api/models.html#ax.models.numpy_base.NumpyModel"><code>NumpyModel</code></a>. We can use that model in Ax like:</p>
<pre><code class="hljs css language-Python">new_model_obj = NewModel(init_args)  <span class="hljs-comment"># An instance of the new model class</span>
m = NumpyModelBridge(
    experiment=experiment,
    search_space=search_space,
    data=data,
    model=new_model_obj,
    transforms=[UnitX, StandardizeY],  <span class="hljs-comment"># Include the desired set of transforms</span>
)
</code></pre>
<p>The <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> object <code>m</code> can then be used with plotting and cross validation utilities exactly the same way as the built-in models.</p>
<h3><a class="anchor" aria-hidden="true" id="creating-a-new-model-interface"></a><a href="#creating-a-new-model-interface" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a new Model interface</h3>
<p>If none of the existing Model interfaces work are suitable for the new model type, then a new interface will have to be created. This involves two steps: creating the new model interface and creating the new model bridge. The new model bridge must be a subclass of <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> that implements <code>ModelBridge._fit</code>,  <code>ModelBridge._predict</code>, <code>ModelBridge._gen</code>, and  <code>ModelBridge._cross_validate</code>. The implementation of each of these methods will transform the Ax objects in the inputs into objects required for the interface with the new model type. The model bridge will then call out to the new model interface to do the actual modeling work. All of the ModelBridge/Model pairs in the table above provide examples of how this interface can be defined. The main key is that the inputs on the <a href="../api/modelbridge.html#ax.modelbridge.base.ModelBridge"><code>ModelBridge</code></a> side are fixed, but those inputs can then be transformed in whatever way is desired for the downstream Model interface to be that which is most convenient for implementing the model.</p>
<script type="text/javascript" src="assets/slice.js"></script>
<script type="text/javascript" src="assets/contour.js"></script>
<script type="text/javascript" src="assets/cv.js"></script>
<script type="text/javascript" src="assets/fitted.js"></script>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/versions/0.1.17/docs/data.html"><span class="arrow-prev">← </span><span>Data</span></a><a class="docs-next button" href="/versions/0.1.17/docs/storage.html"><span>Storage</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#using-models-in-ax">Using models in Ax</a></li><li><a href="#deeper-dive-organization-of-the-modeling-stack">Deeper dive: organization of the modeling stack</a></li><li><a href="#transforms">Transforms</a></li><li><a href="#implementing-new-models">Implementing new models</a><ul class="toc-headings"><li><a href="#using-an-existing-model-interface">Using an existing Model interface</a></li><li><a href="#creating-a-new-model-interface">Creating a new Model interface</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><div class="footerSection"><h5>Legal</h5><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noreferrer noopener">Privacy</a><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noreferrer noopener">Terms</a></div></section><a href="https://code.facebook.com/projects/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/versions/0.1.17/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2020 Facebook Inc.</section></footer></div></body></html>